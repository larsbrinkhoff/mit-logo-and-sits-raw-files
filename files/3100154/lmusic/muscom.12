MBINIT:	SKIPE MBUFP	;INITIALIZE STORAGE SPACE FOR MUSIC BUFFER
	JRST COMEX	;BUFFER IS ALREADY INITIATED
MBINI1:	HRRZI C,@WTOP
	ADDI C,MBLGTH+2	;FIRST AND LAST WORD AREN'T USED
	MOVE G,LCORE
	LSH G,12
	SUBI G,1
	CAMGE C,G
	JRST MBINI2
	TLZ F,GCF
	EXPAND WS
	JRST MBINI1
MBINI2:	MOVEI A,MBLGTH+2
	HRRZ B,WTOP
	ADDI B,1
	HRLI B,010700+W
	MOVEM A,@B
	ADDM A,WTOP
	AOS WTOP
	MOVEM B,MBUFP	;MBUFP HOLDS THE BASE OF THE AREA
	JRST COMEX


VOICES:	PUSHJ P,NUMVAL	;SET THE NUMBER OF VOICES
	CAILE E,
	CAILE E,4
	ERROR MBVOC
	MOVEM E,NVOICE
	JRST COMEX

OLDMUS:	MOVEI A,143
	MOVEM A,VOICEC
	SETOM MUSONC
	SETOM TTYONC
	JRST COMEX

NEWMUS:	MOVEI A,143
	MOVEM A,VOICEC
	MOVEI A,141
	MOVEM A,MUSONC
	MOVEI A,142
	MOVEM A,TTYONC
	MOVEI A,143
	MOVEM A,BOTHOC
	JRST COMEX


MBCNT:	MOVE B,MBPOS	;OUTPUT THE CURRENT BUFFER COUNT
	ROT B,6
	ANDI B,77	;GET THE BYTE POSITION
	IDIVI B,6	;CHARACTERS ARE 6 BITS LONG
	HRRZ A,MBPOS
	IMULI A,6	;6 BYTES TO THE WORD
	SUB A, B	;THIS WORKS SINCE BUFFER BEGINS AT WORD #1, NOT 0
	JRST NUMRET

MBNXT:	PUSHJ P,NUMVAL	;MOVE BUFFER TO NEXT POSITION
	JUMPL E,[ERROR MBFOR]
MBNXT1:	MOVE A,E
	IDIVI A,6
	ADDM A,MBPOS
	IMULI A,6
	SUB E,A
	AOJA E, MBNXT3
MBNXT2:	JUMPE E,COMEX	;ARG OF 0 HAS NO EFFECT
	IBP MBPOS
MBNXT3:	HRRZ A,MBPOS
	CAILE A, MBLGTH*2	;ERROR OCCURS WHEN BUFFER IS DOUBLE FILLED
	ERROR MBFULL
	SOJA E,MBNXT2

MBPUT:	PUSHJ P,NUMVAL	;PUT NOTE INTO BUFFER
	CAIL E,
	CAILE E,63.	;ALLOWABLE RANGE FOR NOTES
	ERROR MBNOTE
	HRRZ A,MBPOS
	CAMG A,MBLGTH
	JRST COMEX	;IF BUFFER IS IN PSEUDO SECOND HALF, DO NOTHING
	MOVEI A,@MBUFP
	ADD A,MBPOS
	DPB E,A
	SKIPN MBMAX
	AOS MBMAX	;USED AS FLAG TO INDICATE THERE IS SOMETHING IN THE BUFFER
	JRST COMEX

MBOUT:	PUSH P,[COMEX]
MBOUTX:	MOVE C,BOTHOC	;OUTPUT THE BUFFER TO THE MUSIC BOX
	PUSHJ P,TYOII	;TURN BOTH OFF
	MOVE C,VOICEC
	ADDI C,4
	PUSHJ P,TYOII	;SET NUMBER OF VOICES
	MOVEI D,4
MBOUT1:	MOVEI C,40
	PUSHJ P,TYOII
	SOJG D,MBOUT1	;CLEAR OUT THE VOICES
	MOVE C,VOICEC
	ADD C,NVOICE
	PUSHJ P,TYOII
	MOVEI C,40
	PUSHJ P,TYOII
	MOVE C,MUSONC
	PUSHJ P,TYOII
	HRRZ D,MBPOS
	CAMLE D,MBMAX
	MOVEM D,MBMAX	;IF ERROR OCCURED, MAKE MAX TAKE ACCOUNT OF CURRENT POSITION
	HRLZI B,604	;BYTE POINTER INDEXED ON D TO BE INCREMENTED
MBOUT2:	MOVEI D,@MBUFP
	ILDB C,B
	ADDI C,40
	PUSHJ P,TYOII
	HRRZ A,B
	CAMG A,MBMAX
	JRST MBOUT2
	MOVN A,NVOICE
	MOVE C,TTYONC
	JRST TYOII	;TURN TELETYPE BACK ON

MBCLR:	PUSH P,[COMEX]
MBCLRX:	SETZM MBMAX	;CLEAR BUFFER
	SETZM MBPOS
	MOVEI A,MBLGTH
	MOVEI C,
	MOVEI D,@MBUFP
	ADD A,D
	HRLI D,600
MBCLR2:	IDPB C,D
	CAIL A,@D
	JRST MBCLR2
	JRST MBSTRX

MBSTRT:	PUSH P,[COMEX]
MBSTRX:	HRRZ A,MBPOS	;START BACK AT BEGINNING OF BUFFER FOR NEW VOICE
	CAILE A,MBLGTH
	MOVEI A,MBLGTH
	CAMLE A,MBMAX
	MOVEM A,MBMAX	;CHECK FOR NEW MAXIMUM
	HRLZI A,600
	IBP A
	MOVEM A,MBPOS	;SET UP BYTE POINTER
	POPJ P,
