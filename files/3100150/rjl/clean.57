TITLE FILES CLEANSER
;THIS IS A BLECHEROUS PROGRAM!!!

F=0
A=1
B=2
C=3
D=4
T=5
PN=6
N=10
I=11
FN1=12
FN2=13
PT=14
NM=15
P=17

LDPF==1
LDRF==2
ADPF==4
ADRF==10
IDRF==20
CCPF==40

IC==1
OC==2
TI==7
TO==10
FDC==11

LOC 42
	JSR TSINT
LOC 100
TAPE:	BLOCK 200
DISK:	BLOCK 200
PDL:	BLOCK 40
BUF:	BLOCK 200
FLNI:	-1
CHNST:
STFIL:	0
STFNM:	0
	BLOCK 3
INFIL1:	BLOCK 3
INFIL2:	BLOCK 3
OUTFIL:	BLOCK 3
INTT:	0
INTPN:	0
OTAPE:	0
ITAPE:	0
NUM:	1
NUMDR:	1
NUMDP:	1
TAPEIN:	0
DEL:	SIXBIT \   DSK\
	0
	0
	0
CSNAME:	SIXBIT \.LOGO.\
SECNAM:	SIXBIT \DRIBLE\
UFDO:	SIXBIT \  &UT0\
	SIXBIT \.FILE.\
	SIXBIT \(DIR)\

DEFINE TPL A
	MOVEI T,A
	PUSHJ P,CHOUT
TERMIN
DEFINE BTPL A,N
	MOVEI B,N
	MOVEI T,A
	PUSHJ P,CHOUT
	SOJG B,.-2
TERMIN
DEFINE PRINT A\
	MOVEI PN,[ASCIZ \A\]
	PUSHJ P,TYPE
TERMIN
DEFINE ASK B\
	PRINT B
	.IOT TI,A
	PUSHJ P,CRLF
	CAIN A,"Y
TERMIN

TSINT:	0
	0
	EXCH A,TSINT
	CAME A,[400]
	JRST DISINT
	HRRZ A,OUTFIL
	CAIE A,(SIXBIT \DSK\)
	JRST UTFULL
	MOVEM T,INTT
	MOVEM PN,INTPN
	PRINT [SIGH! DISK FULL, WILL TRY AGAIN.
]
	MOVEI A,300.
	.SLEEP A,
	MOVE PN,INTPN
	MOVE T,INTT
DISINT:	MOVE A,TSINT
	.DISMISS TSINT+1
UTFULL:	MOVE A,[OC,,CHNST]
	.RCHST A,
	.CLOSE OC,
	SETZM CHNST+3
	.FDELE CHNST
	.VALUE
	PUSHJ P,GTAPE
	.DISMIS [COPYFL]
GTAPE:	.CLOSE OC,
	MOVE A,OTAPE
	.UDISM A,
	.VALUE
	PRINT [MICRO TAPE FULL, MOUNT A NEW ONE THEN TYPE A SPACE.
]
	.RESET TI,
	.IOT TI,B
	.ASSIGN A,
	.VALUE
	.SUSET [.RUNAM,,B]
	.SUSET [.SSNAM,,B]
	.UINIT A,
	.VALUE
	.SUSET [.SSNAM,,CSNAME]
	.DESIGN A,
	.VALUE
	POPJ P,

GO:	MOVEI P,PDL-1
	MOVEI A,400
	MOVEI B,0
	.SETM2 A,
	.OPEN TI,[SIXBIT \  (TTYTTY   IN\]
	.VALUE
	.OPEN TO,[SIXBIT \  )TTYTTY   OUT\]
	.VALUE
	.SUSET [.SSNAM,,[SIXBIT \.LOGO.\]]
	MOVEI F,0
	ASK LIST DRIBLE FILES?
	TRO F,LDRF
	MOVEI A,0
	TRNE F,LDRF
	PUSHJ P,NUMCOP
	MOVEM A,NUMDR
	ASK ARCHIV DRIBLE FILES?
	TRO F,ADRF
	ASK INITIALIZE DRIBLE FILES?
	TRO F,IDRF
	ASK CLEAN UP CRAP?
	TRO F,CCPF
	PUSHJ P,LIST
	TRZE F,ADRF
	PUSHJ P,ARCDR
	TRZE F,IDRF
	PUSHJ P,INTDR
	TRZE F,CCPF
	PUSHJ P,DECRAP
	.VALUE [ASCIZ \:KILL \]

NUMCOP:	ASK HOW MANY COPIES?
	JFCL
	SUBI A,60
	JUMPL A,NUMCOP
	CAIL A,10.
	JRST NUMCOP
	POPJ P,

LIST:
LISTDR:	MOVE A,[SIXBIT \.LOGO.\]
	MOVEM A,CSNAME
	MOVE A,[SIXBIT \DRIBLE\]
	MOVEM A,SECNAM
	MOVE A,NUMDR
	MOVEM A,NUM
	PUSHJ P, LIST3
LISTDP:	MOVE A,[SIXBIT \LOGO\]
	MOVEM A,CSNAME
	MOVE A,[SIXBIT \DUMP\]
	MOVEM A,SECNAM
	MOVE A,NUMDP
	MOVEM A,NUM
LIST3:	SOSGE NUM
	POPJ P,
	SETOM FLNI
	SETZM INFIL2
	MOVEI A,(SIXBIT \DSK\)
	MOVEM A,OUTFIL
	.OPEN OC,[SIXBIT \  #TPLWALL  PAPER\]
	PUSHJ P,OFAIL
	.SUSET [.SSNAM,,CSNAME]
LSTDR2:	PUSHJ P,FNG
	JRST LSTDR1
	CAME FN2,SECNAM
	JRST LSTDR2
	MOVE PT,[440700,,BUF]
	TPL ^L
	TPL 15
	BTPL 12,27.
	BTPL "*,110.
	TPL 15
	TPL 12
	TPL 12
	BTPL 40,50.
	MOVE NM,FN1
	PUSHJ P,NAMOUT
	MOVE NM,FN2
	PUSHJ P,NAMOUT
	TPL 15
	TPL 12
	TPL 12
	BTPL "*,110.
	TPL 15
	TPL ^L
	BTPL 15,15.
	HRRZS PT
	SUBI PT,BUF+1
	MOVNS PT
	HRLZ PT,PT
	HRRI PT,BUF
	PUSHJ P,PTIOT
	MOVEM FN1,INFIL1+1
	MOVEM FN2,INFIL1+2
	MOVE A,[SIXBIT \  "DSK\]
	MOVEM A,INFIL1
	.OPEN IC,INFIL1
	PUSHJ P,IFAIL
	PUSHJ P,COPY
	JRST LSTDR2
LSTDR1:	.CLOSE OC,
	JRST LIST3
ARCDR:	ASK OUTPUT TAPE=
	JFCL
	SUBI A,60
	JUMPLE A,ARCDR
	CAIL A,5
	JRST ARCDR
	MOVEM A,OTAPE
	.ASSIGN A,
	.VALUE
	.SUSET [.RUNAM,,B]
	.SUSET [.SSNAM,,B]
	.UINIT A,
	.VALUE
	ADD A,[SIXBIT \  'UT0\]
	MOVEM A,OUTFIL
	MOVE A,[SIXBIT \.LOGO.\]
	MOVEM A,CSNAME
	.SUSET [.SSNAM,,CSNAME]
	MOVE A,[SIXBIT \DRIBLE\]
	MOVEM A,INFIL1+2
	MOVEM A,INFIL2+2
	MOVEM A,OUTFIL+2
	MOVEM A,SECNAM
	MOVE A,[SIXBIT \  &DSK\]
	MOVEM A,INFIL2
	PUSHJ P,DSKDIR
ARCDR2:	PUSHJ P,TAPNAM
	JRST ARCDR5
	PUSHJ P,COPYFL
	JRST ARCDR2
ARCDR5:	MOVE A,[SIXBIT \  &DSK\]
	MOVEM A,INFIL1
	SETZM INFIL2+1
	MOVEI A,DISK
ARCDR3:	SKIPN B,(A)
	AOJA A,ARCDR3
	AOSN (A)
	JRST CPOPJ
	SETZM (A)
	MOVEM B,INFIL1+1
	MOVEM B,OUTFIL+1
	PUSHJ P,COPYFL
	JRST ARCDR5

INTDR:	SETOM FLNI
	MOVE A,[SIXBIT \  !DSK\]
	MOVEM A,OUTFIL
	MOVE A,[SIXBIT \DRIBLE\]
	MOVEM A,OUTFIL+2
	MOVE A,[SIXBIT \.LOGO.\]
	MOVEM A,CSNAME
	.SUSET [.SSNAM,,CSNAME]
INTDR2:	PUSHJ P,FNG
	JRST INTDR1
	MOVEM FN1,OUTFIL+1
	CAME FN2,OUTFIL+2
	JRST INTDR2
	.OPEN OC,OUTFIL
	PUSHJ P,OFAIL
	JRST INTDR2
INTDR1:	.CLOSE OC,
	POPJ P,

DECRAP:	SETOM FLNI
	MOVE A,[SIXBIT \.LOGO.\]
	MOVEM A,CSNAME
	.SUSET [.SSNAM,,CSNAME]
DECRP1:	PUSHJ P,FNG
	POPJ P,
	MOVE A,FN2
	SUB A,[SIXBIT \DRIBLE\]
	JUMPLE A,DECRP1
	CAILE A,10
	JRST DECRP1
	MOVEM FN1,DEL+1
	MOVEM FN2,DEL+2
	.FDELE DEL
	.VALUE
	JRST DECRP1
TYPE:	HRLI PN,440700
	ILDB T,PN
	JUMPE T,CPOPJ
	.IOT TO,T
	JRST TYPE+1
CRLF:	.IOT TO,[15]
	.IOT TO,[12]
CPOPJ:	POPJ P,

CLEAN:	PUSH P,A
	PUSH P,B
	PUSH P,C
	PUSH P,T
	MOVEI A,BUF
	MOVE B,[440700,,(A)]
	MOVEI C,15
CLEAN1:	ILDB T,B
	CAIN T,^C
	DPB C,B
	TLNN B,200
	JRST CLEAN1
	POP P,T
	POP P,C
	POP P,B
	POP P,A
	POPJ P,
COPYFL:	.OPEN OC,OUTFIL
	PUSHJ P,OFAIL
	.OPEN IC,INFIL1
	PUSHJ P,IFAIL
	MOVE A,INFIL1+1
	MOVEM A,OUTFIL+1
	PUSHJ P,COPY
	SKIPN INFIL2+1
	POPJ P,
	.OPEN IC,INFIL2
	PUSHJ P,IFAIL
	MOVE A,INFIL2+1
	MOVEM A,OUTFIL+1
	JRST COPY

COPY:	MOVE A,[14060301406]
	MOVEM A,BUF
	MOVE A,[BUF,,BUF+1]
	BLT A,BUF+177
	MOVE A,[-200,,BUF]
	.IOT IC,A
	JUMPL A,FINISH
	MOVE A,[-200,,BUF]
	PUSHJ P,AIOT
	JRST COPY
FINISH:	HLRE B,A
	HRRZS A
	ADD A,[440677,,-1]
	MOVEI C,15
FINSH1:	ILDB T,A
	CAIN T,^C
	DPB C,A
	TLNE A,760000
	JRST FINSH1
	ADDI B,200
	JUMPLE B,CPOPJ
	MOVNS B
	ADDI B,1
	HRLZ B,B
	HRRI B,BUF
	PUSHJ P,BIOT
	POPJ P,

CHOUT:	IDPB T,PT
	CAME PT,[10700,,BUF+177]
	POPJ P,
	MOVE T,[-200,,BUF]
	PUSHJ P,TIOT
	MOVE PT,[440700,,BUF]
	POPJ P,

NAMOUT:	MOVE PN,[440600,,NM]
	MOVEI D,6
NMOUT1:	ILDB T,PN
	ADDI T,40
	PUSHJ P,CHOUT
	SOJG D,NMOUT1
	MOVEI T,40
	JRST CHOUT

TIOT:	PUSHJ P,CLEAN
	.IOT OC,T
	POPJ P,
AIOT:	PUSHJ P,CLEAN
	.IOT OC,A
	POPJ P,
BIOT:	PUSHJ P,CLEAN
	.IOT OC,B
	POPJ P,
PTIOT:	PUSHJ P,CLEAN
	.IOT OC,PT
	POPJ P,

OFAIL:	PUSH P,T
	.STATUS OC,T
	LDB T,[220600,,T]
	CAIN T,5
	JRST DIRFUL
	CAIE T,10
	.VALUE
	MOVEI T,30.
	.SLEEP T,
	POP P,T
	SOS (P)
	SOS (P)
	POPJ P,
DIRFUL:	PUSH P,A
	PUSHJ P,GTAPE
	POP P,A
	POP P,T
	SOS (P)
	SOS (P)
	POPJ P,
IFAIL:	PUSH P,T
	.STATUS IC,T
	LDB T,[220600,,T]
	CAIE T,10
	.VALUE
	MOVEI T,30.
	.SLEEP T,
	POP P,T
	SOS (P)
	SOS (P)
	POPJ P,

TAPNAM:	SKIPE ITAPE
	JRST TAPNM1
TAPNM2:	PRINT INPUT TAPE DRIVE=
	.IOT TI,A
	PUSHJ P,CRLF
	SUBI A,60
	JUMPLE A,TAPNM2
	CAIL A,5
	JRST TAPNM2
	MOVEM A,ITAPE
	DPB A,[300,,UFDO]
	ADD A,[SIXBIT \  &UT0\]
	MOVEM A,INFIL1
TAPNM3:	.OPEN FDC,UFDO
	.VALUE
	MOVE A,[-100,,TAPE]
	.IOT FDC,A
	MOVEI A,TAPE
	MOVEM A,TAPEIN
TAPNM1:	MOVE A,TAPEIN
TAPNM6:	CAIL A,TAPE+56
	JRST TAPNM5
	MOVE B,1(A)
	CAMN B,INFIL1+2
	JRST TAPNM4
	ADDI A,2
	JRST TAPNM6
TAPNM5:	MOVE A,ITAPE
	.CLOSE IC,
	.UDISMT A,
	.VALUE
	ASK ANOTHER TAPE?
	JRST TAPNM3
	POPJ P,
TAPNM4:	MOVE B,(A)
	MOVEM B,INFIL1+1
	ADDI A,2
	MOVEM A,TAPEIN
	MOVEI A,DISK
TAPNM8:	MOVE C,(A)
	CAMN B,C
	JRST TAPNM7
	ADDI A,1
	AOJN C,TAPNM8
	SETZM INFIL2+1
	JRST POPJ1
TAPNM7:	SETZM (A)
	MOVEM C,INFIL2+1
POPJ1:	AOS (P)
	POPJ P,

DSKDIR:	MOVEI PT,DISK
	SETOM FLNI
	.SUSET [.SSNAM,,CSNAME]
DSKDR1:	PUSHJ P,FNG
	JRST DSKDR2
	CAME FN2,SECNAM
	JRST DSKDR1
	MOVEM FN1,(PT)
	AOJA PT,DSKDR1
DSKDR2:	SETOM (PT)
	POPJ P,

FNG:	MOVEI B,1	;READ ONE ENTRY IN FILE DIRECTORY (PUT IN FN1,FN2 AND PACKN)
	AOSE FLNI
	JRST FNG2
FNG8:	.OPEN FDC,[SIXBIT \   DSK.FILE.(DIR)\]	;OPEN FIRST TIME ROUND
	.VALUE
	MOVEI B,2	;FLUSH FIRST TWO LINES
FNG2:	.IOT FDC,A
	CAIN A,^C
	POPJ P,
	CAIE A,12	;SEARCH FOR CR
	JRST FNG2
	SOJG B,FNG2

FNG1:	MOVNI I,1
	CLEARB N,FN1
	CLEARM FN2

FNG3:	.IOT FDC,A
	CAIN A,^C
	POPJ P,
	CAIN A,"*
	JUMPL I,FNG6	;DOESN'T REALLY EXIST
	CAIN A,14
	POPJ P,		;END OF FILE DIRECTORY
	CAIN A,40
	JRST FNG4
	JUMPG I,FNG5	;HAVE FLUSHED PACK, GOBBLE NAMES
	IMULI N,10.
	ADDI N,-"0(A)	;ASSEMBLE PACK NUMBER
	JUMPE I,FNG3
	AOJA I,FNG3

FNG4:	JUMPN I,FNG3
	AOJA I,FNG3	;SPACE AFTER PACK

FNG7:	.IOT FDC,A	; FLUSH SPACES
	.IOT FDC,A
	.IOT FDC,A
	CAIN A,^C
	POPJ P,
FNG5:	MOVEI D,2
FNG5B:	MOVE B,FNG5T-1(D)
	MOVEI C,6
FNG5A:	SUBI A,40	;CONVERT TO SIXBIT
	IDPB A,B
	.IOT FDC,A
	SOJG C,FNG5A
	.IOT FDC,A	;FLUSH SPACE
	SOJG D,FNG5B
	AOS (P)
	POPJ P,

FNG5T:	440600,,FN2	;BYTE-POINTERS TO FILE NAMES
	440600,,FN1


FNG6:	.IOT FDC,A	;FLUSH TO END OF LINE
	CAIN A,14
	POPJ P,
	CAIN A,12
	JRST FNG1
	JRST FNG6

	END GO

LOGO.\]
	MOVEM A,CSNAME
	.SUSET [.SSNAM,,CSNAME]
	MOVE A,[SIXBIT \DRIBLE\]
	MOVEM A,INFIL1+2
	MOVEM A,INFIL2+2
	MOVEM A,OUTFIL+2
	MOVEM A,SECNAM
	MOVE A,[SIXBIT \  &DSK\]
	MOVEM A,INFIL2
	PUSHJ P,DSKDIR
ARCDR2:	PUSHJ P,TAPNAM
	JRST ARCDR5
	PUSHJ P,COPYFL
	JRST ARCDR2
ARCDR5:	MOVE A,[SIXBIT \  &DSK\]
	MOVEM A,INFIL1
	SETZM INFIL2+1
	MOVEI A,DISK
ARCDR3:	SKIPN B,(A)
	AOJA A,ARCDR3
	AOSN (A)
	JRST CPOPJ
	SETZM (A)
	MOVEM B,INFIL1+1
	MOVEM B,OUTFIL+1
	PUSHJ P,COPYFL
	JRST ARCDR5

INTDR:	SETOM FLNI
	MOVE A,[SIXBIT \  !DSK\]
	MOVEM A,OUTFIL
	MOVE A,[SIXBIT \DRIBLE\]
	MOVEM A,OUTFIL+2
	MOVE A,[SIXBIT \.LOGO.\]
	MOVEM A,CSNAME
	.SUSET [.SSNAM,,CSNAME]
INTDR2:	PUSHJ P,FNG
	JRST INTDR1
	MOVEM FN1,OUTFIL+1
	CAME FN2,OUTFIL+2
	JRST INTDR2
	.OPEN OC,OUTFIL
	PUSHJ P,OFAIL
	JRST INTDR2
INTDR1:	.CLOSE OC,
	POPJ P,

DECRAP:	SETOM FLNI
	MOVE A,[SIXBIT \.LOGO.\]
	MOVEM A,CSNAME
	.SUSET [.SSNAM,,CSNAME]
DECRP1:	PUSHJ P,FNG
	POPJ P,
	MOVE A,FN2
	SUB A,[SIXBIT \DRIBLE\]
	JUMPLE A,DECRP1
	CAILE A,10
	JRST DECRP1
	MOVEM FN1,DEL+1
	MOVEM FN2,DEL+2
	.FDELE DEL
	.VALUE
	JRST DECRP1
TYPE:	HRLI PN,440700
	ILDB T,PN
	JUMPE T,CPOPJ
	.IOT TO,T
	JRST TYPE+1
CRLF:	.IOT TO,[15]
	.IOT TO,[12]
CPOPJ:	POPJ P,

CLEAN:	PUSH P,A
	PUSH P,B
	PUSH P,C
	PUSH P,T
	MOVEI A,BUF
	MOVE B,[440700,,(A)]
	MOVEI C,15
CLEAN1:	ILDB T,B
	CAIN T,^C
	DPB C,B
	TLNN B,200
	JRST CLEAN1
	POP P,T
	POP P,C
	POP P,B
	POP P,A
	POPJ P,
COPYFL:	.OPEN OC,OUTFIL
	PUSHJ P,OFAIL
	.OPEN IC,INFIL1
	PUSHJ P,IFAIL
	MOVE A,