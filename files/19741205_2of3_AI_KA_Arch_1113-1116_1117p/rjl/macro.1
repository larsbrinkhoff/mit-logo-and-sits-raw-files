kQXrk @5WTTLE	MACRO	V005A	06-AUG-72

	.SBTTL	TITLE PAGE

	.IDENT	/005A /

	.MACRO	GVNUM		;GEN VERSION NUMBER
	.ASCII	/05A/
	.ENDM

;	COPYRIGHT 1972  DIGITAL EQUIPMENT CORPORATION

R0=	%0
R1=	%1
R2=	%2
R3=	%3
R4=	%4
R5=	%5
SP=	%6
PC=	%7

	.IIF NDF XOVLAY, OVLAY=	0	;DEFAULT TO OVLAY MODE

OVRLVL=	0			;INIT OVERLAY LEVEL

PRGBEG:				;BASE OF PROGRAM


	.GLOBL	PSTBAS,	PSTTOP	;PERM SYMBOL TABLE
	.GLOBL	WRDSYM		;".WORDH"EAULTCE	]̙+̟qV	]CSI1,	.CSI2,	.DELETBWMALL	.$Y	.INIONF,	.OPENWRAD
	.MCALL	.RLqV	]RSTRT,	.STAT,	.TRAP,	.WAIT
	.MCALL	.WRITE

	.MCALL	.CVTDT,	.FLUSH,	.RUN,	.STSTK,	.SYSDV

	u.{-	;SYSTEM VECTOR TABLEӭ'{	2		;TOP OF BUFFERS

	.NLIST	BEX		;DON'T LIST BINARY *ESIONS
	.SBTTL		ASSEMBLY OPTIONS

;THE FOLLOWIN&RO CAUSES 4śBLY OPTIONh*OAQFwPRINTED ON THE LOADER MAPgDAANY I&IATIONS
;(SECOND ARGUMENT(*OABE DEFINEDOTIONS ARE
;SELECTED BY EQUATING THEM TOҟE	.MACRO	LDRMAP	MNE,I&IS
	.IF DF	MNE
	.LIST
	OL	MNE
	.Ni	.IRP	X,<IMPLIES>
X=	0	"]ɝAIMPLIpjINS
	.ENDM
	.ENDC
	.ENDM	LDRMAP


;THE FOLLOWING GSAENABLES FUNCTIOƊ	LDRh	AL11R,	<DOu,`åO,	X45,	XEDPIC>
	LDRMAP	PAL11R,	<XEDLSB,XEDPNC,	X&CY	XLCTTM>
3"RAP	PAL11R,/,ZRR,	XRESKBjRPS,	XCREF>񢆊LDRMAP	DEBĉwDEBUG VERSION
	LDRMAP	DOSV4,XRUN	;DOS V!ϛPATIBLE
	LDRMAP	PDPV45		t"P[11/45 INSTRUCTI	LDRM4ԥAPS		;ENABPTAPS FOR CALLS
3"RAP	OVl;ENABLE OVERLAYS
	LDRMAP4GUF		;SINGLE BUFFERED INPUT
	L	DBLBwTRAN'D INPLDRMAP	YPHASE		;.PHASE/.DEPHAS


;THE̙OWING GROUP DISABLES FUNCTIONS񢆊LDRMAP	XOVLAY		;SUPPRESS OVERLAYS
	LDRMAP	XMACRO,XSML	;ALL GENERATED CODE (MACRO, REPT, ETC.)
	LDRMAP	XSML		;SYSTEM MACROS
	LDRMAP	X45,XFLTG	;PDP-11/45 FEATURES
	LDRMAP	XFLTG,XEDFPT	;FLOATING POINT EVALUATION
	LDRMAP	XEDABS		;ED.ABS
	LDRMAP	XEDAMA		;ED.AMA
	LDRMAP	XEDPIC		;ED.PIC
	LDRMAP	XEDFPT		;ED.FPT
	LDRMAP	XEDLSB		;ED.LSB
	LDRMAP	XEDPNC		;ED.PNC
	LDRMAP	XEDLC		;ED.LC
	LDRMAP	XEDCDR		;CARD READER FORMAT
	LDRMAP	XZERR		;"Z" ERRORS
	LDRMAP	XLCTTM		;NO LPT LISTING FORMAT
	LDRMAP	XLCSEQ		;SEQUENCE NUMBERS
	LDRMAP	XCREF,XRUN	;CREF SUPPRESSION
	LDRMAP	XRUN		;NO .RUN EMT USED
	LDRMAP	XRESKB		;NO RESIDENT KB
;THE FOLLOWING PARAMETERS CAN BE MODIFIED
;AT ASSEMBLY TIME.

	.MACRO	PARAM	MNE,	VALUE	;DEFINE DEFAULT PARAMETERS
	.IIF NDF MNE,	MNE=	VALUE
	.LIST
MNE=	MNE
	.NLIST
	.ENDM

	.IF DF	PAL11R
	.IF NDF	SRCLEN
SRCLEN	=	84.
	.ENDC
	.ENDC

	PARAM	CPL,	80.	;CHARACTERS PER LISTING LINE
	PARAM	LPP,	60.	;LINES PER PAGE
	PARAM	SRCLEN,	132.	;SOURCE STATEMENT LENGTH
	PARAM	BPMB,	20	;BYTES PER MACRO BLOCK
	PARAM	OBJLEN,	42.	;OBJECT BLOCK LENGTH
	PARAM	RLDLEN,	42.	;RLD BLOCK LENGTH
	PARAM	STKSIZ,	100.+290.	;STACK SIZE
	PARAM	SYSUIC,	000401	;SYSTEM UIC (1,1)
	.SBTTL		SECTOR INITIALIZATION

;SECTORS ARE ENTERTROUGH THE MACRO񢝠EENTSEC", SPECIFYING THE SECTOR NAME FOR THE
;ARGUgT]  THE MACRO "XITSEC"ԫRNS TO
;THE DEFAULTéOR, "MAIN".  THE NULL .CSECT IS
;NEVER ]

	.MACRO	ENTSEC	N3bwINIT A SECTION
	.CS	AME
	.ENDM

	.MACRO	XI	;EXIT TO DEFAUSu$ϝ
	.CSECT	MAIN
	.ENDM

	.IF DF	OVLAY	.֋RLAYS MUST BE LOWEST

;OVERLAYS ARE COLLECTED INéORS OVR1 THROUGH
;OVRN, WHERE N (DECIMAL) IS$EANUMBER OF OVERLAYS.CENMOVR=	9.			;NUMBER OF OVERLAYS ALLOWED
XXX=	0			;LOOP COUNTER
	.RADIX	;GENERATE DECIMAL E"ΧIONS
	.REPT	NUMOVR
XXX=	XXX+1			;BUMP COUNT񢄮RP	N,<\XXX>	;FORCE BINARY TO ASCII
	ENTSEC	OԓOVR'N'B:
	.ENDM
	.ENDR

	.RADIX	8		;BACK TO OCTAL

	ENTSEC	OVRSEP		;OVERLAY SEPARATOR
OVRSEP:

	ENTSEC	OVR1
	.LIMIT			;OVERLAY TEST LOCATION
	GVNUM
	.BYTE	0
	.EVEN

	.ENDC

	ENTqaAIN		;DEFAULT SECTOR;MPURE STORAGE IS DIV1"AINTO THREE SECTORS:
; "IMPURE" BEING CLEAREDj HE BEGINNING OF THE
;PROGRAM, "IMPPAS" BEINGERED AT THE BEGINNING
;OF EACH PASS, AND "IMPLIN" BEING CLEARED AT THE
;BEGINNING OF EACH LINE.

	ENTSEC	IMPURE		;IMPURE STORAGE AREA
IMPURE:ŝTSEC	IMPPAS		;CLEARED EACH PASS
IMPPAS:
	ENTSEC	IMPLIN		;CLEARED EAC&IE
IMPLIN:


;ASSED WITH EACH IMPURE 4AIS AN EXECUTION
;SEu'AWHICH DOES THE CLEAR3ND EXECUTES ANY
;OTHER CODE FOUND IN THE SECTOR.  SEE THE .RADIX
;HANDLER FOR AN EXAMPLE OF TPUE OF THESE SECTORS
;TO INITIALIZE VARIABLES.񢆊ENTSEC	XCTPRG		;PROGRAM INITIALIZATION CODE
PG:
	.IIF DF OVLAY,	CALL	OVRBLD	;INIT OVERLAYbÑANISM
	MOV	#IMPURE,Lc$:	CLR	(R0)+		;CLEAR IMPURE AREA
	CMP	#IMPTOP,R0
	BHI	1$

	ENTSEC	PS		;PASS INITIALIZAT3 ODE
XCTPAS:
	MOV	#3hPS,R0
2$:	CLR	(R0)+		;CLEAR IMPURE PART
	CMP	#IMPTOP,R0
	BHI	2$

	SC	XCTLIN		;LINE INITIALIZATION CODE
XCTLIN:
	MOV	#IMPLIN,R0
3$:	CLR	(R0)+
	CMP	#IMPTOP,R0
	BHI	3$

	ENTSEC	DPURE		;D-SPACE, PURE

	ENTSEbfɱED		;MIXED PURE AND IMPURE
;THE MACRO "GENS S USED TO SPECIFY  A COMMAND
;STRING SWITCH iAARGUMENT) AND THE ADӧ OF
;THE ROUTINE TOALLED WHEN ENCOUNTER(eND ARG).

	ENTSEC	SWTSEC		;SWITCH TABLE
SWTBAS:

	.MACRO	GENSWT	MVADR,?LABEL
	ENTSEC	SWTSEC
LABEL:	.ASCIZ	/MNE/
.	=	LABEL+2		;TRIM TO ONE WORD
	.WORD	ADDR
	XITSEC
	.ENDM


;THE MACRO "GENEDT" IS USED TO SPECIFY .ENABL/.DSABL
;ARGUMENTS.  IT TAKES ONE TO THREE ARGUMENTS:

;	1-	MNEMONIC
;	2-	SUBROUTINE TO BE CALLED (OPTIONAL#E;kDɍ[NULL, .DSABLE IS DEFAULT

	ENTSEC	EDTSEC
EDTBAS:

	.MACRO	GENEDT	MNE,SUBR,INIT
	ENTSEC	EDTSEC
ED.'MNE=	1
	.REPT	<.-EDTBAS>/4
ED.'MNE=	ED.'MNE+ED.'MNE
	.ENDR
	.GLOBL	ED.'MNE
	.RAD50	/MNE/
	.IF NB	SUBR
	.WORD	SUBR
	.IFF
	.WORD	CPOPJ
	.ENDC
	XITSEC
	.IIF NB	INIT,	EDINIT=	EDINIT!ED.'MNE
	.ENDM	GENEDT

	.IIF NDF EDINIT,	EDINIT=	0
;THE MACRO "GENCND" IS USED TO SPECIFY CONDITIONAL
;ARGUMENTS.  IT TAKES TWO OR THREE ARGUMENTS:

;	1-	MNEMONIC
;	2-	SUBROUTINE TO BE CALLED
;	3-	IF NON-BLANK, COMPLEMENT CONDITION

	ENTSEC	CNDSEC
CNDBAS:
	.MACRO	GENCND	MNE,SUBR,TOGGLE	;GENERATE CONDITIONAL
	ENTSEC	CNDSEC
	.RAD50	/MNE/
	.IF B	<TOGGLE>
	.WORD	SUBR
	.IFF
	.WORD	SUBR+1
	.ENDC
	XITSEC
	.ENDM



;THE FOLLOWING SECTOR IS USED TO COLLECT BYTE STRINGS
;AND NEEDN'T BE LEFT AT AN EVEN LOCATION

	ENTSEC	TXTBYT



;THE FOLLOWING SECTORS ARE USED TO COLLECT THE
;BASE, TOP, AND ENTRY SIZE OF THE VARIOUS ROLLS.

	ENTSEC	ROLBAS		;ROLL BASE
ROLBAS:
	ENTSEC	ROLTOP		;ROLL TOP
ROLTOP:
	ENTSEC	ROLSIZ		;ENTRY SIZE
ROLSIZ:



	XITSEC			;ALWAYS LEAVE IN DEFAULT SECTOR
	.SBTTL		SYMBOLIC EQUIVALENCES
	.SBTTL			CHARACTERS

TAB=	11
LF=	12
VT=	13
FF=	14
CR=	15
SPACE=	40

CH.IOR=	'!
CH.QTM=	'"
CH.HSH=	'#
CH.DOL=	'$
CH.PCT=	'%
CH.AND=	'&
CH.XCL=	''

CH.LP=	'(
CH.RP=	')
CH.MUL=	'*
CH.ADD=	'+
CH.COM=	',
CH.SUB=	'-
CH.DOT=	'.
CH.DIV=	'/

CH.COL=	':
CH.SMC=	';
CH.LAB=	'<
CH.EQU=	'=
CH.RAB=	'>
CH.QM=	'?

CH.IND=	'@
CH.BSL=	'\
CH.UAR=	'^

LET.A=	'A
LET.B=	'B
LET.C=	'C
LET.D=	'D
LET.E=	'E
LET.F=	'F
LET.G=	'G
LET.O=	'O
LET.Z=	'Z

DIG.0=	'0
DIG.9=	'9
	.SBTTL			OBJECT FILE

RLDT00=	00	; ABSOLUTE DATA
RLDT01=	01	; INTERNAL RELOCATION		TST	#C
RLDT02=	02	; GLOBAL RELOCATION		TST	#G
RLDT03=	03	; INTERNAL DISPLACED RELOCATION	TST ABS
RLDT04=	04	; GLOBAL DISPLACED R'ÃTION	TST	X
RLDT05=	05	; GLOBAL ADDITIVE RELOCATION	TST	#X+6
RLDT06=	06	; GLOBAL ADDITIVE DISPLACED RELOCATION	TST	#X+6
RLDT07=	07	; NEW CSECTTD10=	1]EQUENCE BREAK
S"Tc1=	11	; LIMIT
RLDT15=	15	; SECTOR ADDITIVE RELOCATION	TST	#O
RLDT16=	16	; SECTOR ADDITIVE DIS ËD RELOCATION	TST	#O+6

GSDT00=	00*400		; OBJECT MODULE NAME
GSDT01=	01*400		; PROGRAM SECTION NAME
GSDT02=	02*400		; INTERNAL SYMBOL TABLE
GSDT03=	03*400		; TRANSFER ADDRESS
GSDT04=	04*400		; SYMBOL DECLARATION
GSDT05=	05*400		; LOCA)ŇgAfQĩ06=	06*400"]ERSION IDENTIFICATION

BLKT01=	01		; GSD
BLKT02=	02	.GD END
BLK03		; TEXT BLOCK
BLKT04=,	; RLD BLOCK
BLKT05=	05		h$Ӊ
BLKT06=	w MODULE END
	.SBTTL			MISCELLANEOUS

;FLAGS USED INͅTBLE M"
DEFFLG=	0c0		;DEFINED
RELFLG=	000040		;RELOCATABLE
GLBFLG=	000100		;GLOBAL

REGFLG=	000001		;REGISTER
LBLFLG=	000002		;LABEL
MDFFLG=	000004		;MULTILPY DEFINED


;STATUS BITS

SB.ILE=	001		;INVALID LINE ERROR
SB.CSE=	002		;CHECK SUM ERROR
SB.PFE=	004		;PARITY FORMAT ERROR
SB.DPE=	040		;DEVICE PARITY ERROR
SB.EOF=	100		;EOF
SB.EOM=	100		;EOM


;ADDRESS MODE FLAGS

AM.DEF=	10		;DEFERRED MODE
AM.INC=	20		;AUTO-INCREMENT MODE
AM.DEC=	40		;AUTO-DECREMENT MODE
AM.NDX=	60		;INDEX MODE
AM.PC=	07		;PC MODE ADDRESSING
AM.IMM=	AM.INC+AM.PC	;IMMEDIATE MODE
AM.REL=	AM.NDX+AM.PC	;RELATIVE MODE


OCTLEN=	^D<8*6>		;OCTAL PRINT STORAGE
LINLEN=	SRCLEN

;DIRECTIVE FLAGS DEFINED IN PST

	.GLOBL	DFLCND,	DFLMAC,	DFLGEV
	.GLOBL	DFLGBM,	DFLSMC
	.SBTTL		SUBROUTINE CALL DEFINITIONS

;THE MACRO "CALL" IS THE EQUIVALENT OF "JSR PC," AND
;IS USED FOR SIMPLICITY.  THE MACRO "RETURN" IS THE
;EQUIVALENT OF "RTS PC".

	.MACRO	CALL	ADDRESS
	JSR	PC,ADDRESS
	.ENDM

	.MACRO	RETURN
	RTS	PC
	.ENDM


;THE MACRO "GENCAL" DEFINES A MACRO WHICH CALLS A
;SUBROUTINE OF THE SAME NAME.  IF "TRAPS" ARE ENABLED,
;GENCAL CAUSES A TRAP.

	.IF NDF	TRAPS

	.MACRO	GENCAL	NAME	;CAN BE CHANGED TO OPDEFS OR TRAPS
	.MACRO	NAME
	JSR	PC,NAME
	.ENDM
	.ENDM

	.IFF
	.MACRO	GENCAL	NAME
	ENTSEC	TRPSEC
	.IRP	OFFSET,	<\.-TRPBAS>	;GENERATE NUMERIC
TRP'OFFSET=	TRAP+OFFSET
	.WORD	NAME
	.MACRO	NAME
	.WORD	TRP'OFFSET
	.ENDM
	.ENDM
	XITSEC
	.ENDM

	ENTSEC	TRPSEC
TRPBAS:				;TRAP VECTOR TABLE
	XITSEC

	.ENDC
	GENCAL	SAVRĉwSAVE REGISTERS
	GENpf	XPR		;CALL THE EXPRESSION EVALUATOR
	GENCAL	iM	GENCAL	RELEXP
	GERELTST
	GENCAL	ABSEXP
	GENCAL	ABSTST
	GENC3SERR
	GENCAL	GLBEXP
	GENCAL	ABSTRM		;ABSOLUPTRM
	GENCAL	RELTRM		t̟CATABLE TERM
	GENCAc̅TRM		;GLOBAL TERM

	GENCAL	GETSYM
	GENCAL	qjSM
	GENCAL	GETR50
	gCL	SETR50
	GENCAL	TSTR50
	GENCAL	GETNB
	GENCAL	SETNBBcŝCAL	GETCHRǋNCAL	SETCHR
	GENCAL1G
	GENCAL	TSTARG
	GENCAL	SETIMM
	GENCAL	SE)	GENCAL	STCODE

	GENCAL	SSRCH
	GENCAL	OSRr.IIF NDF XMACRO, GENCAL	MSRCH
	.IIF NDF XEDLp ENCAL	LSRCH

	GENCAL	SETPF0
	GENCAL	SETPF1

	GENCAL	DNCǋCVTNUM
	GENCAL	R50UNP
	GENCAL	MOVBYT
	.IF DF	OVLAY
	GENCAL	CALOVR

	.MACRO	SETOVR	N
	.IF NE	OVRLVL
	.ERROR	OVRLVL	;  NOT = 0
	.ENDC
	.IF NDF	XOVR'N
OVRLVL=	1
OVRBAS=	OVR'N'B
	.CSECT	OVR'N
OVRTMP=	.
	.MACRO	XITSEC
	.CSECT	OVR'N
	.ENDM
	XITSEC
	.ENABL	PIC
	.IFF
OVRLVL=	-1
	.ENDC
	.ENDM

	.MACRO	ENTOVR	N
	SETOVR	N
	.IF GT	OVRLVL
	.CSECT	MAIN
	CALOVR
	.WORD	OVRTMP
	.CSECT	OVR'N
	.ENDC
	.ENDM

	.MACRO6$ԟVR	INgEBWIhԦV
	.ERROR	OVRLVL	;   { 1
	gD
	.I'B<INLINE>
+ӋCT	MAIN
OV.TMPW	XITSEC
	JMP	OV.TMP
	.ENDC
OVRLVL=	0
	.MACRO	XITSEC
	.CSECT	MAIN
	.ENDM
	XITSEC
	.DSABL4$BWEDM

	.MACRO	JMPOVR0bRUMP TO POSSIBLE OVERLAY
	.NTYPE	T.VAL,	ADRPNT
	.IF NE5VL-<AM.INC!AM.DEF!AM.PC>
	MOV	ADRPNT,-(SP)
	.ENDCʛP	CALOVF
+ΉM
	.IFF	"]ċj̩S FOR NON-OVERLAY

	.MAtETOVR3͋
	.ENDM
	.MACRO	ENTOVR	f	.ENDM
BWMCRO	XITOVR	INLINE
	.ENDM

	.MACRO	JMP	N
	JMP	@ADRPNT
	.ENF	.ENDC
	.SBTTL		MISCELgEUS MACRO DΓTIONS

	GENCAL	SETXPR
񢄮'D	PDPVF.MACRO	MUL	SRC,DST
	.IIF DIF <SRC>,<R3>,	MOV	SRC,R3
	dADIF <DST>,<R0>,+ҥOR	;I"ǃL MUL ARGSÃͫL
	.ENDM

	.MACRO	DIV	SRC,DST
	.IIF DIF <SRC>,Y	MOV	SRC,RcE	]IIF DIF <Du,yR0>,	.ERROB]əLEGAL DIV 4	CALL	DIV񢄮NDM

	.MACRO	SOB	REG,ADDR
	DEC	REG
	SDDR
	.ENDM

	.ENDC

񢄮F NDF	XCREF
	G	CRFRwCROSS REFEQgC A SYMBOL
	GENpf	RFDEF"]ēTTO, DEFINING IT
	.IFF
+RO	CRFREF		;DUMMY IF NO CREF
+ΉM
	.aҟ	CRFDEF
	gD
	.ENDC
	.MACRO	PUTKB	ADDR	;LIST TO KCE	OV	ADDR,R1
	CALL	PUTKB
	.ENDE	.MACRO	PUTLP	ADDR	;LIST TO LP
	MOV	ADDR,R1
	CALL	PUTLP
	.ENDM

	.MACRO	PUTKBL	ADDR	;LIST TO KB AND LP
	MOV	ADDR,R1
	CALL	PUTKBL
	.ENDM

	GENCAL	PUTLIN		;GENERIC OF ABOVE

	.MACRO	SERROR	NUMBER
S'NUMBER=	2000!NUMBER
	JSR	R5,SERROR
	.WORD	S'NUMBER
	.ENDM

	.MACRO	ERROR	ARG
	BIS	#ERR.'ARG,ERRBTS
	.ENDM


	.MACRO	BRJMP	ADDR
	.IF GE	.-<ADDR>
	.IF LE	.-<ADDR>-254.
	BR	ADDR
	.MEXIT
	.ENDC
	.ENDC
	JMP	ADDR
	.ENDM

	.MACRO	CHSCAN	TABLE	;CHARACTER SCAN
	MOV	#TABLE,R0
	CALL	CHSCAN
	.ENDM

	.MACRO	GCHTBL	CHAR,	ADDR	;GEN CHARACTER SCAN TABLE
	.WORD	ADDR,	CHAR
	.ENDM
	ENTSEC	TXTBYT
ERRMNE:
	.IRPC	CHAR,	< ABEILMNOPQRTUZ>
ERR.'CHAR=	1
	.REPT	<.-ERRMNE>
ERR.'CHAR=	ERR.'CHAR+ERR.'CHAR
	.ENDR
	.ASCII	/CHAR/
	.ENDM
	XITSEC

	.MACRO	SETNZ	ADDR	;SET ADDR TO NON-ZERO FOR T/F FLAGS
	MOV	SP,ADDR
	.ENDM

	.MACRO	PROCSI	FILE	;PROCESS CSI
	MOV	#FILE'CSI,R0
	CALL	PROCSI
	.ENDM

	.MACRO	OPENO	FILE	;OPEN AN OUTPUT FILE
	MOV	#FILE'CSI,R0
	CALL	OPENO
	.ENDM

	.MACRO	WRITOF	LNKBLK,BUFHDR	;WRITE AND WAIT
	JSR	R5,WRITOF
	.WORD	BUFHDR,LNKBLK,BUFHDR+2
	.ENDM

	.MACRO	WAITOF	LNKBLK,BUFHDR	;WAIT ON OUTPUT FILE
	JSR	R5,WAITOF
	.WORD	LNKBLK,BUFHDR+2
	.ENDM

	.MACRO	FINDEV	ENTRY		;FIN DEVICES
	MOV	#E)YYR1
	CALL	FINDEE	]ENDM
	.MACRO	IMULI	COUNT,ADDR
	.LIST	MEB
T.VALaϫNT

	.IF EQ	T.VALBḁ	ADDR
	.IFF
	.IF Lj.AL
T.VAL=	-T.VAL
	NEG	ADDR
	.ENDC

LG=	0
T.MASK=	040000񢄮EPT	^D14
	.IF LE	T.i[T.VAL
	.IF NE	T.MASK&T.V3.IF NE	T.MASK-TՠBWI EQ	T.FLAG
	MOV	ADDR,-(SP)
T.FLAG=	1
+ƍ
	.IF NE	T.MASK-1&T.VAL
	ADD	(SP),ADDR
	.IFF
	1"	QSP)+,ADDR
T.FLAG=	0
	.ENDC
	.ENDC
	.ENDCBWEDC
	ASL	ADDR
	.ENDcET]MASK=	T.MASK/2
	.ENDR
	.IF NE	T.FLAG
	ADD	(SP)+,ADDR
	.ENDC
	.ENDcE	]NLIST	MEB
	.ENDM
+©TL	ROLL DEFINITIONS

	.MACRO	GENROL	NAME,	B4TOP,	SIZE
	ENTSEC	ROLBAS
NAME'ROL=	.-ROLBAS񢄮ORD	BASE
	ENTSEC	ROLTOP
	.WORD	TOP
	ENTSEC	ROLSIZ
	.WORD	SIZE*2
RS.'NAME=	SIZE
	XITSEC
	.IIF GT	SIZE-MAXXMT,	MAXXMT=SIZE
	.ENDM

MAXXMT=	0		;MAX XMIT

				;START OF TABLE TO BE FILLEDg
	GENROL	SYM,     0 A 0,4	;SYMBOL TABLE
+ANDF	XMACRO
	GENROL	MAC,     0,     0,4	;MACR)OL
	GENROL	DMA,     0,     0,2	;DUMMY ARGUMEN)OL
	.ENDC
	.IF NDF	XEDLSB
	GENROL	LSY,     0,     0,4	;LOCAL SYMBOL ROLL
	.ENDC
	GENROL	SEC,     0,     0,5	;SECTION ROLL
	GENROL	COD,     0 A 0,4	;CODE ROLL
	.IF NDF	XMACRO
	GENROL	MAB,     0,     0,BPMB/2
	GO	MAA,     0,     0,Ba/e
	.ENDC

	GENROL	fA    0,     0,0	;DUMM(SPARATES VARIABLE FRO#IED)

	GENROL	CND,CNDBAS,CNDTOP,2	;CONDITIONAL ARGUMENTS
	GENROL	SWT,SWTBAS,SWTTOP,2	;COMMANDRNG SWITCHES
	GENROL	EDT,EDTBAS,EDTTOP,2	;ENASħABL
	GENROL	LCD,LCTBAS,LCTTOP,1	;LISTING CON	GENROL	PST,PSTBAS,PSTTOP,4	;PERMANENT SYMBO*ALE
	.IF NDF	XCREF
1ΥOL	CRF,CRFBAS,CRFTOP,1	;CREF MNEMONIC ROLL
	.ENDC
				;ROLL HANDLER̙S

	.MACRO	SEARCH	SNM	;BINARY SEARCH
	MOLNUM,R0
	CALL	SEARCH
	.ENDM

	.MACRO	SCAN	ROLNUM	;LINEAR SCAN
	MOLNUM,R0
	CALL	SCAN
	.ENDM

	.MACRO	SCANW	ROLNUM	;LINEAR SCAN, ONE WORD
	MOV	#ROLNUM,R0
	CALL	SCANW
	.ENDM

	.MACRO	NEXT	ROLNUM	;FETCH N* NTRY
	MOV	#ROLNUM,R0
	CALL	NEXT
	.ENDM

+RO	APPEND	ROLNUM	;APPEND TO END OF ROLL
	MOV(ONUM,R0
	CALL	APPEND񢄮NDM

	.MACRO	ZAP	R'U	;CLEAR ROLL
	MOV	#SNM,R0
	CALL	ZAP
	.ENDM

	GENCAL	INSERT		;INSERT (MUST BE PRECEDED B('΋ 
				;OF THE ABOVE TO SET POINTERS)
	GENCAL	SETROL		;SAVE AND SET REGS FOR ABOVE




	ENTSEC	MIXED		;DON'T CLEAR
PRGLIM:	.LIMIT			;PROGRAM LIMITS
ROLNDX:	.BLKW			;ROLL INDEX
ROLPNT:	.BLKW			;ROLL POINTER
ROLUPD:	.BLKW			;UPDATE IF NON-ZERO

	XITSEC
	ENTSɛiECEPSS:	.BLKW
				;NEXT GROUP MUST STAY TOGETHER
SYMBOL:	.BLKW	2		;SYMBOL ACCUMULATOR
MODE:
FLAGS:	.BLKB	1		;FLAG BITS
SECTOR:	.BLKB	1		;SYMBOL/EXPRESSION TYPE
VALUE:	.BLKW	1		;EXPRESSION VALUE
RELLVL:	.BLKW	1
	.REPT	MAXXMT-<<.-SYMBOL>/2>	;END OF GROUPED DATA
	.BLKW
	.ENDR

CLCNAM:	.BLKW	2		;CURRENT LOCATION COUNTER SYMBOL
CLCFGS:	.BLKB	1
CLCSEC:	.BLKB	1
CLCLOC:	.BLKW	1
CLCMAX:	.BLKW	1

	ENTSEC	IMPPAS		;CLEAR EACH PASS

CHRPNT:	.BLKW			;CHARACTER POINTER
SYMBEG:	.BLKW			;POINTER TO START OF SYMBOL
ENDFLG:	.BLKW

	XITSEC			;RETURN TO NORMAL
	.SBTTL	PROGRAM INITIALIZATION

	.GLOBL	START,	CONT,	FIN

START:
	.IF DF	TRAPS
	.TRAP	#0,#TRPPRO	;ENABLE TRAPS
	.ENDC
	MOV	#FINTBL,R1
1$:	CLR	@(R1)+		;CLEAR LNKBLK'S FOR RESTART
	TST	(R1)
	BNE	1$
	CALL	XCTPRG		;CLEAN THINGS UP A BIT
	.IF NDF	XRESKB
	.INIT	#CMILNK		;INIT COMMAND INPUT
	.IFF
	MOV	PRGLIM,SP	;MAKE ROOM FOR OUTPUT KB
	.ENDC
	.IF NDF	PAL11R
	.IF DF	OVLAY
	CMP	OVRBLD,CPOPJ	;ANY OVERLAY?
	BEQ	2$		;  NO, LEAVE "R"
	MOVB	#LET.O,HELLOF	;YES, SET TO "O"
	.ENDC
	.ENDC
2$:	PUTKB	#HELLO		;SAY HELLO

CONT:
	.IF NDF	XMACRO
	BIC	#BPMB-1,PRGLIM	;MACRO STORAGE MUST BE EVEN
	.ENDC
	.IF NDF	DOSV4
	.STSTK	PRGLIM		;INFORM MONITOR
;	TST	(SP)+		;PRUNE STACK IF NEEDED
	.ENDC
	MOV	PRGLIM,SP	;SET STACK POINTER
	MOV	#DUMROL,R1	;POINT TO SEPARATOR ROLL
2$:	MOV	SP,ROLBAS(R1)	;FILL IN VARIABLE BASE
	MOV	SP,ROLTOP(R1)	;  AND TOP
	CLRB	ROLSIZ+1(R1)	;CURRENT SIZE
	DEC	R1
	DEC	R1
	BGE	2$		;LOOP IF MORE ROLLS
	CALL	XCTPRG		;CLEAN UP MEMORY
	CALL	SETUP		;SET UP FOR CALL
	CALL	ASSEMB		;CALL THE ASSEMBLER
	.IF DF	XRESKB
	MOV	PRGLIM,SP	;MAKE ROOM FOR KB
	.ENDC
	CALL	SETDN		;CLEAN UP
FIN:	.IF NDF	XRESKB
	FINDEV	FINTB2		;CLOSE ALL FILES BUT KB
	.IFF
	FINDEV	FINTB1		;CLOSE ALL FILES
	.ENDC
	BR	CONT		;BACK TO "#"
SETUP:				;INITIALIZE THINGS
	OR	1
	.IF DF	DOSV4
	.IF NDF	XCREF
	.SYSDV
	MOV	(SP)+,CRFLNK+6
	.ENDC
	.IF NDF	XSML
	.SYSDV
	MOV	(SP)+,SMLLNK+6
	.ENDC
	.ENDC

	.RSTRT	q	;SETөART ADDRESS

4*ԗB	#HASH		;TYPE "#"

	MOV	#CMIHDR+6,R1
	MOV	#CMILEN,-(R1)
	CLR	-(R1)
	MOV	#CMILEN,-(R1)
	.1D	XRESKB
	.INIT	#CMILNK
	.IFTF
	.READ	#CMILNK,R1
	.WAIT	#CMILNK
	.IFT
	.RLSE	#CMILNK
	.RLSE	#CMOLNK
	.ENDC
	TSTB	3(R1)		;EOF?
	BEQ	1$		;  NO
	.EXIT			;YES,GOOD-BYE

1$:	MOVB	CMIBUF,R5	;FETCH FIRST CHAR
	TSTB	CTTBL(R5)	;EOL?
	BDI"]A1iA1OE
	.CSI1	pąUF
	MOV	(SP)+,R2	;GET ERROR FLAG
	BEQ	SETUP1		;  OK
3gօ	#CH.QM,(RJUwERROR, SET "?"
	CLRB	(R2"DA AND TERMINATOR
	PUTKB	#sd«F
	.IF NDbOV4
	.FLUSH	#1
	.ENDC
2$:	JMP	FIN
SETUP1:	MOV	#CMDBRc͟V	#CMYR2
	CALL	do		;SAVE INITIAL CMD HEADER
	MOV	#2,CMDBUF
	PROCSI	OBJ		;PROCESS OBJECT FIRST
	MOV	R0,-(SP)	;STACK FLAG
	MOV	R1,-(SP)	;  AND POINTER
	ASR	R0		;ANY MORE OUTPUT FIELDS?
	BCS	14$		;  NO
	PROCSI	LST		;YES, PROCESS LISTING FIELD
	BPL	13$		;BRANCH IF EMPTY
	.INIT	R1
	INCB	LLTBL+LST.L	;ASSUME TERMINAL
	.STAT	R1
	BIT	#000400,(SP)+	;TRUE?
	BNE	12$		;  YES
	MOV	#LST.L+<LST.KL*400>,LLTBL+LST.L
12$:	INCB	LLTBL+LST.ER	;ERRORS TO LOGICAL LP
	CMP	(SP)+,(SP)+	;PRUNE .STAT RESIDUAL
13$:	ASR	R0
	BCS	14$		;BRANCH IF LAST SPEC
	SERROR	204		;  NO, ERROR

14$:	MOV	(SP)+,R1
	MOV	(SP)+,R0	;ANY OBJ OUTPUT?
	BPL	15$		;  NO
	.INIT	R1		;YES, INIT IT
15$:
	.IF NDF	XCREF
	TST	CRFFLG		;CREF REQUESTED?
	BEQ	SETUP2		;  NO
	.INIT	#CRFLNK		;YES, INIT IT
	.ENDC
SETUP2:	MOV	#LCSAVE,R1	;SAVE CURRENT LISTING FLAGS
	MOV	#LCSBAK,R2
	CALL	XMIT0-LCSAVL
	MOV	EDMASK,EDMBAK	;DITTO FOR ENABL/DSABL FLAGS
	CLR	CMDBUF		;SET FOR INPUT
	MOV	(PC)+,@(PC)+	;SET DEFAULT FILE NAME
	.RAD50	/TEM/
	.WORD	DEFNAM
	MOV	(PC)+,@(PC)+
	.RAD50	/P  /
	.WORD	DEFNAM+2

21$:	PROCSI	SRC		;SET FOR SOURCE
	BMI	22$		;BRANCH IF NON-NULL
	SERROR	206		;YOU LOSE!!
22$:	MOV	SRCFIL,R1	;GET SOURCE FILE NAME
	BEQ	23$		;  BRANCH IF NULL
	MOV	R1,DEFNAM	;NON-NULL, SET DEFAULT NAME
	MOV	SRCFIL+2,DEFNAM+2
23$:	ASR	R0		;ANY MORE?
	BCC	21$		;  YES

	MOV	(PC)+,R5	;SET DEFAULT LISTING EXTENSION
	.RAD50	/LST/
	OPENO	LST		;OPEN LISTING FILE
	RETURN
	XITOVR
SETDN:				;CLEAN UP
	ENTOVR	1
	MOV	#FINMSG,R1	;SET FOR FINAL MESSAGE
	MOV	#LINBUF,R2
	MOVBYT			sg֋ INTO LINBUF
	MOV	ETΩ,R1
	DNC			;PRINT IN DECIMAL
	MOV	#FINMS1,R#E	OVBYT
	MOV	FRECOR,R"]ßMPUTE FREE CORE SIZE
	ROR	R1		;CONVERT TO WOQ)	DNC			;PRINT RESULT
	MOV	#FINMS2,R1	;". WOR	MOVBYT
	CLRB	(R2)BhUKBL	#LINBUF		;LIST T%A& LP
	PUTLP	#CMIBUF		;PRINT THE COMMAND STRIƊ.IF NDF	XRUN
	TST	CQL
	BEQ	9$
	TST	CRFNGF		;NO-GO?
	BNE	9$		;  YES
	FINDƓNTBL		;RELiAALL DEVICES
	SUB	#<+k+6+10>*2,SP
	MOV	SP,R2
	MOV	#LSTLNK-2,R1
	pfLXMIT5
	MOV	#LSTFIL-4,R1
	CALL	XMIT6
	MOV	#tLK-2,R1
	CALL	XMIT5
	MOV	#CRFFIL-4,R1
	CALL6&ɩ6
	.RUN	#RUNBLK
	HALT
	.ENDC
9$:	RETURN

	XITOVR
FINDEV:	"DADEVICƊENTOVBX1$:	MOV	(R1)+,RCE	ST	(R2)
	Qhe$
	.CLOSE4+Li22$:	TST	(LT0E1$
	QjUN
	XITOVR񢆊ENTSEC	DPURE
FINTBL:	.IIF DF	OVLAYWWQԥ'KFINTB1:		+ϥa͓NITB2:	.IIF NDF XSML,	.WORD4̙Ɗ.IIF NDF XCREF,+ϥD	CRFLNK
"DORD	SRCLNKggT3:			.WORD	LSTLNK
	"WWQ
	ENTSEC5,TYT
FINMSGBWArm	yt<F>/ERRORS jETED:  /
FINMS1:	.ASCII	<CR><LF>/FREE COQ] AECLF:	.ASCIZ	//
gM2:	.ASCIZ	/. WORDS/R ӑBWACIZ	<CR><LF> /#V>
HE'.ASCI"^C><LF> /MACRO V/	;INTSMtǋE:	.IF NDF	PAL11R
	.4ɓ	/R/
	.IFE	]ASCII	/P/BWEƊU			;GENERAPVRSIONͅiÓBW_񢆊XITSEcE.IF NDF	XRUN
BbΩSEC	M6"T΅	]WORD	И1a0a00010011
+ϥD	RUNf	.WORD	RUN+ϥD	2
񢄮ORD	0
RUNLNK:	҉	0
	Ԡk0	/RUN/
	.WORD	1
	.RAD50	/SY/

	.WORD	0
	.WORD	4
UgF1/CREF+AA  /
	.BYTX,a񢄮ORD	0


	XITSEC
	.ENDC
PROCSIBD;PROC頇SI FI"				;R R0: ΩTɅƊ"DXIT  R0: CSI2 RETURN񢄉. A A  BIT 0: 1c EV SPECIFI			;      L] OINTEH*OALNKBLcE1gTVR	1Bfϭ	2(R0),R1	;POINT TO LNKBLK
	S5E"DAVE CURREN)ES
	C1)+,(R1)+	;BYPASS TWO WORDS
	MOV	#^D72.,(R1)b]ӋT CSI$͓T
	.CSI2	R0		;pfLAMONITBIT	#2,(SP)		;TMCH SWITCHES?
	BNE	5$		;  YES
	ASL	(SP)		;CLEAR SIGN BIT
	TST	(R1)+		;ANY"֓CE?
	BEQ	10$		;  NO
	SEbDwYES,  AIT
1		OR	(SP)
1$:	MOTRc)+,R3.HOUGH?
	BEQ	6$		;  YES
	ADD	R3,R1		;NO, MOVE TO END OF BLOCK
	ADD	R3,R1
3gR1,-(twMARK "LACEBfϭ	-(R1+)ٛBOL	;qj OR SCAN
	SCANW4ԥOL		;DO SO
	BE"Z	;ERROR IF NOT IN TABLE
3g#LINBRe	;USE$΋ BUFFER FOR UNP0ɝG
2$:	MOVB	#SPACE,(R2)+	tADELIM5"	DEC	R3		;END?
	BEQ	4$	. ES
	MOV	-(R1),CHRPNT	;SET CHARACTER POINTER
	DEC	CHRPNT		;GET A RUNNING START
3$:	GETR50			;j HAR AND TEST FOH 
	BLE	2$		;  NTROUGH
	MOVB	R5,(R2)+	;OK, STUѐI¥,$u	CLRB*)2S"]Ӌ*EMINATOR
	MOV	#LINBUF,CHR	SETNB
	CLR	ERPS	CLR0iGNT
	3SIFLG		;INDICAT+ORE IN THE COMMAND STRING
	CLR3gċ͟iٛS+e,VALU]̓KE IT LOOK LIKE PST
	CALL	PROPC		;ËtAc IRECT5	DEC	CSIFLG
	MP)+,R1
	B4ťRBTS,MD5 AND ERROR BITS MUST BOTH BE ZERO
	BEQ,R5$:	SERROR	203

6$:	MOV	(SP)+,R0	;SET R0 AN#LGS
	RETURN

	ENTSEC	IMPURE
CSIFLG:	.BLKW			;SET WHE)OgE̙ED FRPCI
	X5)Ň
	XITOVR			; 1OENO:				;OPEN O(U FILEŝTOVR	#E	AVREGԧT	(R0)+		;MOVE iAs̓ND BUFFER POINTER
	MOV	(R0)+,R3	;L3LOCK POINTER TO R3
	TST	(R3)	.ΓTTED?Q	OPENO4		;  NO͟V	(R0+)4	;YES, FILE BLOrPINTER TO R4
	CMP	-(R4),-(R4)	;BACK UP TO ERRSOT
	MOV	R4,R2		;GET A WORKING COPY͟QϡY(R2)+	;IGNORE D"ԓON ERS	MOV	#2,(R2)+	; AFOR O(U
	MOi2YR1		;4՛E NAM)ЋCIFIEE	ST	(R2)		;TRUE?
	BNE	1$	. Ɗ	GcNM,R1	;NO, USE Dՙ'AE
1$Bfϭ	(R1)+,(R2)+	;Xi 3b	MOV	(R1)+)2S+
	TST	(R2)		;EXPLICIT EXTENS3?BaN	2$		hYS
	Mk,(R2)		;NO, USE DEFAULT
I	]DELET4QLq"̋TE CURRENT
	XITOVR
OPEN	NTOVR.FCLR	(M;CLEAR ERROR ADDRESS
	.Og	3,(R0"DPEN TPFLE
OgOi:	RETURN
񢆊ENTSEC	IMPURE
DEFNAM:	.BLKW	2"]ċj̩ NAMEؓCE	ITOVR

SO:				hAERROR
	MOV	R5,)S	;DIS AADDREtƊSUB	#PRGBEG+2,(SP)	;GIVE RELATIVE A)EcE	OV	(R5),-(SP)	;  AND NUMBER
	3	BRJMP	FIN
	.SBTTL0iӋE PROPER

ASSEMB:				;ASSEMBLER PROPER
	CALL	1$		;PROqiAPASSBd·	PASS		;SET FOR ӧc$:	CALL	XCTPAS		;INI#O ӧ
	CALL	SECINI	.ΓT THEéOR ROLL
	c DF	XCQc	TST	PASS
	BEQ	2$		pACH IF PASS 1
	TST	CQN
	BEQ	2$	. H$ANO CREF INITTED͟V	LSTf,QI.FR LIS#IE NAM*OACREF FILE
	MOV3)ԍIL+2,tFL+2
	MOV	(PC)+,R5	;SET DEFAULT EXTɟN
	.RAD50	/CRF/
	OPENO	CRF		sE CREF FILE
	MOV	#CRFBUF,tPT	;IN5FH!ҋE	]ENDCL:pfLqjSbDET SOURCE SCAN
3$:	pfLGETLIN		;GT'ET INPUT LIFSiDAACH IF EOFBaL	STMNT		;ËtT)ԃTEMENT
4$BabΉLIN		;POLISH OF&IE
	TST	ENDFLG		;ENDŝ?
	BEQ	3$"]ANO, CIUE
	CALL	P.RCESS END-OF-PASS
CPOPJ:	RETURN

	ENTSEC	DPURE
R50ABS:	.R1/. ABS./
R50DOT:	.RAD50	/.     /
	XITSEC
qjSn.ũ SOURqPFR BEGINNING OF i	MOV	#CMDSAV,R1
	MOV	#CMDBUF,R2
	CALL	XMITDC(!UFER
ũSRC:				;GET TH'ET SOURCE FILE
1gTԄLR:CLR	P4ӯ		;CLEAR PASS SjC
	PROCSI	SRC		;PROCESS TPSURCE fE	DEC	PASSuĉwANY PASS SWITCH?
	BMI	7$		;  ƊCMP	P4ӯ,PASS.ŧ, THIS PASS?
	Sc$		;  NO, IGNOR#IE
7$BiO	R0
	ROL	CSISAV		;FLAG POSSIBLE TERMINATOR
+ΓT	#SRs'K	;INIT IT
	TST	SRCF3;EXPLICIT *ErgE	GETSR3		;  YES, USE ITBfϭ	#R50a2	;NO*R ".MAC" AND ".PAL"
	XITOԆETSRXBbΩOVR	9
GETSR2:		GGETSR)҇FIL-4͟V	(R2)+,SRCFIL+]͟VE IN NEXT"ƃ*	BNE	jS4		;BRANCH IF NON-NUETSR3Bḁ	SRCFIL-4	sRRORS ALLOWED
jS4:	MOV	#4,SRCFIL-2
	.IF DF	DBLBUF
	.MCALL	.LOOK,+ԃPg	.LOOK	#SRs'KY#SRCFIL,START	;LOOK IT UP
	MOV	#SRCTRN,R0	;POINT TO TRAN BLOCK
	MOV	(SP)+,(R0)	;SET STARTING BLOCK
	CMP	(SP)+,(SP)+	;PRUNE REMAINING TWO
	TST	(R0)+		;FOUND?
	BNE	5$		;  YES
	TST	SRCFIL-4	;NO, LAST CHANCE?
	BNE	GETSR2		;  NO, TRY NEXT EXTENSION
	.IFTF
	.OPEN	#SRCLNK,#SRCFIL
	.IFT
5$:	MOV	#SRCDB2,(R0)+	;READ INTO SECOND BUFFER
	CLR	SRCDBC
	CLR	SRCDBX
	.STAT	#SRCLNK
	ROL	(SP)
	BIC	#077777,(SP)
	MOV	(SP),SRCDTA
	CMP	(SP)+,(SP)+
	MOV	(SP)+,(R0)+	;SET BLOCK SIZE
	MOV	#4,(R0)+	;SET TO READ FORWARD
	.TRAN	#SRCLNK,#SRCTRN	;START FIRST READ
	.IFTF
	INC	FFCNT		;START A NEW PAGE
	XITOVR	INLINE
	.IF DF	SNGBUF
	RETURN
	.ENDC
	.IFF

INPSRC:				;INPUT A SOURCE BUFFER
	MOV	#SRCBUF,R0
	CLR	-(R0)		;CLEAR COUNT
	CLR	-(R0)		;  AND MODE
	MOV	#SRCLEN,-(R0)	;SET MAX LENGTH
	.READ	#SRCLNK,R0	;READ IT
	.ENDC
	RETURN

	ENTSEC	DPURE
R50MAC:	.RAD50	/MAC/
R50PAL:	.RAD50	/PAL/
	.RAD50	/   /		;TERMINATOR

	ENTSEC	IMPPAS
CSISAV:	.BLKW			;SET NON-ZERO ON LAST SRC FILE
	XITSEC

	GENSWT	PA,PASSSP

PASSSP:	ABSEXP			;/PASS, EVALUATE NUMBER
	MOV	R0,PASSSW	;STORE RESULT
	RETURN

	ENTSEC	IMPURE
PASSSW:	.BLKW			;PASS SWITCH
	XITSEC
GETLIN:				;GET AN INPUT LINE
	SAVREG
	CALL	XCTLIN		;INIT LINE-ORIENTED VARIABLES
GETL01:	MOV	FFCNT,R0	;ANY RESERVED FF'S?
	BEQ	31$		;  NO
	ADD	R0,PAGNUM	;YES, UPDATE PAGE NUMBER
	MOV	#-1,PAGEXT
	CLR	FFCNT
	.IF NDF	XLCSEQ
	CLR	LINNUM		;INIT NEW CREF SEQUENCE
	CLR	SEQEND
	.ENDC
	TST	PASS
	BEQ	31$
	CLR	LPPCNT
31$:	MOV	#LINBUF,R2
	MOV	R2,LCBEGL	;SEAT UP BEGINNING
	MOV	#LINEND,LCENDL	;  AND END OF LINE MARKERS
	.IF NDF	XSML
	TST	SMLCNT		;IN SYSTEM MACRO?
	BNE	GETL40		;  YES, SPECIAL
	.ENDC
	.IF NDF	XMACRO
	MOV	MSBMRP,R1	;ASSUME MACRO IN PROGRESS
	BNE	GETL10		;BRANCH IF SO
	.ENDC
	MOV	#SRCBUF,R1
	.IF DF	SNGBUF
	CALL	INPSRC
	.ENDC
	.IF NDF	DBLBUF
	.WAIT	#SRCLNK
	.IFF
	CALL	GETDBL
	.ENDC
	.IF NDF	XLCSEQ
	INC	LINNUM
	.ENDC
	MOVB	SRCHDR+3,R0	;GET CODE BYTE
	BIT	#SB.DPE!SB.PFE!SB.CSE!SB.ILE,R0	;ANYTHING BAD?
	BEQ	32$		;  NO
	ERROR	L		;YES, ERROR
32$:	ROLB	R0+<0&SB.EOF>	;EOF?
	BPL	GETL02		;  NO
	.IF NDF	DBLBUF
	.CLOSE	#SRCLNK
	.ENDC
	.RLSE	#SRCLNK
	BIS	CSISAV,ENDFLG
	BNE	34$
	CALL	GETSRC
	BR	GETL01

34$:	ERROR	E
	CLRB	(R2)		;MAKE INTO NULL LINE
	BR	GETL09
GETL02:	MOV	-(R1),R4	;GET BYTE COUNT
	CLR	(R1)+		;SET STOPPER
	ADD	R1,R4		;COMPUTE END
3$:	CLRB	(R4)		;FORM ASCIZ
	MOVB	-(R4),R5	;GET LAST CHAR
	CMP	R5,#CR		;IF > CR
	BHI	6$
	CMP	R5,#LF		;  OR < LF
	BLO	6$		;  MOVE ON
	CMP	R5,#FF		;FORM FEED?
	BNE	3$		;  NO, LOOP
	INC	FFCNT		;COUNT THE PAGE
	BR	3$

5$:	MOVB	R5,(R2)+	;MOVE INTO LINBUF
6$:	MOVB	(R1)+,R5	;FETCH NEXT CHAR
	MOVB	CTTBL(R5),R0	;GET CHARACTERISTICS
	BEQ	7$		;QUESTIONABLE
	BIT	#CT.LC,R0	;LOWER CASE?
	BEQ	5$		;  NO
	.IF NDF	XEDLC
	BIT	#ED.LC,EDMASK	;LOWER CASE ENABLED?
	BNE	4$		;  NO, CONVERT TO UPPER
	ADD	#240,R5		;YES, END UP WITH "200 + LC"
	.ENDC
4$:	SUB	#40,R5		;CONVERT LOWER TO UPPER CASE
	BR	5$		;STORE

7$:	MOVB	R5,(R2)		;QUESTIONABLE, ASCIZ NULL?
	BEQ	8$		;  YES, ALL SET
	ERROR	I		;NO, ILLEGAL CHARACTER
	MOV	#200,R5		;STORE ZERO WITH FLAG BIT
	BR	5$

8$:	.IF NDF	DBLBUF
	.IF NDF	SNGBUF
	.IF NDF	XSML
	TST	SMLCNT
	BNE	GETL09
	.ENDC
	CALL	INPSRC		;ALL SET FOR THE NEXT BUFFER
	.ENDC
	.ENDC
GETL09:	.IF NDF	XEDCDR
	MOVB	LINBUF+72.,CDRSAV	;SAVE COLUMN 73
	BIT	#ED.CDR,EDMASK	;CARD READER TYPE?
	BNE	38$		;  NO
	CLRB	LINBUF+72.	;YES, FORCE EOL
	.ENDC
38$:	MOV	#LINBUF,CHRPNT
	SETNB
	BNE	39$		;ALL SET IF NON-NULL LINE
	TST	FFCNT		;NULL, FORM FEED?
	BEQ	39$		;  NO
	BRJMP	GETL01		;YES, JUST BUMP PAGE COUNT

39$:	MOV	ENDFLG,R0	;RETURN WITH "ENDFLG" AS ARGUMENT
	NEG	R0
	RETURN


	.IF NDF	XSML
GETL40:	MOV	#LINBUF,R1	;SYSTEM MACRO,
	CLR	-(R1)		;  MOVE RIGHT INTO LINBUF
	CLR	-(R1)
	MOV	#SRCLEN,-(R1)
	.READ	#SMLLNK,R1	;READ IT
	.WAIT	#SMLLNK		;  AND WAIT
	MOVB	LINBUF-3,ENDFLG	;MARK IF EOF
	BNE	GETL09		;BRANCH IF EOF
	CMP	(R1)+,(R1)+	;ELSE MOVE INDEX
	DEC	(R1)+		;BYPASS FF, POINT TO LINBUF
	BR	GETL02		;PROCESS NORMAL
	.ENDC
	.IF NDF	XMACRO
GETL10:	CALL	20$		;MOVE A CHARACTER
	BGT	GETL10		;LOOP IF GT ZERO
	BEQ	19$		;END IF ZERO
	MOVB	-(R2),R0	;TERMINATOR, BACK UP POINTER
	CMP	R0,#MT.MAX	;END OF TYPE?
	BLOS	22$		;  YES
	MOV	R1,-(SP)	;REMEMBER READ POINTER
	MOV	MSBARG,R1
	TST	(R1)+
	MOV	R2,R3		;  AND WRITE POINTER
	NEG	R0		;ASSUME MACRO
	CMP	MSBTYP,#MT.MAC	;TRUE?
	BEQ	12$		;  YES, USE IT
	MOV	MSBCNT,R0	;GET ARG NUMBER
12$:	MOV	R3,R2		;RESET WRITE POINTER
13$:	CALL	20$		;MOVE A BYTE
	BGT	13$		;LOOP IF PNZ
	BLT	14$		;END IF LESS THAN ZERO
	SOB	R0,12$		;LOOP IF NOT THROUGH
14$:	TSTB	-(R2)		;YES, BACK UP POINTER
	MOV	(SP)+,R1	;RESET READ POINTER
	BR	GETL10		;END OF ARGUMENT SUBSTITUTION

19$:	MOV	R1,MSBMRP	;END OF LINE, SAVE POINTER
	BIS	#LC.ME,LCFLAG	;FLAG AS MACRO EXPANSION
	BR	GETL09

20$:	BIT	#BPMB-1,R1	;MACRO, END OF BLOCK?
	BNE	21$		;  NO
	MOV	-BPMB(R1),R1	;YES, POINT TO NEXT BLOCK
	TST	(R1)+		;MOVE PAST LINK
21$:	CMP	R2,#LINBUF+SRCLEN	;OVERFLOW?
	BLOS	23$		;  NO
	ERROR	L		;YES, FLAG ERROR
	TSTB	-(R2)		;  AND MOVE POINTER BACK
23$:	MOVB	(R1)+,(R2)+	;MOVE CHAR INTO LINE BUѢ	RET
22$BaL	ENDa;CLOSE MACRO
	JMP	GETL01񢄮NDC
񢆊ENTSEC	IMPPAS
LPPCNT:	.BLKW	1		;FOP⠝EW PAPWEN NEGATIVE
FFCNT:	.BLKW,DwUNPROCESSED FF COUNT
PAGf.BLKW	1		;PAGE fR
PAGEXT:	.BLKX;PAGEͅER EXTENSION
	c DF	XLtLINN]	]BLKW	2		;CREF LINE NUMBER
SEQ:.BLKW	1
	.ENDC

	XITSEC
	.IF DF	DBLBUF

GETDBL:				;GET DOUBLE-BUFFERED INPUT
	SAVQc	MOV	SRCDBP,R1	;POINTER T)1	MOV	#SRCHDR+3	wWILL END UP AS t«F
	CLRB	(L.ҥFAGS
0R)W		;CHARACTER CO	MOV	SRCDBC,R3	p՝T
1$BbE	R3		;ANY MORE 3BѢ
	BLT	3$	. E	OVB	(LTYLES, FETCH THE N* HAR
	BIC	#^C177,R0	;IGNOQPPRITY
	BEQ,R	rcΟQPNLLS
0#177,R0
	Qhc$		;  AND RUBOUƊINC	SRCHDR+4	;OkBMP CH4éER CO	CMP	tȉR,SRC)+i	;OVEKcLW?
	S'2$		;'O	BISBQa+)҇)+g	;YES)ũ ERROH#LG
	DӥCHDR+E	EC	R2$u	MOVB4,QLtOE CHAPaԋR
	Ca,#FF	.ϙ?
	BDI"]AƊCMP	R̍
	BLX	MOV4RCDBP.IISHED)EEAΩ	k)҇w  AND՝T
	R*ҝ

3ԧT	SRC	s$Η
	BNZ$	;  YƊBISB	t.Sr"RW3	;NO"ύ
	REiN
4$BWWIT	#SPN		;AW2j HE NEBFFERBfϭ	SRCDVRa͟QӥCTRN+)4	MOV*)4SqACOUNTċbi3.EUCT FPINTERL	R3	.ϝVERT BTES
3g-(R4)wPOINTTƍJST RE1MOV	SPB(R0),)	MOV(,RCTRNmMOV	(LTY-(R4).ũ NEW gK	BEQ-R	;  EN$AZEROBaI	SRCDV(4)
	Qhm$
	NĨ4)
	RiG00400)҇TRN+6$u+RQӥCLNK,Mb PNXT GU#E5I:	ADD(,D3E
	BIbQއ2,R0Bfϭ	R0,SPB¥,RbΩqaPURETCBB:	.DSRCDB+ӥCDB2,4CLFBbΩSEC	I*ҋ
SRC:.BLKW񢄮LKW
+LW
	.S%		;IN5*E'i񢄮LKW
ŝ3hUE
SRq!Xu	.BLKDwRING sTOLLER
 H)TCBP:	.S%		;PO3E
SRC.BLKW"DOUNTECESCDTA:+LW

tą1:	.Bi00		;UcFTƊPBe:	.BLuĴa0

6$ԧƊgD
EN$u				; &I(RCESSOCE	5EÙR	ROL"	;SET FTCH FS标ODE R&	TSTB0T)5S	;EOL OR Sd'X. ES
	O	Q
1ÙR	-(SP)		;INIT LISTING FL1Ɗ.IF NDF	XEDCDR
	MOVB	CDRpk,3Um.;REPLACE BORROWED CHAR
	.ENDC
	TShAS		;PASS 1?
	BDI		;  1i	TST	ERRBTS		;ANY ERRORS?
	BNE	7$		;  YES, G"IECTLY"OANOT C&EEC.
	TSTB	*B+LST.]Y LISTING kIƊQhs$		; 	MOV	#LST.L,(SP"]ًkMqPI LOGICAL LE	IT	#LC.LD,LG	;LIu$Ώ$ҋu$֋?
	BNE	5$		;  1i	TST	V"]ԋST OV՝i 1"	BLT	5$		;1<a, LIST ONLY IF ERRORcE	I		;IF,ALIST UNCONjIfLQ̇.COM,LCMASK	;CObΩСRESSI02$		;  NOBfϭ0RNT,LCENDL	;YES, ASSUME WEITTING AT COMMENT
2T	#LCCYLCMASb]̓NE SUPPRESSION?Q	3$	. O
	MINBUF!ŝ OINT S4 F BUFFER
i	.IF #	MACROԧTB	ROLSIZ+sR؉wANYTH3N COD)OL?
	BEQ	4DA	BIT	#LC.MLMASK	s`åO BIN4XPANSION?
	BNE	4$		hN
	BIC	#LC.ME,LqA	;YES$ǝ#LG
	.C4$:	BIT	LCMASK,LCFL1ĻjHNG SU)Eqb?BaE.R	;  NO, USE CURRENT FLAGS
5$:	CLR	(SP)		vbY CLEAH&ITING E	BR	9$
7$:	M	LTBL+.R,(SP"]ťS,Aqj ROPER FLAGS

+ANDF	Xţ
	.I'D	XLCTFBIT	#LC.TTM,LCM4wTELETYPE M"	BNE	8$		;  NO, BYP4頋XTRA LINE
	.ENƊMOV	#STARS,R1	;"****J	MOV	#OCTBUF,R2
	MOЬ"]͟VE INOf UFFER͟VB	#SPACE,(R2)+
	CALL	TSiR	;SETiRRS
	s)B).OM ASC6MOVB	)YLSTMOE	OV	#OCTBUF,R1
	PUTLIN			;DRAW THE USER'S ATTIN
	.C8$:	MOV	#gB&CEGL	;iAI&IE
	MOV	#L3Ή,LCENDL
9$:	CALL	PCROLL		;PROqiAENTRY ODE R&ENDL10:	MOVB	(tSTMOD	;ANYTHING REQUESTED?
	BEQ	ENDL20		;  NE	LRB	@ΉDACIZ TERMINATOR
	MOV	#OCTUc,CE1c͟V	#SPACE*400+SPACE,(R2)+	;BLANK FILL
	CMP	#L3U,R2	;TEST FOR END (BEGINNING OF LIN!UFER)
	BNE	11$BWI NDF	!ԩM
	BIT	#LC.TTM,LCMArĻELETYPE MO_	BNE	ENDL5DA NO
+ΉcE	OV	#PRcԧTRc)		;AjHFR FIRST PR3 IELD?
	BEQ	14$"]ANO
	MOV	#OCTPF0,R2	;YES, POINT TO 5CALL	qjWD		;UNPACK INTOƍER
14$:	C*Dws" PF0
	MOV(Fc,R1
	TST	(R1)		;ANYTHING FOR SECON#ILD?
015$		hN
	MOQχTPF1,LCALL	qjWB		;L4  H!YE
	B5o7*400)1S	;TES#O$ΗMDIFICATION
	BE"XI͟VB	#CH.XCL,(R2)."O"
	BIT	#GLBFLG)1SQ	15$͟VB	#LGY)15$:	CLR	(R1)		;CLE4P#E	]1NlLqh	MOV	sԧEQ,R2͟V	#LIӪYR0	;POINT TO CRLNE NU	MOV*)0S+,R1
	CMP	R1,(R0)		;NEW CREF fR TO PUT O0-	;  NO͟V	R1,(R0)		;YES, CLEAR FL1ƊBIT	#LC.SEQ,LCM4wSUPPRŉ?
	BDm$		;  YES
	DNC
	MOV	R2,qhŝD	;MARK HIGHESTѫENCE 16$:	B#SPACRe)+
	sh	2,SEQ	wTHROUGH?
	BLOS	16$		;  NE	]ENDCBfϭ	#OCT,2
	C3&	STERR		;TEST FOH"ҥORS
3g#OCTBm.,R2	tAFOR CONCATԓON
ENDL19:	MOV	LCBERc	;POIT STAR'ALISTILNE
	BT			;EAOVERBfϭ	#OCTBUF,R1	;POINT TO OCT3BFFERBhULIN			;TEST FOR HEADER AND LIST
ENDL20:
	CLRB	@LCBEGL		;DON'T DUPE LINE
	.IF NDF	XLCTTM
	TST	ROLUPD		;FINISHED?
	BEQ	ENDL30		;  YES, DON'T LOOP
	.ENDC
	CALL	PCROLL
	BEQ	ENDL30		;EXIT IF EMPTY
	BIT	#LC.BEX!LC.BIN,LCMASK	;BINARY EXTENSION SUPPRESSED?
	BEQ	ENDL10		;  NO
	BR	ENDL20		;YES, DON'T LIST

ENDL30:	TST	(SP)+		;PRUNE LISTING FLAG
	ZAP	CODROL		;CLEAR THE CODE ROLL
	MOV	CLCLOC,R0
	.IF DF	YPHASE
	SUB	PHAOFF,R0
	.ENDC
	CMP	R0,CLCMAX	;NEW HIGH FOR SECTOR?
	BLOS	31$		;  NO
	MOV	R0,CLCMAX	;YES, SET IT
31$:	RETURN
	.IF NDF	XLCTTM

ENDL50:	MOV	#OCTBUF,R2	;POINT TO START OF BUFFER
	CALL	TSTERR		;SET ERROR FLAGS
	.IF NDF	XLCSEQ
	MOV	#LINNUM,R0
	MOV	(R0)+,R1
	CMP	R1,(R0)
	BEQ	2$
	MOV	R1,(R0)
	BIT	#LC.SEQ,LCMASK
	BNE	2$
	MOV	R2,R4
	DNC
	MOV	#OCTBUF+7,R0
1$:	MOVB	-(R2),-(R0)
	MOVB	#SPACE,(R2)
	CMP	R2,R4
	BHI	1$
	.ENDC
	MOV	#OCTBUF+7,R2
2$:	MOVB	#TAB,(R2)+
	MOV	#PF0,R1
	BIT	#LC.LOC,LCMASK
	BNE	4$
	TST	(R1)
	BEQ	3$
	CALL	SETWRD
3$:	MOVB	#TAB,(R2)+
4$:	CLR	(R1)
	MOV	#PF1,R1
	BIT	#LC.BIN,LCMASK
	BNE	ENDL19
	MOV	#3,R4
5$:	TST	(R1)
	BEQ	6$
	CALL	SETWDB
	BIT	#77*400,(R1)
	BEQ	6$
	MOVB	#CH.XCL,(R2)+
	BIT	#GLBFLG,(R1)
	BEQ	6$
	MOVB	#LET.G,-1(R2)
6$:	MOVB	#TAB,(R2)+
	CLR	(R1)
	DEC	R4
	BEQ	ENDL19
	TST	ROLUPD
	BEQ	6$
	CALL	PCROLL
	BR	5$

	.ENDC
TSTERR:				;TEST AND PROCESS ERRORS
	MOV	ERRBTS,R0	;ANY ERRORS?
	BEQ	TSTER9		;  NO
	ENTOVR	9
	BIC	#ERR.,R0	;YES, ".PRINT"?
	BEQ	4$		;  YES
	INC	ERRCNT		;BUMP ERROR COUNT
4$:	MOV	#ERRMNE-1,R1
1$:	TSTB	(R1)+		;MOVE CHAR PNTR AND CLEAR CARRY
	ROR	ERRBTS		;ROTATE ERROR BITS
	BCC	2$
	MOVB	(R1),(R2)+
	.IF NDF	XCREF
	MOVB	(R1),R0		;FETCH CHARACTER
	TSTR50			;CONVERT TO RAD50
	CALL	MULR50		;LEFT JUSTIFY
	CALL	MULR50
	MOV	R0,SYMBOL	;STORE
	CLR	SYMBOL+2
	MOV	#ERRROL,ROLNDX	;PREPARE TO CREF
	CRFREF			;DO SO
	.ENDC
	BR	1$

2$:	BNE	1$
	XITOVR	INLINE
TSTER9:	RETURN

	ENTSEC	IMPURE
ERRCNT:	.BLKW			;ERROR COUNTER

	ENTSEC	IMPLIN
ERRBTS:	.BLKW			;ERROR FLAGS
	XITSEC

	.IF NDF	XEDCDR
	GENEDT	CDR,,1
	ENTSEC	IMPURE
CDRSAV:	.BLKW			;SAVED CHAR FROM CARD FORMAT
	.ENDC

	XITSEC
	.SBTTL	STATEMENT PROCESSOR

STMNT:
	MOV	CNDWRD,R0	;IN CONDITIONAL?
	BIS	CNDMEX,R0	;  OR MEXIT?
	BNE	40$		;  YES, BRANCH IF SUPPRESSED
	GETSYM
	BEQ	20$
	CMP	R5,#CH.COL	; ":"
	BEQ	LABEL
	CMP	R5,#CH.EQU	; "="
	BNE	1$		;  NO
	JMP	ASGMT		;YES, PROCESS IT

1$:	.IF NDF	XMACRO
	MSRCH
	BEQ	2$
	CRFREF
	JMP	MACROC		;MACRO CALL
	.ENDC

2$:	OSRCH
	BEQ	30$
	CRFREF
10$:	JMP	PROPC		;PROCESS OP CODE
20$:
	.IF NDF	XEDLSB
	MOV	#10.,R2		;NOT SYMBOL, PERHAPS LOCAL SYMBOL?
	CVTNUM
	BEQ	30$		;  NO
	CMP	R5,#CH.DOL	;NUMBER, TERMINATED BY "$"?
	BNE	30$		;  NO
	GETNB
	CMP	R5,#CH.COL
	BNE	30$
	MOV	CLCLOC,R0
	SUB	LSYBAS,R0	;COMPUTE LOCAL OFFSET
	BIT	#177400,R0	;IN RANGE
	BEQ	21$		;  YES
	ERROR	A		;NO, ERROR
21$:	LSRCH			;YES, DO A LOCAL SYMBOL SEARCH
	BR	LABELF		;EXIT THROUGH LABEL PROCESSOR
	.ENDC

30$:	SETSYM			;RESET CHAR POINTER AND FLAGS
	TSTB	CTTBL(R5)
	BLE	42$		;NULL IF END OF LINE
	MOV	#WRDSYM,R1	;NEITHER, FUDGE ".WORD" DIRECTIVE
	MOV	#SYMBOL,R2
	CALL	XMIT4		;MOVE PST ENTRY TO "SYMBOL"
	BR	10$

40$:	CALL	SETCLI		;UNSAT CONDITIONAL, TEST DIRECTIVE
	BMI	41$		;  BRANCH IF EOF
	BIT	#DFLCND,R0	;CONDITIONAL?
	BNE	10$		;  YES, PROCESS IT
	BIS	#LC.CND,LCFLAG	;MARK AS UNSAT CONDITIONAL
41$:	CLR	R5
42$:	RETURN			;IGNORE LINE
SETCLI:
	ENTOVR	5
1$:	GETSYM			;TRY FOR SYMBOL
	.IF NDF	XEDLSB
	BNE	3$		;BRANCH IF FOUND
	BITB	#CT.NUM,CTTBL(R5)	;PERHAPS A LOCAL?
	BEQ	5$		;  NO
2$:	GETCHR			;PERHAPS, TEST NEXT
	BITB	#CT.ALP!CT.NUM,CTTBL(R5)	;ALPHA/NUMERIC?
	BNE	2$		;  YES, TRY AGAIN
	SETNB			;NO, BYPASS ANY BLANKS
	.IFF
	BEQ	5$		;  EXIT IF NO SYMBOL
	.ENDC
3$:	CMP	R5,#CH.EQU	;ASSIGNMENT (=)?
	BEQ	5$		;  YES, IGNORE THIS LINE
	CMP	R5,#CH.COL	;LABEL (:)?
	BNE	4$		;  NO
	GETNB			;YES, BYPASS COLON
	BR	1$		;  AND CONTINUE

4$:	OSRCH			;TRY FOR OP-CODE
	MOV	MODE,R0		;MODE TO R0
	BPL	6$		;BRANCH IF DIRECTIVE
5$:	CLR	R0		;FALSE
6$:	RETURN

	XITOVR
LABEL:				;LABEL PROCESSOR
	.ENABL	LSB
	CMP	SYMBOL,R50DOT	;PERIOD?
	BEQ	4$		;  YES, ERROR
	.IF NDF	XEDLSB
	CALL	LSBSET		;FLAG START OF NEW LOCAL SYMBOL BLOCK
	.ENDC
	SSRCH			;NO, SEARCH THE SYMBOL TABLE
	CRFDEF
LABELF:	SETXPR			;SET EXPRESSION REGISTERS
	BIT	#DEFFLG,(R3)	;ALREADY DEFINED?
	BNE	1$		;  YES
	MOV	CLCFGS,R0	;NO, GET CURRENT LOCATION CHARACTERISTICS
	BIC	#377-<RELFLG>,R0	;CLEAR ALL BUT RELOCATION FLAG
	BIS	#DEFFLG!LBLFLG,R0	;FLAG AS LABEL
	BIS	R0,(R3)		;SET MODE
	MOV	CLCLOC,(R4)	;  AND CURRENT LOCATION
	BR	3$		;INSERT

1$:	BIT	#LBLFLG,(R3)	;DEFINED, AS LABEL?
	BEQ	2$		;  NO, INVALID
	CMP	CLCLOC,(R4)	;HAS ANYBODY MOVED?
	BNE	2$		;  YES
	CMPB	CLCSEC,(R2)	;SAME SECTOR?
	BEQ	3$		;  YES, OK
2$:	ERROR	P		;NO, FLAG ERROR
	BIS	#MDFFLG,(R3)	;FLAG AS MULTIPLY DEFINED
3$:	INSERT			;INSERT/UPDATE
	SETPF0			;BE SURE TO PRINT LOpjI#ILD
	BR	5$

4$:	ERS	
5$:1ԝB			;BYPASS COLON
	MOV	CHRPNT,LBLEND	;MARK EO LABEL
	BRJMP	STMNT"]ԥY FOR MORE

	.DSABL	LSB
	.SBTTL	ASSIGNMEN(RCESSOR

4ͩ:
	ENTOVR	2
	GETNB"DYPASS "="
	MOV	#SYMBOL+4,R1	;qj IX-MASTER REGISTER
	MOV	-(R1),-(SP)	;ST0堧YMBOL͟V	-(R*V-QSP)
4̋XP			;GET NON-EXTERNAL EXӧION
3g(SP)+,(R1)+	;RESTORE SYMBOL
	MOV	(tY(R1)+ӏMTF:	SETPF1			;SET LISTIN#ILD
	SETXPR			;SET EXPRESrgAREGISTERS
	BIT(ҥ.U,ERRBTS	;ANY EINED'oƊBNE	3$		;  YES,'OT DEF3	BIS	q"ƍLG,(R3)	;FLAG AS DEFINED
	MOV*)3S,-(SP)	;NO, STACK VALUE
	MOV	(R4),-(SP)
	SSRCH			;SEARCH SYMBOL TABLE
	MOV	(SP)+,(R4)	;QiԟRE VALUE
	BIC	#^C<GLBFLGRg)
	BIS	(SP)+,(Lԍ	CMP	(R1),R50DO]͋SSING WITH$EAߍ01$		;,ŧɝSERT			;INSERT kALUE
	BR	3$
LR:CMPB	)YCLCSEC	;SAME SEu'E	2$		;  NES	MOV	)Ys!̟C	;YES, SET NEW'ÃTION
	BR	3$

2$:	ERROR3Fg$:	CRFDEFBiEؓTOVRCBTTL	OP COPPOCESSOR

PROPn	;PROCESS OP COFMOV	#EYR4	;PgTATO MOFMOV	(M1		;LkEARESUL$AR1
	s)	QR4)+	.ũ'APOINT'ALUEBfϭ	#CLCᬥ2	;PO3 2 TO ION CgTCE	5c00000q#LEV,R1.ACODE EEN DIQaԓ_01$		;'O	BIT(جQR2)		vbY CURRL EVENE	DI"]A1i2gC).OY MAKEj VEN
1iRR	B		hAD FLA"ҥcT	#DFMYR1	;B5"ODE D4é5BaE	2$		hN
	INbaYMOD		vbY SET  2$:		1		;OaωE?
	Sdc0$		;,ŧ͟TRi),-(S
DO, DIQaԓW0R(R4)	.̋4Vb	CLR	LĉwSTARTԑ R3=0ʛPOVR	)W		;GO'ROPER ΉLER
񢘰IBfϭ(7o776,PtΩ	;LIS&OATION IRST DAONLYBiԇODE		.ԫFF BAraALUEBWI NDF	E
	MOЄc,CRFD;SET J REF M4ťS
	.1F	SWABi1	BIC(طo600,R"]Ùi 1 RDER RjSBfϭ4PCLAS.E CLAtƊ4	#E	sc"]ƟUR BYiER TAS"NTRYBḁ+TS"DAAu'СER
		PJTBLlRc),-(S
DTACK qaϝ ҏE	11$"]¥ANCH 1TO ARGcE	ST	(S
U;ONE 4APRUNE"қ3ԟCE1c$:	MOgЕ(*VRc	;SET$EAFIRSTiGMENTBaE	14$	.R 'OAARGSLY$u	MOV	LV-QSP)	;pkEAA COP('ATHE AQƊSWAB	)	;SHICUNT T)IHT HARaG-۴a0,R1	riϙATE LBFAG			;s̓ TESTÙBi0.UCTIONǓu"BaL	OPJPi1)	;C3& ROPERթINE
+Ʃ
	ROå#LW1	;MOVE SEsDAb̉BWEƊ13$:	4	0		;ScTARESULT
	DECB	(SP)		;COUN$ASP, RH
	BGE	13$
	ROR	R0"]׋ΩEATOO MANY
	MOV	ROLBAS+CODROL,R1
	B4a,6(R1)	;SET EXPQiӓON BIƊTST	(SP)+		;PRUNE WORK ENTRY
14$:	MOV	(SP)+,LDET NEAG FRO)ԃrƊBNE	12$		;T·H IF  ERMINATORCE	]1NlZRR
		OLBAS+CODROL,R1͟[(*VRa	;SET FOR V RROR TESTS͟V	R0,LFRaG0a7,R1
	CMP	#000,,1	;  Sh QJU	BEQ	L0l0o00,R1
	CMQa4020,R1	;  JSR  X,(R*U022$
3gR0,R1
	BIQa0YLD4AARG TYPE 0?
	BDgDA NO, ƊRaG100777,R1BaE,	CMP	#070000,R1	;DOUBLE 1"RSS TYPE?
	BEQ	23$		hN
	MOi0YR1
	RaG170017,R1
	CMP(0a760,R"]AMOV Pk-X(R)BaE,$BaI	#177[#E	MP	#000020w  (R)cE	EQ	21E	MP	#000040w)
	BDg$
21͟V	R0,R1
	S	#E	OL	R1
	SW0c
	SUBi0YR1
	Rj	G000007,R1	;  R1=R2
0E23$
22$:	ERROR6e3$:
+ΉcE4ԫRN
+RO	GENOPJ	NUMBER,SUBLVS+)ՅR2,SCB]ϡċ͡ E
	.GLOBL	OPCL'NUMBER
OPCL'NUMBER=	<.-%TL>/4BWIF NB ¥1>,	.BYTE	SUBR1JAS
	dA B <S1}WBD	.BYTE	SC1+0
+ɍ NB <uaRe>,	.B5"UBR2-%BS
	.IIF  B <SUT>Y	.BYTE	0
+YE	SC2+0
	.ENDM

	SC	DPURE
OPJTBLBD;OP CODE JUMP TABLEBcŝOPJ	00
	GENOPJ	01,	1lPBcŝOPJ	0K	m,	AEXE	ENOPJ	03,	REGEXP
	GENOPJ,,BROPBcŝOPJ	0ҋlPY-	EXP
1ΟPJ	06jRPOP
񢄮F NDF	X45
	GENOPJ	07,	AEXP,	0,	REGEXP,	6
	GЕ	08,	QcűP,	6,	SOBOE	Е	09,	1lPY,	ء,	6
	GENOa,	MARKOP
	GENOPJ	11,	AEXP,	0,1)GXP,	6ǋNOPJ	,	RGEXP,	6,	AEXP,,GENOPJ	13,	SPLOP
	GENOPJ	14,	AEXP,	0,	DRGEXP[	.ENDcEŝIMPLIN
OPCLAS:	.BLKW			;CPC4	XITSEC
OPJBAS:				;INDEX BASE FOR FOLLOWIN)OTINES
	RETURN


REGEXP:				;REG4E EXPRESSION
	ATء			;EfUTE ABSOLUTE
	BIT	#1۷a,R0	;ANY OiFOW?
	BEQ	)w  NOBbҥ	;YES#L"ҥBIC	#-۷o)0;CLEAR OVEQO
1$:	RETURN
PO:				;BRANCH DISPLACEMENT TYPE
	RElP	CMPBiŇTOR,CLCSEC
	BNY$	SUB	CLCLRaBi0	BCS	2$
1"R0
	MOVB	R0,R3		;EXTEND SIGN
	CMP4,3		;PSE?
	BDI		;  1i2$:	ETA
	Ma00377i	0ģc77400	wCLEAR'ӧIBLE cARjSBiEURN

TRAPOP:	"DPh YPE
	ENTOVR	2BiũXPR			;SET EXPRɟ)EISTERcE	OV	(RV-QtwSAVE THE VALUE
	EXPBDw̫5"PEӧION (fLAOK)
2gCBYTMODREAT AS BYTE
	qjIM
	C!	QR2),#L	wABSOLUTE?
	BNE	1$		;  NO
	TSTS)+		;YES, ΋AcE	OV	(RVRa		;VALUE TO MERGE
	RETURE1$:	ZAP	CODROL	.̋AR COPRLL
	u!ωE			;STORE ADDRESS
	MOV	lX0a00,(R3)	;SET FOH §OLUTEԋ
	SW0P)
		QSP)+,);SET ǓONAL VALUE
	STCODE
	CLR4	RETUSXITOVCE.IF Ni5

DRGEXP:			.OBLE RөER EXӧION
0̙	REGEXP		;̫ATE NORMAL
	MOV	#17۴YR3	;T OR OVLW
	BBfKR3
υOP:		"]ӟB OPEPjO
	CALL	BROP		;FREE-LOAD  RANCHEATOR
	MOVB	R0,R0		;EXTEND SIGN
	NEG	R0		;POSITIVE FOR BACKWARDS
	BR	MASKB6		;MASK TO SIX BITS

SPLOP:				;SPL TYPE
	ABSEXP
	MOV	#177770,R3	;ONLY THREE BITS ALLOWED
	BR	MASKR3

MARKOP:				;MARK OPERATOR
	ABSEXP			;EVALUATE ABSOLUTE
MASKB6:	MOV	#177700,R3	;SET TO MASK HIGH ORDER
MASKR3:	BIT	R3,R0		;OVERFLOW?
	BEQ	1$		;  NO
	ERROR	T		;YES, FLAG TRUNCATION ERROR
	BIC	R3,R0		;CLEAR EXCESS
1$:	RETURN

	.ENDC
AEXP:	SAVREG			;ADDRESS EXPRESSION EVALUATION
	SETXPR			;  AND SET "EXPRESSION" TYPE
	INC	EXPFLG
	CLR	-(SP)		;ACCUMULATE ON TOP OF STACK
AEXP02:	CHSCAN	AEXTBL		;TEST FOR OPERATOR
	BEQ	AEXP22		;  NO
	JMP	(R0)		;YES, GO TO IT

	ENTSEC	DPURE
AEXTBL:				;ADDRESS EXPRESSION TABLE
	GCHTBL	CH.IND,	AEXP03	;  "@"
	GCHTBL	CH.HSH,	AEXP06	;  "#"
	GCHTBL	CH.SUB,	AEXP10	;  "-"
	GCHTBL	CH.LP,	AEXP12	;  "("
	.WORD	0		;TERMINATOR
	XITSEC

AEXP03:	TST	(SP)		;"@", SECOND TIME AROUND?
	BEQ	4$		;  NO
	ERROR	Q		;  YES
4$:	BIS	#AM.DEF,(SP)	;SET IT
	BR	AEXP02

AEXP06:				;LITERAL (#)
	.IF NDF	XFLTG
	CMP	#OPCL11,OPCLAS	;CLASS 11?
	BNE	8$		;  NO
	CALL	FLTG1W		;YES, TRY FOR ONE-WORD FLOATING
	BNE	9$		;BRANCH IF OK
	.ENDC
8$:	GLBEXP			;EVALUATE EXPRESSION
9$:	BIS	#AM.IMM,(SP)	;SET BITS
	BR	AEXP32		;USE COMMON EXIT

AEXP10:				;AUTO-DECREMENT (-)
	CMP	R5,#CH.LP	;FOLLOWED BY "("?
	BNE	AEXP20		;  NOT A CHANCE
	CALL	AEXPLP		;PROCESS PARENS
	BIS	#AM.DEC,(SP)
	BR	AEXP36

AEXP12:				; "("
	CALL	AEXPL1		;EVALUATE REGISTER
	CMP	R5,#CH.ADD	;AUTO-INCREMENT (+)?
	BNE	14$		;  NO
	GETNB			;YES, POLISH IT OFF
	BIS	#AM.INC,(SP)	;SET BITS
	BR	AEXP36

14$:	BIT	#AM.DEF,(SP)	;INDIRECT SEEN?
	BNE	16$		;  YES
	BIS	#AM.DEF,(SP)	;NO, SET BIT
	BR	AEXP36

16$:	CLR	(R3)		;MODE
	CLR	(R4)		;  AND VALUE
	BR	AEXP30
AEXP20:	SETSYM			;AUTO-DEC FAILURE, POINT TO -
AEXP22:	GLBEXP			;GET AN EXPRESSION
	CMP	R5,#CH.LP	;INDEXED?
	BEQ	24$		;  YES
	BIT	#REGFLG,(R3)	;FLAGS
	BNE	AEXP36
	.IF NDF	XEDPIC!XEDAMA
	TST	(SP)
	BNE	23$
	.IF NDF	XEDPIC
	BIT	#ED.PIC,EDMASK
	BNE	1$
	BIT	#GLBFLG,(R3)
	BNE	2$
	CMPB	(R2),CLCSEC
	BEQ	23$
	BR	2$
1$:
	.ENDC
	.IF NDF	XEDAMA
	BIT	#ED.AMA,EDMASK	;ABSOLUTE MODE REQUESTED?
	BNE	23$		;  NO
	.ENDC
2$:	BIS	#AM.IMM!AM.DEF,(SP)	;OK, SET ABS MODE
	BR	AEXP32
	.ENDC

23$:	BIS	#AM.REL,(SP)	;NO
	SETDSP			;SET DISPLACEMENT
	BR	AEXP34

24$:	BIT	#REGFLG,(R3)	;FLAGS
	BEQ	26$
	ERROR	R
	BIC	#REGFLG,(R3)	;FLAGS
26$:	MOV	(R1)+,-(SP)	;STACK CURRENT VALUE
	MOV	(R1)+,-(SP)
	MOV	(R1)+,-(SP)
	MOV	(R1)+,-(SP)
	CALL	AEXPLP		;PROCESS INDEX
	MOV	(SP)+,-(R1)	;RESTORE
	MOV	(SP)+,-(R1)
	MOV	(SP)+,-(R1)
	MOV	(SP)+,-(R1)
AEXP30:	BIS	R0,(SP)
	BIS	#AM.NDX,(SP)
AEXP32:	SETIMM
AEXP34:	STCODE
	CLR	R0
AEXP36:	BIS	(SP)+,R0
	RETURN
AEXPLP:				;AEXP PAREN PROCESSOR
	GETNB			;BYPASS PAREN
AEXPL1:	CALL	REGEXP		;GET A REGISTER EXPRESSION
	CMP	R5,#CH.RP	;HAPPY ENDING ")"?
	BNE	1$		;  NO
	JMP	GETNB		;YES, BYPASS AND EXIT

1$:	ERROR	Q		;NO
	RETURN

	.IF NDF	XEDAMA
	GENEDT	AMA,,1		;ABSOLUTE MODE ADDRESSING
	.ENDC
	.IF NDF	XEDPIC
	GENEDT	PIC,,1		;PIC MODE
	.ENDC
	.SBTTL	EXPRESSION TO CODE-ROLL CONVERSIONS

SETIMM:				;SET IMMEDIATE MODE
	SAVREG			;SAVE REGISTERS
	SETXPR			;  AND SET "EXPRESSION" TYPE
	MOV	#IMMMOD,R1	;SET TABLE INDEX
	TST	ENDFLG		;SPECIAL FOR .END?
	BNE	SETDS1		;  YES
	BITB	#GLBFLG,(R3)	;EXTERNAL?
	BNE	SETDS3		;  YES, USE COMMON HANDLER
	CMPB	(R1)+,(R1)+	;MOVE INDEX
	BITB	#RELFLG,(R3)	;RELOCATABLE?
	BEQ	SETDSX		;  NO, ALL SET
	TSTB	(R1)+
	CMPB	(R2),CLCSEC	;YES, CURRENT SECTOR?
	BEQ	SETDSX		;  YES
	BR	SETDS1		;NO


SETDSP:				;SET DISPLACEMENT MODE
	SAVREG			;SAVE REGISTERS
	SETXPR			;  AND SET "EXPRESSION" TYPE
	MOV	#DSPMOD,R1	;SET INDEX
	BITB	#GLBFLG,(R3)	;EXTERNAL?
	BNE	SETDS3		;  YES, TEST FOR ADDITIVE
	CMPB	(R1)+,(R1)+
	CMPB	(R2),CLCSEC	;CURRENT SECTOR?
	BEQ	SETDS2		;  YES
	TSTB	(R1)+
	TSTB	(R2)		;LOOKING AT ABSOLUTE?
	BEQ	SETDSX		;  YES
SETDS1:	TSTB	(R1)+
	CLR	R0		;CLEAR HIGH ORDER
	BISB	(R2),R0		;SET SECTOR
	IMULI	RS.SEC*2,R0	;MULTIPLY BY BYTES/BLOCK
	ADD	ROLBAS+SECROL,R0	;COMPUTE BASE OF SECTOR ROLL
	MOV	(R0)+,SYMBOL	;XFER SECTOR NAME TO SYMBOL
	MOV	(R0)+,SYMBOL+2
	BR	SETDSX
SETDS2:	MOVB	ROLSIZ+CODROL+1,R0	;GET CODE ROLL ENTRY NUMBER
	INC	R0
	ASL	R0		;MAKE IT 4 OR 6
	ADD	CLCLOC,R0
	.IIF DF YPHASE,	SUB	PHAOFF,R0
	SUB	R0,(R4)
	CLR	MODE
	BR	SETDSX

SETDS3:	TST	(R4)		;EXTERNAL, ANY OFFSET?
	BEQ	SETDSX		;  NO
	TSTB	(R1)+		;YES, ADVANCE INDEX
SETDSX:
	.IF NDF	XEDPIC
	BIT	#ED.PIC,EDMASK
	BNE	12$
	TSTB	(R1)
	BEQ	12$
	CMPB	(R2),CLCSEC
	BEQ	10$
	CMP	R1,#DSPMOD
	BHIS	11$
	BR	12$

10$:	CMP	R1,#DSPMOD
	BHIS	12$
11$:	ERROR	R
12$:
	.ENDC
	MOVB	(R1),(R2)	;FILL IN TYPE
	TST	BYTMOD		;IN BYTE MODE?
	BEQ	4$		;  NO
	TSTB	(R4)+		;MOVE TO HIGH BYTE OF "VALUE"
	MOVB	(R4),R0		;ANY HIGH ORDER BITES?
	BEQ	1$		;  NO, OK
	INC	R0		;YES, ALL ONES?
	BNE	2$		;  NO, YOU LOSE
1$:	CMPB	(R2),#RLDT01	;ERROR IF RLD hEA#E	EQ	2$
	CMPB	(R2),#R*1k	;  OH	BNE	3$
2$:	ABSERR			;FLAG ERROR
3$:	CLRB	)	BISB	#200,(R2)	;FL1A BYTE
4$:	RETURN


	ENTSEC	TXTBYT

IMMM	]BYTE	RLDT0KҙDT05,	RLDT00,	RLDT01iLT15,	0

DSPMOD:	.BYTE	RLDT04iLT06,	RLDT00,	RLDT03,	RLDT16,	0

	ENTSEbd͡LIN
VjMD:	.B	;BYT&ωE IF NON-ZERO
	XITSEC
+©TL	DIQaԓVES

	SETOVR	3

	.GLOBL	GLOBL
':				qOAL HANDLER
1$:	GSARG			;j  SYMBOL
	BEQ	3$		;  ENDBiӥCH			;NO, SEARC*ӋR SYMBOL TABLEBaI	#REG#LAGS	;REGISTER?E	2$	. ES, ET	BIS	#GLBFLG,FLAGS	;NO, FLAG 4GOBL
	INSERT			;UPDATE/INSERT
	CRFDEF
	BR	1$

2$:	ERROR	R
	BR	1$

3$:	RETURN


	OL	END

END:				;TEMP EN"IECTIVE
	EXPR		.փLUATE THE EXPREtϝ
	BNE	1$	. PgCc ON-NU3QR4)		;NULL, MAK$AA ONE
1$:	RELTu;NO GAS ALLOWED
	INC1gDƊSETIMM			;fLAj LOCKBiũ	;LIST FIELD 1Bfϭ	#SYMBOL,R1
	MOV	#ENDVEC	JMP	XMIT4"]͟PTgDAVECTOCE	ENTSEC	IMiEENDVEC:	.BLKW	DND VECTOR STORAF	ENTqaCTPRGɝC	ENDam	;DEF5fTATO NOgDAVECTOCE	XITSƊXITOVCEO`ӋCT,	Cqa
	S'֥	3
Aqau
	CAӋTMAX	.̋AN UPҥ O
	MOi5aABS,S3aO	;SET BS."Bfϭ4TղYSYMBO	BR	Cqaԍ		;US!ϛMON Ej
CSEu0̙4ԛ6ws"h ET SEC	GETS3D;GET 4՛ENT (NtéF:	SC3ӋCROL	.ÃN FOR`ԇE	DI		;  T·H IF jC
	MOЄҟLSIZ+*ŇROL,SO	;NEWY SET qaԟR
	BDI"]¥3AIF ABh)ŇTOR  ABaI	#REL#"I	NSERT"DTTACH'OLL
i	ETPF1åFREFBfϭ	#SYMS,1
	MA
	.I'D	XEDLpCALL	dk
	JMfSSET		tANEW LASYMBO!AE
	.1	JMP	dk		;MOPAD EXIE	]ENDCCE	]IF DF6hHSE
	OL	PHAqV	EPHAT$AE:	RElPBa͡BiŇTOR,CŇX	MOV4,HAOFFӫBȧᬡgƍ͟V	R0,s!̟C
	R*ҝ

1ťS	ҋiNCEDPHA:	ua	HAOFFCOC
	s)	HAOFFҋiNCE	NTSEC2fСAS
Pgƍ:	.BLuƊXITSEcE	]ENDCCE	ITOVRSrgIu1gTVR	3Bfϭ4TSMBOL	tA". ABk	MOV	MXAS+2,S3aOlpfLCSECTDOVE O'OLL
0RSYMBODITTO  LANK té
	CLBiٛBOL+2񢄮F NDF6"ăTƊRj	GED.ABk"ěASK	;0"BaN	CSECw  NOBiE+ƍ
	BR0ŇgD

	c DF	XEaS	GEN*	BS,SErgIY1
	.CBlIOVR
SETM6	"]Ӌ&gDAE ONTO̙
	ENR3
	SAVREG			;PLAY IT SAFE	OV	#CLCNAM,R1
	MOV	#SYMBReÃ؛IT2		;MOVE NAME TO SYMBOL
	SCAN	SEt	;SCAN SECTOR R&	CALL6&ɩ3		;SET REMAINDER OF ENTRIES
	JMP	INSERT		;U ԋ ROLLgDAEXITBlI

	.GLOBfIIT
BiũOVR	9
LIM5	3&	RM
	CLBTRi)		;CLEAR VALUE͟QҙU400,-(R4)	tARLD TYPE
4CDE
	s)	QM2STCODE
	XITOVR	]GLOBL5$ԙӅTTL,	1"Ω񢆊qjOR	9
TITLECE	ETSYM			;GET A SYMBOE	DI		;  O IF NULL
1iRB`4ԫS1$:	MOV	R0,PRG&	wEAINTO u'҃FMOV	SYMBOLlP*LW2
	CALL	SETSYM		;POINT T)ԃRT OF TITLE
	MOV	#T!U,R2	;Ω TO BE
	CLRB	(R2)+		tASTOPPe$:	MOЄk,(R2)"]өiATER
0iw  BRANCH I"Ή
	TS2)+
1ԇHR			;GET "*	CMP	L#TLBU2DND OF BUFF0O2$		;  NOL:MOV	#&B2,R1	tADESTINATION REG
4$:3gօ	-(R2),-(R1)	;MHARACi E	DI
	MOЄF,(R1)	;SET PAGE EJEu	1,TTLQcwiKAQcɝgG	CLR	R5		;NO "Q" ERRORS
	RETURN

	XIR	SER2

pT:				;SUB-TITLE$ҋCTIVE͟V	#STYLgTATO SUB-TITLE BUѢ	TST4 ӧ		;PAtOE?
	Qhe$		;  YES
1$:	BR5,(R2)+	;EACHARACTER IN
	BEQ	1iw  BRANCH IF ENDǋTCHR			;GET THE NEXTAACTER
	CMP	R2,#STLBө"[1	;TEuFH"Ή
	BLX	TSTB	-(R2)		;POLISH OFF$΋
	BR,R
2$:0s!LMASKBaN	13$BjSB	LLTS̧T.L	;ANY LISTING DEVICE?
	BEQ	13$		;  NO, EX5MOV	#ԱT,R1
	MOVVj	.ũ TABL'AsT)	CALL	SETS3DwPOINT TO ".SBTTL"
3$:	GETR50	"]ǋT RAD6a CHART	3$		;STOP AT iS TERMINATOR
	MOV	CHRPNT,R2	;SET POINTER
	.I'D	XLCSF	3U,R0
	CALL	10$
	MOVB	#CHY)2S񢄮FF
	MOVB	#TAB,-(R2)
	.ENDC
	MOV	PAGNUM,R0BaL	10$
	MOVB	#SPACE,-(R2)
	MOV	R2,LFJMP	PUTLP		;OUTj T

,:MOV	#3,R4
11$:	MOVB(ЃCE,-(R2)
3gR0,R1
	BE"XI
	CLBi0BbI	#^D1)0B`ĉ(I.0,R1͟Єc,(R2)
12$Biυ	R4,11$
13$:	R*ҝ
	XITOVR

	ENTSEC	TXTBYT
TOCTXTBWACIZ	/aL OF CONTENTS/
6$ԧEC
	SETOԄCEI:			;IDENT iETIVE
	CALL	RAD50		;TREAT AS RAD50Bḁ	ROLUwPOINT'TART CDE-ROMOV	#ɉN,R2	hA*OA1"Ω BLOCcE1I:	NEXaωROL		qAlTA5"	MOV	VALUE,(R2*ĻEAIT
	CMP	R2,#PRbNW4	;PROCESSED TW+ϥߍ	BLO	)w  NOBfϭ(ӉT06,(R2)+	;YES, SET  4"6sRDLEAR sEAROLLBiEURN
6$ԟVR

	ENTSEC	I*ҋ
PRG&:.BLKW-RGIDN:	.BLKW	4		;IDENT BLOCK
6$ԧEC
	.GLOSХ3,O

	qjOR	9

	.ENABL	LSB

PRI	ERROR	<>		;NUL"ҥOR (DACOUNT#E	R	1$

ERROR:	ERROR	P
1ӋTPF0			;PRINT LԓON FI"	EXPR"DVALUAPEPRESS3	BEQ	IwBRANCH IF NULL
	SETPF1		.O-NULL&IT VALFe$:	REiN
	.DSABL	LSBCE	.GLOSҋM

Qf			; KE" DIRECTIVE	OV	R5,R3		;SET TERMIjIG CHAPaԋR
	BDI		;BR3AIF NOgUL
	ETA		;ETY NO DELIMITING CHARACTERBiEURN
񢘤u	GETCHR			;GET THE NEXT CHARACTER
2$:	TST	R5		;END OF LINE?
	BNE	3$		;  NO
	CALL	ENDLIN		;YES, POLISH OFF LINE
	CALL	GETLIN		;GET NEXT LINE
	BEQ	2$		;LOOP IF NO EOF
	RETURN			;EOF, EXIT

3$:	CMP	R5,R3		;IS THIS THE TERMINATOR?
	BNE	1$		;  NO
	JMP	GETNB		;YES, BYPASS AND EXIT

	XITOVR
	.GLOBL	BLKW,	BLKB,	EVEN,	ODD,	RADIX,	EOT

	SETOVR	3

BLKW:	INC	R3		;FLAG WORD TYPE
BLKB:	EXPR			;EVALUATE THE EXPRESSION
	BNE	1$		;BRANCH IF NON-NULL
	INC	(R4)		;NULL, MAKE IT ONE
1$:	ABSTST			;MUST BE ABSOLUTE
2$:	ADD	R0,(R2)		;UPDATE PC
	ASR	R3		;WORD?
	BCS	2$		;  YES, DOUBLE VALUE
	RETURN

EVEN:	INC	(R2)		;INCREMENT THE PC
	BIC	#1,(R2)		;CLEAR IF NO CARRY
	RETURN

ODD:	BIS	#1,(R2)		;SET LOW ORDER PC BYTE
EOT:	RETURN

RADIX:	MOV	CRADIX,R2	;SAVE IN CASE OF FAILURE
	MOV	#10.,CRADIX
	ABSEXP
	CMP	R0,#2.
	BLT	1$
	CMP	R0,#10.
	BLE	2$
1$:	ERROR	A
	MOV	R2,R0
2$:	MOV	R0,CRADIX
	JMP	SETPF1

	ENTSEC	IMPPAS		;IMPURE AREA
CRADIX:	.BLKW			;CURRENT RADIX

	ENTSEC	XCTPAS		;TO BE EXECUTED EACH PASS
	MOV	#8.,CRADIX	;INIT TO OCTAL RADIX

	XITSEC			;BACK TO NORMAL


	XITOVR
	.SBTTL		DATA-GENERATING DIRECTIVES

	.GLOBL	BYTE,	WORD

	SETOVR	3

WORD:	INC	R3		;"WORD" DIRECTIVE, SET TO 2
BYTE:
	INC	R3		;"BYTE" DIRECTIVE, SET TO 1
	MOV	(R2),-(SP)	;STACK CURRENT PC
1$:	TSTARG			;TEST FOR ARGUMENT
	BEQ	2$		;  END
	EXPR			;PROCESS GENERAL EXPRESSION
	SETIMM			;CONVERT TO OBJECT FORMAT
	STCODE			;PUT ON CODE ROLL
	ADD	R3,(R2)		;UPDATE PC
	BR	1$		;TEST FOR MORE

2$:	MOV	(SP)+,(R2)	;RESTORE INITIAL PC
DGTEST:	TSTB	ROLSIZ+CODROL+1	;ANY CODE GENERATED?
	BNE	1$		;  YES
	CLR	MODE		;NO, STORE A ZERO
	CLR	VALUE
	SETIMM
	STCODE
1$:	RETURN
	XITOVR
	.GLOBL	RAD50,	ASCII,	ASCIZ

	SETOVR	3

ASCIZ:	INC	R3		;  ".ASCIZ", SET TO  1
ASCII:	INC	R3		;  ".ASCII", SET TO  0
RAD50:
	DEC	R3		;  ".RAD50", SET TO -1
	CALL	23$		;INIT REGS
1$:	MOV	R5,R2		;SET TERMINATOR
	BEQ	28$		;ERROR IF EOL
2$:	CMP	R5,#CH.LAB	; "<", EXPRESSION?
	BEQ	10$		;  YES
3$:	GETCHR			;NO, GET NEXT CHAR
	MOV	R5,R0		;SET IN WORK REGISTER
	BEQ	28$		;ERROR IF EOL
	CMP	R5,R2		;TERMINATOR?
	BEQ	5$		;  YES
	TST	R3		;NO
	BMI	9$		;BRANCH IF RAD50
	.IF NDF	XEDLC
	MOV	CHRPNT,R0	;FAKE FOR OVLAY PIC
	MOVB	(R0),R0		;FETCH POSSIBLE LOWER CASE
	BIC	#177600,R0	;CLEAR POSSIBLE SIGN BIT
	.ENDC
	BR	4$

9$:	TSTR50			;TEST RADIX 50
4$:	CALL	20$		;PROCESS THE ITEM
	BR	3$		;BACK FOR ANOTHER

5$:	GETNB			;BYPASS TERMINATOR
6$:	TSTB	CTTBL(R5)	;EOL OR COMMENT?
	BGT	1$		;  NO
7$:	CLR	R0		;YES, PREPARE TO CLEAN UP
	TST	R3		;TEST MODE
	BEQ	24$		;NORMAL EXIT IF .ASCII
	BPL	20$		;ONE ZERO BYTE IF .ASCIZ
	TST	R1		;.RAD50, ANYTHING IN PROGRESS?
	BEQ	29$		;  NO, NORMAL EXIT
	CALL	20$		;YES, PROCESS
	BR	6$		;LOOP UNTIL WORD COMPLETED

10$:	MOV	(R4),-(SP)	;"<EXPRESSION>", SAVE PARTIAL
	ABSTRM			;ABSOLUTE TERM, SETTING R0
	MOV	(SP)+,(R4)	;RESTORE PARTIAL
	CALL	20$		;PROCESS BYTE
	BR	6$		;TEST FOR END
20$:	TST	R3		;RAD50?
	BPL	22$		;  NO
	CMP	R0,#50		;YES, WITHIN RANGE?
	BLO	21$		;  YES
	ERROR	T		;NO, ERROR
21$:	MOV	R0,-(SP)	;SAVE CURRENT CHAR
	MOV	(R4),R0		;GET PARTIAL
	CALL	MULR50		;MULTIPLY
	ADD	(SP)+,R0	;ADD IN CURRENT
	MOV	R0,(R4)		;SAVE
	INC	R1		;BUMP COUNT
	CMP	R1,#3		;WORD COMPLETE?
	BNE	24$		;  NO
22$:	MOV	R0,(R4)		;STUFF IN VALUE
	SETIMM			;CONVERT TO OBJ MODE
	STCODE			;STOW IT
23$:	CLR	R1		;CLEAR LOOP COUNT
	CLR	(R4)		;  AND VALUE
24$:	RETURN

28$:	ERROR	A
29$:	BR	DGTEST		;TEST FOR DATA PROCESSED
	XITOVR
	.IF NDF	XFLTG

	.GLOBL	FLT2,	FLT4

	SETOVR	3

FLT4:	INC	R3
FLT2:
	INC	R3		;MAKE IT 1 OR 2
	ASL	R3		;NOW 2 OR 4
1$:	TSTARG
	BEQ	DGTEST
	MOV	FLTPNT-2(R3),-(SP)	;EVALUATE NUMBER
	CALL	@(SP)+
	BNE	2$		;BRANCH IF NON-NULL
	ERROR	A		;  NULL, FLAG ERROR
2$:	MOV	R3,R2		;GET A WORKING COUNT
	MOV	#FLTBUF,R1	;POINT TO FLOATING POINT BUFFER
3$:	MOV	(R1)+,(R4)	;MOVE IN NEXT NUMBER
	STCODE			;PLACE ON CODE ROLL
	SOB	R2,3$		;LOOP ON WORD COUNT
	BR	1$		;CONTINUE

	ENTSEC	DPURE
FLTPNT:	.WORD	FLTG2W,	FLTG4W
	XITSEC

	.IF NDF	XEDFPT
	GENEDT	FPT,,1		;FLOATING POINT TRUNCATION
	.ENDC

	XITOVR
FLTG4W:	INC	FLTWDC		;FLOATING POINT NUMBER EVALUATOR
FLTG2W:	INC	FLTWDC
FLTG1W:
	ENTOVR	7
	SAVREG			;SAVE REGISTERS
	MOV	CHRPNT,-(SP)	;STACK CURRENT CHARACTER POINTER
	MOV	#FLTBUF,R3	;CONVENIENT COPY OF POINTERS
	MOV	#FLTSAV,R4	;  TO BUFFER AND SAVE AREA
	MOV	R4,R1
1$:	CLR	-(R1)		;INIT VARIABLES
	CMP	R1,#FLTBEG
	BHI	1$		;LOOP UNTIL DONE
	MOV	#65.,FLTBEX	;INIT BINARY EXPONENT
	CMP	#CH.ADD,R5	;  "+"?
	BEQ	10$		;  YES, BYPASS AND IGNORE
	CMP	#CH.SUB,R5	; "-"?
	BNE	11$		;  NO
	MOV	#100000,FLTSGN	;YES, SET SIGN AND BYPASS CHAR
10$:	GETCHR			;GET THE NEXT CHARACTER
11$:	BITB	#CT.NUM,CTTBL(R5)	;NUMERIC?
	BEQ	20$		;  NO
	BIT	#174000,(R3)	;NUMERIC, ROOM FOR MULTIPLICATION?
	BEQ	12$		;  YES
	INC	FLTEXP		;NO, COMPENSATE FOR THE SNUB
	BR	13$

12$:	CALL	FLTM50		;MULTIPLY BY 5
	CALL	FLS.ϥRECTION, MAKE THAT *,SUB	#ca,R5	;MAKE ABSOLUTE
	MOV	R4,R2		;POINT TO END UFFER
	ADD	R5,-(R2).ĉ IN
	ADC	-(R2)		;RIPPLE CARRY
	ADC	-(R2)
	1![(R2)
13$:0bDFLTDOT,FLTEXP	;DECREgTAIF PROCESSING FRACTION
	CLR	(t;CLEAR INITIAL CHAR POINTER (WE'RE GOOD)¥	10$	.R FOR E
20ÛP	#CH.DOT,R5	;DECIMAL POI	BNE	LR	;  NO
	COM	FLTDOT		;YES, MARK IT
010$		s'ϡ IF FIRST TIME AROUND
21ÛP	#LET.E,R5	;EXPONENT?
	SLTG3		;  NO
	G'B		;YES, BYPASS QQ ND BL3	MOV	CRADIX,-(twSTACKҥENT R1$	MOV	#10.,CRADIX	;SET TO DECIf	ABSTRM			;ABSOLUTE TERM
	MOV	(SP)+,CRADIX	;RESTORE RADIX
	ADD	R0,FLTEXP	;UPDATE EXPONENE;BR	FLTG3		;FALL THROUGH
T3:	MOV	R3,R1
		QR1)+,R0	;TEST FZRO
	BIS	(LTYLRiQR1)+,LRiQR1)+,R0
	BEQ	F#ű		;EXIT IF SO
lR:TST	F"ء		;TIME TO SCALE	DƙTG5		;FINIc 	BLT	R	q$֓DE IF .LT. ZEROÛP	(R3),#031426	;MULTIPLY,AWE *5?
	BDeDA	CALL1T50		;YES, fTPLY BY 5
	INC	*BX		;  AND BY TWE	R	33$񢆊g2$:	C3&	LTM54"]ͫLTIPL(!YA5/4
0bD#3.,F!E	;  AB 8
3i	ƙlP	;  Oi c0
	BBYI

4		EC	FL	;DIV4ϝ, LEF%UcYARjS	CALcLGLS
R:TST	(Lԉ;SIGNAqj?BaP	40$	. O, LOMOV	#-*e,-(SP"]m OUTEK2A3EÃƙS.ȓRGHT
0̙	FLTGuwPLACEg AVE BE2IBaI	#1,(t;ODD h?	BNE-. ƊCALL	*GS		;M COUPPO BITSǑT
	C3&	LTGRS3I:	CALcLGRS		sCgҋ'HE RI*	CALL1T1w1" N SAV!Ui1"(SP)	.Ή OF L?	BGT-$	;  NE	ST	(S
U;YES,)UE STArƊua	GkFTBEXBd·	FLTEBR	31ELTG5:1"FLTBEDEFT JIT
	C3&	LTGLSC	FLTDwLOSE 󢠅IT
	1"	G200,F!E	;SETlCSS 12BLE	2DRANCHc NDER-'BjSBcLBEX+1.I'҉ZRO?
03$		;,ŧ$u1iRBg	sAERROR񢙤u	MOV	MRe		;SE*OAr$ƩdǑ!IcE	OV	R2	TST	)1S		;R1iNE LOi g CE4I:	CMP+TRc),-(RJDOWN OPWRD
	B(R1),);MOVEh ԋӯAB	(RJDwQk'ATHE Iċ-OUT С	CMP4,3		;E0ECALL	*GS		;ScTAONE PaARIGHTҟR	(R4"DET HICRRY
+ANDF	X#P
	BIQŉѨTY&K	;TRION?BaE-	hYS
	.C	MOV1TRe.ũ SIZE՝E	se		;DOE	BNE.	;PRESTPE
	32		;S3̋҉
8$:	ASL	LwsVUTԋcE	IS	#0۷o,FLTBRe)
	SEC
5$:	ADC	FLTBUF(RJFDEC	R2
	DEC	R2
	BGE	5$BjS*)3S"]ԋST SIGN POSITION
	BPL	7$		;OK IF PԓVE
6$:	ERROR	T񢛤u	ADD	*SN,(R3)	;SET SIGN, IF ANY
FLTGEX:	CLR	MODE		;eAABSOL"	CLR	*WbDLEAR COUNT͟V	(R3++AUE	;PLACE iSA3VLUE
3g(SP)+,R0	;ORIGIAr AΩER
	BEQ	1DERO (GOOD)c NY DIjSAËt	MOV	R0,CHRPNT.OE, REqj +ȋRE WE͋g0RR3		;FLAG 4FLSE
1$:	MOV	R3,R0		tA AIN R0ʛP	SETNB		;QjU+ɩ'OAK
FLTM54:				jiÛP	(R3+iش;ROOM?
	BıIÃLL	FLTGRS
	INC	FLTBEX
1ÃLL	FLTGSV		;SAVE IN Pa˫P
	C3&	LTGRS"]ӇALE RIGHT
	CALcLGRS
0	LTGAD񢆊LTM50BDj0̙	FLTGupfLFLTGLS
	C3&	LTGLS񢆊LTGADBD;ADD SAVE UcFH*OAFLTBUE	OV	R4	;POINT TO pkEA41$:	ADD	6)Y-(R2).ĉ IN W	MOV	R2,R1		;SET FORҥIES
2$:	ADC	-(LT;ADD 3PeDONTINPRPPLE, IF NECESSARY
0LRg		;THSǑE	DI"]ANO
	RETURN
FLTGRS:	CLC			;RIGHT SHIFT͟V	R3,LDwRIGHTԃTE
	ROR	(R1)+BiO	(R1)cE	OR	(R*U4W
	RETURN

FLSu				;cTASHIFT͟V	R4,LASL	-(R2)
	ROL+TRe)
	ROL	-(L	ROL	-(R2)
	RETURNCEFTGSV:	MOV	R3,R1"]͟VE FLTBUF TO FLTSAVBfϭ	R4,R2
	JMP	XMIT4
񢆊SC	IMP*BG:			.ԃRT OF FLOATING POINT IMPUQFLTSGNBWBKW			tǝQTOT:	.S%		;DErf POIN#LG
FLTEXP:	.BLKW			;DECIMAL EXPONENT
FLTBEX:+LW	1		p΃RY EXPONENMuPECEEDT*BF:	.BLKW	4"]̓IN AC
FLTSAV:	.BLKW	4

	ENTqaMPLINLWDC:	ЦK			;WORD COUNTCE	ITSEC

	XITOVR

	.ENDC
	.SBTTL	CONDITIOfS
	.'2dCE	ETOVR	5

IIF:				;IMMED0jEAgD	CALL	TCON		;TEST ARGUMENT
	TST	R3
	BMI	3$	. RANCH IF UNSATISFIED
	CMP	#CH.COM,MDOMMA?
	BNE	1$	. O
	G!ȥ			;YES, BYPASS
1$:3gCHRPNT,R1	t֋ CURRENT LԓON
	qjN"DET TO[S ΗT	#LCDYK	;CONDITIASUPPRESSION?
	Qhe$		;  NO
	MOV	R1,LCBEGL	;YES, SUPPQiAALL U*OACOMMA
2$:	CLR	4ÝT
	JMP	ST	p×'TATEMENT
񢙤u	CLR	R5		;FALSE, BUT NO "Q" ERROR
0	NDCXCE				;sCTENATCNDITI̧
	.ITG,	<E+#YL*,E,G,L,,DF,N	.GLOSɍiGRc'RG:
	.ENDM

3gvfL+2,SYMBOL	;TRE5SCOND HALF AS ARfŝE	ALL	TsF	;EXAgEA5BR	IF1		;INTO THE MA3SQ`CE+̟Sɍ,	IFTdƍ,	IFTŝDC
Rc:			;MICRO-PROGR3f͋D CONjINAL
0̙	TCON		;TEST ARGUMENT
IF1:	MOQÝDLVL,R1	;PgTALf	CMP	Y#15.	;ROOM FOR ANOTHER?
0IFOERR		;  NO, O
	INbTRc)		;Y UMP LEVEL
	ASL	R3		;SET piR TO TRUE (0) OR̧E (1)ҟR	-(R*DwROTAT$ΩO CND	ASL	LƊROR	-(R1)		;DITTO FOR CND	BR	E!IFTBD;IF TUbUB-CONDITIONALBfϭ	CNDMrRg	;GETҥENT
0	FTF		;  AN!RNCH

IFF:				;IF F3)ASUB-CIIONAL͟V	CND嬥3	;GE!եRENT sDTIONBaϛ	R3		;USE COMPLEMENT AND fLATHROUIFTF:				;UNCONDITIONAL SUB-CONDITIONAL
				;(R3=0 WHEN CALLED DIRECTLY)
	TST	CNDLVL		;CONDITIONAL IN PROGRESS?
	BLE	IFOERR		;  NO, ERROR
	ASL	CNDWRD		;MOVE OFF CURRENT FLAG
	ASL	R3		;SET CARRY
	ROR	CNDWRD		;MOV ON
	BR	ENDCX

ENDC:				;END OF CONDITIONAL
	MOV	#CNDLVL,R1	;POINT TO LEVEL
	TST	(R1)		;IN CONDITIONAL?
	BLE	IFOERR		;  NO, ERROR
	DEC	(R1)		;YES, DECREMENT
	ASL	-(R1)		;REDUCE MASK
	ASL	-(R1)		;  AND TEST WORD
ENDCX:	BIT	#LC.CND,LCMASK	;SUPPRESSION REQUESTED?
	BEQ	2$		;  NO
	MOV	LBLEND,R0	;YES, ANY LABEL?
	BEQ	1$		;  NO, SUPPRESS WHOLE LINE
	MOV	R0,LCENDL	;YES, LIST ONLY LABEL
	BR	2$

1$:	BIS	#LC.CND,LCFLAG	;MARK CONDITIONAL
2$:	RETURN

IFOERR:	ERROR	O		;CONDITION ERROR
	RETURN
TCON:				;TEST CONDITION
	GSARG			;GET A SYMBOL
TCONF:	SCANW	CNDROL		;SCAN FOR ARGUMENT
	BEQ	IFAERR		;  ERROR IF NOT FOUND
	MOV	SYMBOL+2,R1	;GET ADDRESS
	ASR	R1		;LOW BIT USED FOR TOGGLE FLAG
	SBC	R3		;R3 GOES TO -1 IF ODD
	ASL	R1		;BACK TO NORMAL (AND EVEN)
	TST	CNDWRD		;ALREADY UNSAT?
	BNE	IFAERX		;  YES, JUST EXIT
	TSTARG			;BYPASS COMMA
	JMPOVR	R1		;JUMP TO HANDLER

IFAERR:	ERROR	A
IFAERX:	CLR	R5		;NO "Q" ERROR
	RETURN

	XITOVR


	GENCND	EQ,	TCONEQ
	GENCND	NE,	TCONEQ,	F
	GENCND	Z,	TCONEQ
	GENCND	NZ,	TCONEQ,	F
	GENCND	GT,	TCONGT
	GENCND	LE,	TCONGT,	F
	GENCND	G,	TCONGT
	GENCND	LT,	TCONLT
	GENCND	GE,	TCONLT,	F
	GENCND	L,	TCONLT
	GENCND	DF,	TCONDF
	GENCND	NDF,	TCONDF,	F
	SETOVR	5

TCONEQ:	ABSEXP			;EQ/NE, TEST EXPRESSION
	BEQ	TCONTR		;BRANCH IF SAT
TCONFA:	COM	R3		;  FALSE, TOGGLE
TCONTR:	RETURN			;TRUE, JUST EXIT

TCONGT:	ABSEXP
	BGT	TCONTR
	BR	TCONFA

TCONLT:	ABSEXP
	BLT	TCONTR
	BR	TCONFA

TCONDF:				;IF/IDF
	MOV	R3,R1		;SAVE INITIAL CONDITION
	CLR	R2		;SET "&"
	CLR	R3		;START OFF TRUE
1$:	GETSYM			;GET A SYMBOL
	BEQ	IFAERR		;  ERROR IF NOT A SYM
	SSRCH			;SEARCH USER SYMBOL TABLE
	CRFREF
	CLR	R0		;ASSUME DEFINED
	BIT	#DEFFLG,MODE	;GOOD GUESS?
	BNE	2$		;  YES
	COM	R0		;NO, TOGGLE
2$:	CMP	R0,R3		;YES, MATCH?
	BEQ	3$		;  YES, ALL SET
	MOV	R2,R3		;  NO
	COM	R3
3$:	MOV	R1,R2		;ASSUME "&"
	CMP	R5,#CH.AND	; "&"
	BEQ	4$		;  BRANCH IF GOOD GUESS
	CMP	R5,#CH.IOR	;PERHAPS OR?
	BNE	5$		;  NO
	COM	R2		;YES, TOGGLE MODE
4$:	GETNB			;BYPASS OP
	BR	1$		;TRY AGAIN

5$:	TST	R1		;IFDF?
	BEQ	6$		;  YES
	COM	R3		;NO, TOGGLE
6$:	RETURN

	ENTSEC	IMPPAS
				;CONDITIONAL STORAGE (MUST BE ORDERED)
CNDWRD:	.BLKW			;TEST WORD
CNDMSK:	.BLKW			;CONDITION MASK
CNDLVL:	.BLKW			;NESTING LEVEL
CNDMEX:	.BLKW			;MEXIT FLAG
	XITSEC

	XITOVR
	.SBTTL	LISTING CONTROL

	.GLOBL	NLIST,	LIST

	SETOVR	2
NLIST:	COM	R3		;MAKE R3 -1
LIST:
	ASL	R3		;MAKE R3 0/-2
	INC	R3		;NOW 1/-1
1$:	TSTARG			;TEST FOR ANOTHER ARGUMENT
	BNE	2$		;  VALID
	TST	ARGCNT		;NULL, FIRST?
	BNE	7$		;  NO, WE'RE THROUGH
	INC	ARGCNT		;YES, MARK IT
2$:	GETSYM			;TRY FOR A SYMBOL
	SCANW	LCDROL		;LOOK IT UP IN THE TABLE
	BEQ	6$		;  ERROR IF NOT FOUND
	CLR	R2
	SEC
3$:	ROL	R2
	SOB	R0,3$
	TST	CSIFLG		;CALLED FROM COMMAND STRING?
	BEQ	11$		;  NO
	BIS	R2,LCMCSI	;YES, SET DISABLE BITS
	BR	12$		;  AND SKIP TEST

11$:	BIT	R2,LCMCSI	;THIS FLAG OFF LIMITS?
	BNE	5$		;  YES
12$:	BIC	R2,LCMASK
	BIT	R2,#LC.		;NULL?
	BEQ	4$		;  NO
	ADD	R3,LCLVL	;YES, UPDATE LEVEL COUNT
	CALL	PAGEX		;SET LISTING CONTROL
4$:	TST	R3
	BPL	5$		;.LIST, BRANCH
	BIS	R2,LCMASK
5$:	BR	1$		;TRY FOR MORE

6$:	ERROR	A
7$:	RETURN

	GENSWT	LI,LIST		;GENERATE /LI
	GENSWT	NL,NLIST	;  AND /NL SWITCH ENTRIES

	.GLOBL	PAGE
PAGE:	INC	FFCNT		;SIMULATE FF AFTER THIS LINE
PAGEX:	BIS	#LC.LD,LCFLAG	;FLAG AS LISTING DIRECTIVE
	RETURN

	XITOVR
	.MACRO	GENLCT	MNE,INIT	;GENERATE LISTING CONTROL TABLE
LC.'MNE=	1
	.REPT	<.-LCTBAS>/2
LC.'MNE=	LC.'MNE+LC.'MNE
	.ENDR
	.GLOBL	LC.'MNE
	.RAD50	/MNE/
	.IF NB	<INIT>
	LCINIT=	LCINIT+LC.'MNE
	.ENDC
	.ENDM

LCINIT=	0

	ENTSEC	DPURE
LCTBAS:
	GENLCT	SEQ
	GENLCT	LOC
	GENLCT	BIN
	GENLCT	SRC
	GENLCT	COM
	GENLCT	BEX
	GENLCT	MD
	GENLCT	MC
	GENLCT	ME ,1
	GENLCT	MEB,1
	GENLCT	CND
	GENLCT	LD ,1
	GENLCT	TTM
	GENLCT	TOC
	GENLCT	SYM
	GENLCT	<   >		;NULL
LCTTOP:


	ENTSEC	IMPURE
LCSAVE:				;LISTING CONTROL SAVE BLOCK
LCMASK:	.BLKW			;MASK BITS
LCLVL:	.BLKW			;LEVEL COUNT
LCMCSI:	.BLKW			;COMMAND STRING STORAGE
LCSAVL=	.-LCSAVE

LCSBAK:	.BLKW	LCSAVL/2	;FOR INITTING PASS 2


	ENTSEC	IMPLIN
LCFLAG:	.BLKW			;FLAG BITS
LCBEGL:	.BLKW			;POINTER TO START OF LINE
LCENDL:	.BLKW			;POINTER TO END OF LINE
LBLEND:	.BLKW			;END OF LABEL (FOR PARSING)

	ENTSEC	XCTPRG
	.GLOBL	LCBITS
	.BLKW	1
LCBITS:
	.BLKW	-1
	MOV	#LCINIT,LCSBAK+<LCMASK-LCSAVE>	;DEFAULT FLAGS

	ENTSEC	XCTPAS		;EXECUTE THIS CODE EACH PASS
	MOV	#LCSBAK,R1	;RESET LISTING FLAGS
	MOV	#LCSAVE,R2
	CALL	XMIT0-LCSAVL

	XITSEC
	.SBTTL	ENABL/DSABL FUNCTIONS

	.GLOBL	ENABL,	DSABL

	SETOVR	2
DSABL:	COM	R3		;R3=-1
ENABL:				;R3=0
1$:	GSARG			;GET A SYMBOLIC ARGUMENT
	BEQ	8$		;END IF N&4W	EDTROL		;SEARCH TH*ALE
	Qho$		;  NOT THERE, ERROR
	CLR	R2		;COMPUTE BIT'ӓTION
	SEC
2$:	ROL	LSOB	R0,2$
	TST	CSIFLG		;CALLED FROM COMMAND u)IG?
	BEQ	3DA NO
	BIS	R2,EDMCSI	vbY SET DISABLE BITS
	BR	4$		;  3 YPASS TEST

3$:	BIT	R2,EDMCSI	;OVER-RI"AFROM t	BNE,R	;  YEkINORE IT
4$:	BIC	R2,EDMASb]Ο, CLE4SLECTED BIT
	TST	R3		;ENDBLE?
	BEQ-R	;  YEkLAVE IT CLEAR
	BIS	R2,EDM4wNO, CLEAR IT
5$:	MOV	SYMS+e,-(SP)	;MAKE IT$	TST	R3		;SET  ǧ
	CAQSP)+		;CALL ROUgE	BR	)7$:	O	A
8$:	RETURN
	XITOVR


	SC	IMPURE
EDMASK:	.BLKW			;CONTAINS SET FLAGS
EDMCSI:	.BLKW			;BITS FOR CSI OVERRIDE
EDMPe.BLKW			;TO RE-INIT FOR P4e

	ENTSEC	XCT	.GLOBL	EDBITSBWBKW	1
EDBI+LV	MOV(ēj,DMBAK	;SET DEFA* ONDITIONS

	E)Ň	XCTP4ƊMOV	EDMBAK,EDMArĻECH PASS
BlIqa

	gSbYENABL	;GENERATE	GENSWT	DS,DSABL	;  AND )WITCH TABL"ΩRbCBTTL	tӧ REFERENCE ΉLERS

	.IF NDlCEF

CRFLEN=	1l		;CRE!UFER Lԑ

CKE=	001o0c*400>"]ԳPE 1,ҧION ##EC.PAG=,2"]΋(AE
CR${	003	"]΋W LINEC.SYM=,0		;SY	GENu	K!ҍqj
ERRS=1			;fͳ ROLLҍSET:	"DQc jC PROCϥ
	ENR9
	TuÛDBUF	.ASOURCƊQhmDAbYiRCE1IBcӃRG			u)YAFOR AQ͋NT
	Qhg$		; Γr"BiÃNW	CRԧ	;SCA)OL FORj0w  NOT$EE, ERS	MOV	lVRe
2$:0iR2
	s	0,2$BaI	R2,RbDCCUMUjEA ǧ¥	1$
񢙤u	TST	Lĉw3Q	BNE-	hYcE	OV	#^lX,3	;   LL BUPE
4$:3gR3,CRѦG;SAVEA
	REiNCE5IBa͡	SYMB(C)+	;ǟ SWITr	.RADG/
	Sm$		; AERRORɝC	CRF	;YES,͡ FLAG¥	1$
$u	ERROB`	RETUS	ENTqaPUREPFAS:
+ҡC	ARGЇE	]Pb5a	/ARGE	]MPFOP:
6$ԧEC
	jOCEQEBd·BaҍDFL		pE DEFIjIN
CRԢu"DwtAQcE	TST0FNT		;3REF O(U AT Ti3bBaE	9$		hN
	SAԢ	MOV0FNT,R2.RSET BE POINi5)tVR		;Vɟ'UQi ENT Y	BNE	)w  YES͟V	#CRբYLF	1,CRFi	wSET Fc	CALL0FST		;iAAND D'ӓT
	Sa	1
	M	1,(R2*ĻTUFF iSN1$:	sh	RFPAG ǝDPGE?
0I	2$		hN͟Qå.PAG,LD  LAG
0̙	CRFTuINC	CQA
	CLBaҍLIN
0	cE2$:	CMP	CR$YgN]΋&I'UBER?BaHS	3$	. O
	MOV	#CR.LIN,R1
	CALL0FST
	INC	CRFLIN
	BR	2$
񢙤u3gpFYP,R1
	MOV	CRFFLG,R0
4$:	ASR	R0
0Ѕ	ROLNDX,(R1)+	;h OLL NaE TO CREF TYPE
	BNE	4$
	ASR	R0
	BCC	8$
	SUBQåFTYP++a]SYM,R#E	3&	RFTST
	R5gP5$:	shB#SPACE,-(RJDRfPd̓NG BL3	BEQ	5$
	TSTB*)2ScE	åFDFL,R1	;S"G" BIT
	BP[$	;BRA 'OAJ	BIS	#2,R1
6$:0#CR.S3VRc.ũ TERM3ԟCE		1,(R2)+
8͟V	R2,CRFPNT	;STORE NP3E
9$:0R	CRFDFL
	QjUEQSBD;TEST FOR ROOM 3 EABYTEBa͡(ҍBUF+CRFLENY,B]ҟOM TO STORE A FEW?
	BHI	)w  YES
	CALL	CRFDMP	.OY DUMPҥENT
3g#CRFBUF,R2	;STAUNW LINE1I:	MOVBi1Y(R2)+.ԟQPT!YE
	R*ҝ񢆊RFDMP:				q*͡ CREFƍER
	B#VT,(R2)+	tA	MOV	L-QSP)	;pkEAPOINTER TOgDBfϭ	#CRFBUF,RB]ПINT T)ԃRT
	ua	2,(SP)		;COMPUTE LEN$	MOV	(SP)+,-(R2"]өORE IE	QL;FORM5*E ASCII
	WRITOF	CRFLC"R;AWAI!ϛ"ԓs)	RFPNT		;  AND CLOSE
	RETURN

	ENTSEC	3hUE
CRѦGu	.BLKECFVER:	.BLKW			;iSON FL1ƊRFPAGBWBuƊQI:	.BLKW
CRFPNTBWBKW
CQG:	.BLuĉ;NO-G#LG

CRFHDR:	.Bg
CRFBUF:	ЦK	CRFLEN/2

	ENTSEC2fЙIN
CRFDFL:	.BLp	; "#" AND "*" FLAGS񢆊ENTSEC	TXTBYT
CRFTYЬԋ	SYMRc DF	XM0O	.BYTE	MACROL
	.IFF
	.VjE-1
	gD
	.B5"u)O񢄮YTE	SO
	.B5"RRROL񢆊ENTSEC	DPURE
CRFCSI:	.WORD	CMDBUF,	CRFLNK,	CQI

	SC	MIXED
	҉,RFLNKBWWQBWRD50	/CRF/BWWRD	1
	.RAD50	/SY/

	ENTSEC	3hUE
	.S%2
CRѤu	.BLKW	4

	XI
	.ENDC
	.SBTTL	LISTING STUFF

SETPF0:	"DET PR3 1fDAQiO	MOV	CLCFGS,PF0	;SET CURQgTA3 LAGS
	BISB	#100,PF0+1	;ASSUME WORD
	MOV	CLCᬡF0+2	;SET LOCATION
	RETURN

SETP]			;SET PRINT FI" NE
		ODE,PF1	;SET MODE OFҥENT VALUEBaIB	#100,PF1lDSSUME҉͟V	VALVP*4ԫRN
BbΩqaMPLIN
PF0BWBKW	2
PF1:	.BLKY	XITSEC

SETWDB:				;SET WORD OR VjE	TST*)1S		;POSITIVE?
	SdETBYT		;   5"qjWD:	MOV	R1,)S	;STACK REG
	MOV	2(R1),R1	;GET ACTf ALUEBfϭB	#DI/e,(R2).ũ PRIM5$֋
	ASi1	ROLBTRe*ĉwEAIN BIE	OV	#5	BR	S!Y񢆊!Y:	MOV	R1,-(SP)	tAh$ΉEX
	MOVB	2(R1)wGET VALUE
	MOV(ЃqVRa
	MOЄa,(R2)b]Ѓ+ɩH SPACES
	MOVB	R0,(LBfϭBi0Y)WӯAB	R1"]̓NIPUL5"O LEF$AF
	RORB	R1		;GTE LAS#ճ
	CLcE	OR	R1
	MOV	#3,R0
SETBYX:	SWABi0	ADD	#3,RE		Gca/10,(L1$:	ASL	R1
	ROLB	(R2)
	aR0
	BGT	1$
	Tu!	QR2)+Bi׃B	R0Biυ	R0,SETBYX
	MOV	(SP)+,R1ҋTURN
	.SBTTL	qlARD H3LRS
BbΩSEC	M6"
	.D0
CM'Ku	.WORD	0		;KB OUTPUT LINK񢄮AD50	_
	.W	c
	.R1/KB/

	.WORD	ECILNK:+ϥD	0		r NPUT gK	.RAD50	/sd	.WORD	1
	.RAD50	/p

	SC	IMP
CMIg=83.
͉BUF:	ЦK	7.		p͛AND BUFFER HEADER
CMIHDRBWBKW	3PɅUF:	.BLKW	<CMILEN+1>/2
CMDSAV:	.BLKW	7.
	XITSEC
	.SBTTL	OBJECT CODE HANDLERS

ENDP:				;END OF PASS HANDLER
	ENTOVR	4
	CALL	SETMAX
	CALL	TSTCOR		;TEST CORE SIZE
	TST	PASS		;PASS ONE?
	BEQ	2$
	JMP	EN	;BRANCH IF PASS 2

1$:	CALL	GETLIN		;MOVE TO EOF
2$:	TST	SRCLNK		;FOUND?
	BNE	1$		;  NO
	TST	OBJLNK		;PASS ONE, ANY OBJECT?
	BEQ	ENDP1B		;  NO
	MOV	(PC)+,R5	;ASSUME RELOCATAS"+ABJ/
+A#	EDABS
	BIQŉaSYEDMASb]ǟOD GU	BNE	8$		;  YEcE	OV	(PC)+,R]Ο)ũ FOR 0ϙUTE
	.RAD50	/B3	.ENDC
8$:	OPENO	OBJ		;Og HE FILE
	MOV	#S%a+!LTYP	;qj Ah1A1
	C3&	BJINI		;INIT THE POINTERS
	MOV	#PRGTTL,LDET "FROM" 3E
	MOiLPNT,R2	;  3 E "BaL	GSDDMP		;OUTPUT GS!LrƊc DF	DOu	MOV	t)GDN,R1	;POINT TO SUB-TTL BUFFER
	TST	4(R1)		;SET?
	BEQ	9$		;  NO
	CALL	GSDDMP		;YES, STUFF IT
	.ENDC
9$:	CLR	-(SP)		;INIT FOR SECTOR SCAN
10$:	MOV	(SP)+,ROLUPD	;SET SCAN MARKER
	NEXT	SECROL		;GET THE NEXT SECTOR
	BEQ	ENDP1A		;BRANCH IF THROUGH
	MOV	ROLUPD,-(SP)	;SAVE MARKER
	MOV	#MODE,R1
	MOV	(R1),R5		;SAVE SECTOR
	CLPk		;ISOLATEj44hA(LqPIǑE	0ģC<RELFLG>,(R1)	;CLEAR ALL BUT REL BIT
	BIS	#<GSDT01>+DEFFLG,(R1)+	;SET TO TYPE 1, DEFINED
	MOV	R5,(R1)+	;ASSUME ABS
	BEQ	11$		;  OOPS!
	MOV	(R1),-(R1)	;  REL, SET MAX
11$:	CLR	ROLUPD		;SET FOR INNER SCAN
12$:	MOV	#SYMBOL,R1
	CALL	GSDDMP		;OUTPUT THIS BLOCK
13$:	NEXT	SYMROL		;FETCH THE NEXT SYMBOL
	BEQ	10$		;  FINISHED WITH THIS GUY
	BIT	#GLBFLG,MODE	;GLOBAL?
	BEQ	13$		;  NO
	CMPB	SECTOR,R5	;YES, PROPER SECTOR?
	BNE	13$		;  NO
	BIC	#^C<DEFFLG!RELFLG!GLBFLG>,MODE	;CLEAR MOST
	BIS	#GSDT04,MODE	;SET TYPE 4
	BR	12$		;OUTPUT IT
ENDP1A:	BIC	#^C<RELFLG>,ENDVEC+4	;CLEAR ALL Uj EL FL1ƊBIS	#Ta3+DEFFLG,E+E+4
	MOV	#ENDVEC,R1
	CALL	GSDDMP		;OUTPUT END BLOrƊpfLPCRDMP		;Dh T
	MOV	#BLKT02,BLKTYP	;SET "EO GSD"
	CALL	RLDDMP
	MOV	#BLKT04,BLKTYP	;INIT FOR"ةOKS
E(1:	CLR4̫PD		;SET FOR RE-INIT SCAN
31$:	NEXT	SECS	qATHE NEXT ENTRY
	BEQ	32$		;  BRANCHc INISHED
	s)	ALUE		;FOUND, RESET PC
	3ťT			;PUT BACK I*ALE
	BR	31$

32$:BWIFXRESKB
	PUTKB	qgD3DwEND OF PASlPME1gTEC	TXENDP3]	]ASCIZ	<CR><LF>/ F PASh	XITSEC
+ΉcE	RETUS
GSDDMP:				;DUMP A GSD BLOCK
	Ce,#RLDUc+LDLENX	wROOM  NOTHER?
	BLOS	)w  YES
	CALL	PCRDMP		;NO,*͡ CURRENT
1$:	J؛IT4		sg֋ FOUR҉cE(2u				; (Ah	.IF #	CREFBfϭ0FRe.γ CREF IN PROGRESS?
	BEQ	8$		;  NOBaL	CRFh	;YES, DUMPgDACLOSEƍER
8􎆊gD͟V	#SY,TYR1
	MOV	#STLBUF,R2
	MOVVj		;SET "SYMBOL TABLE"[TITLE
	TST	BLKh	pgYAOBJEC'թPUT?
	BEQ	1$		hN
	CALL	OBQ&.ŧ, DUMP IT
	MOV(LT06,BY	;SET END
	CALL	RLDDMP		q*͡ IT
+ANDF	X §
	BIQŉaSYEDMASK	;ABS OUTPUT?BaN,R	;  NO
	MOV	OBJPNT,RE	ŝDVEC+6,(R0)+	;SED VECTOR
3gR0,OBT'T	CALL	OBJDMP
	.ENDcE1IBjSBfLS̧	w34IG OUTPUT?
	BEQ1gDQw'O	BIT(C]SYM,Ls`ӗ	;SYMBOL T0EASUPPRESSIOƊSNDP2D"]AYES
	CLR	(CDANEW P1	CLR	ROLUPD		;SET FOR SYMS 0EApL:MOV	#LINBUF,R2	;POINT TO STORAGE
3$:	NEXT	SYMROL		;GET THE NEXT SYMBOL
	BEQ	ENDP2A		;  NO MORE
	R50UNP			;UNPACK THE SYMBOL
	MOV	#ENDP2T,R3
	CALL	ENDP2C
	MOV	#MODE,R1	;POINT TO MODE BITS
	BIT	#DEFFLG,(R1)	;DEFINED?
	BEQ	4$		;  NO
	CALL	SETWRD
	BR	6$

4$:	MOV	#STARS,R1
	MOVBYT			;UNDEFINED, SUBSTITUTE ******
6$:	CALL	ENDP2C
	MOV	#SECTOR,R1
	CMPB	#1,(R1)
	BGE	10$
	CMPB	-(R1),-(R1)
	CALL	SETBYT
10$:	MOVB	#TAB,(R2)+	;SEPARATOR
	CMP	R2,#LINBUF+50.	;ENOUGH FOR ONE LINE?
	BLO	3$		;  NO
	CALL	ENDP2B		;OUTPUT LINE
	BR	2$		;NEXT LINE
ENDP2A:	CLR	ROLUPD		;SET FOR SECTOR SCAN
21$:	CALL	ENDP2B		;OUTPUT LINE
	NEXT	SECROL		;GET THE NEXT ENTRY
	BEQ	ENDP2D		;  EXIT IF END OF ROLL
	R50UNP			;PRINT THE NAME,
	MOVB	#TAB,(R2)+
	MOV	#VALUE,R1
	CALL	SETWRD		;  THE VALUE,
	MOVB	#TAB,(R2)+
	MOV	#SECTOR-2,R1
	CALL	SETBYT		;  AND THE ENTRY NUMBER
	BR	21$

ENDP2B:	CLRB	(R2)
	PUTLP	#LINBUF
	MOV	#LINBUF,R2	;RESET TO START OF BUFFER
ENDP2D:	RETURN

ENDP2C:	CALL	31$
31$:	MOV	(R3)+,R0
	BIT	(R3)+,MODE
	BNE	32$
	SWAB	R0
32$:	MOVB	R0,(R2)+
	RETURN

	ENTSEC	DPURE
ENDP2T:
	.ASCII	/ =/
	.WORD	LBLFLG
	.ASCII	/% /
	.WORD	REGFLG
	.ASCII	/R /
	.WORD	RELFLG
	.ASCII	/G /
	.WORD	GLBFLG

	ENTSEC	TXTBYT
STARS:	.ASCIZ	/******/
SYMTXT:	.ASCIZ	/SYMBOL TABLE/
	XITSEC
	XITOVR
	.SBTTL	CODE ROLL HANDLERS

STCODE:	APPEND	CODROL		;APPEND TO CODROL
	RETURN

PCROLL:				;PROCESS CODE ROLL
	NEXT	CODROL		;GET NEXT CODE ROLL ENTRY
	BEQ	PCROL3		;  END
	SAVREG
	CLR	R5		;ASSUME BYTE
	CLR	R4
	BISB	SECTOR,R4	;GET THE RLD TYPE
	BMI	1$		;BRANCH IF BYTE
	INC	R5		;  WORD, BUMP TO 1
1$:	TST	PASS		;PASS ONE?
	BEQ	PCROL2		;  YES, JUST UPDATE PC
	INC	PCRCNT		;EXTENSION LINE?
	BMI	2$		;  YES
	SETPF0			;LIST COLUMN ZERO
2$:	SETPF1			;SET PRINT FIELD ONE
	ASLB	R4		;BYTE?
	TST	BLKTYP		;ANY OBJECT CODE CALLED FOR?
	BEQ	PCROL2		;  NO
	.IF NDF	XEDPNC
	BIT	#ED.PNC,EDMASK	;PUNCH DISABLED?
	BNE	PCROL2		;  YES
	.ENDC
	MOV	PCRTBL(R4),R4	;GET PROPER TABLE ENTRY
	MOV	RLDPNT	wSET PgTR TO S" UFFERÛPB	CLCSEC,OBJSEC	;SECTOR r ΏE?
	Qhc0$		;  NO
	CMP	R2,#RLDBUF+RLDLEN-1]ҟOM INҥENT RLD?
	BLOS	4$		;  YEcE	ALL	PCRDMP		;YES, DUMP CUTΩ BUFFERS
4$:	MLDT07,(R2)+	;SE)L TYPEƊMOV	CLCNAM,(R2)b]AAND NSCTOR f	MOV	CLCNAM+2,(R2)+
	MOVB	CLtYOBJSEC
	BR	12$
10$:	CMP	CLCLOC,OBJLOC	;DID PC MOVE ON US?
	BEQ	14$		;  NO
	CMP	R2,#RLWRLDLEN-4	;ROOM IN CURRENTDABUFFER?
	BLOS	,R	;  YES
	CALL	PtM		;YES, DUCTΩƍER
1)	LDT10,(R2)+
12􎆊.IF DF	YPHASE
3gCLCLOkRe)
	SUB	PHAOFF,)W񢄮FF
	MOV	CO)2S+	;SE'E!	.ENDC
13$:	CAЇRDMP		;DUMP BUFFER
14$:		BJPNT,R0	;j "gTR
	Ak,R0		;COMP"EW END
	CMP	R0BUF+OBJLEN-1	;R	BHI,Y	;  NE	OVB	R)0	;YES#ũ RLD rmE	ADD4,0
	Ca,#RLDUc+&EI	13$"]ANO ROV UMP BE
	MOgPNT,R#E	MP	R1Uc	wiS ITEME	NE	16DA NO
+ANDF	X §Qŉ.ABS,&K	;ABh'թPUT?BaE	15$	. ES
	gD͟Qu3YW.ŧ)ũ BLOCh*YE
15͟V	CLCQR1)+	hA)ԃU$Ώ ADDR16$:	4	4		;APRƊPቡCROL1"]ANO
	BSECTOKRe)+	;Y ET COFMOV	R+)0	SUB(BUF,R]ß*ԋgDX
	M	0,(R2*ƊtcB`ә	R4		pgYAvf)EUESTEƊBCC	2)w  NOBfϭ	SYMB(2)+	;1iAMOVE 5MOV	S3aOl(JU21$:	4	4		;APVLUE?BaC	22$	. O
	MփLUE,(L;YES,g֋ IT
L:MOV	RK)LPNT	;pkEAPOINTMOVB	fU,(R1)cE	ST	R5Q	29$"]¥ANCH 1BTE INu)UgBfϭB	VALUYW9I:	MOV4BJPNT񢆊teBd·4s`ˋ COUNR 2
0bDR5,CLs'uhDPP͟ȧLOC,ORO	;SETѫENCE T
	SE	DTUE REiNPCRO	ETURN񢆊ENTSEbd͡LIN
CT:	.B.ةɟN LIN#LE	5)Ň
PCQ&u
	MOi2YRLDPN]ӋT RLD'ɝi0̙	OBJDMOV	R(N,R2
4ԫRN
BbΩSEC	DiEPCRTS			;TAS"Y RLD,Ћ
	.W	a񢄮	c20004"]ҙDT01BWWQi6	;RLD	.WORXa	tD03
	҉,Z0awRLDT0E	]WORD	-0c0		;R*0k
	.W	c60010"]ҙ6	.WORD	0BWWQBWWQa0	;RLDX	.WORX	.WORD	0
	.WORD	0
	.WORXa010		;RLDT15
	.WORD	1600,wS"TcE
	ENTSEC	IMPPAS
	.ODD
OBJSEC:	.B	c		;OBJECT FILE qaԟR
OBS'u	.BLKW	1		;OBJECT FILE LOCATION


	ENTSEC	PS		;EaթE EAC(AcE	OMB	OBJSEC"]ƟRCE SjŝCE BREAK
6$ԧƊCE	]IF NDlEPNC
	GENEDT	PNk(Nqj	wgC CONTROL
NSET:	MOVB	l۷YOBJSEb]ƟP⠧jŝCE BREAK
	RETUS.ENDCOQ&u				;fA"Ré BUFFER
		GOBJHDR+2,R0
	MOV	#1)0Sb]ƟRMATTBNARY
	MOV3J(
FQhBJINX		;EXIT IF̙
'O INITb)BiՅ	#OBJBUF,(LwsЫTE SIZE
	BEQ	1$		;  BRANrI EMPTY
	WRITOF	OBJLOJHDRLR:CMP	R(N,#RLDBUF+2	;ANY$Ώ IN R	BLOS3JNI		;'OYөgI
RLDh:BWI NDF	XEDABcE	IT	#E§,EDMArĻBS OUTPUT?"gINI		hYS, NOD	.ENDC
		GS"BF,R0
	MOV0KYP,(R
FMOV	R(N,-(R0)
	SUB	#RLDBUF)0S
	MOV	#1,-(R0)ץITOF	Lk)L)
OBJ3MOV	#OBJBUF,OBJPNT
3gtDUF+2,S"PEORgXu4ԫRN


	ENTSEC	IMPURE
OBJPNT:	.BLKW
R(N:	.BLuƊLKTYPBWBKW
	XITSEC
LuK{	1			s$өING T%ųS҉S.L=	2			;LISTIN*OALP
LuK=	LSŢT.L		s$өING TO BOTH
LS{	4			;ERROH"EICE

PUTKBL:	INCB	MD		;LIST TO BOTEPTLP:	INCB	LSTMOD		;L4 O LP
PUTKB:	INCB	LSg.IT TO pT*ԙIN:		"]ϫTPUT A LINE
	SAVREG			;SaAREGISiS	MOVBfS,b]ǋT LOG0AINDEXÙRB	LSg	;CLEAR FOR ABOVE INC'S
	MOVB	LLTBL(R3),R4	;h O PHYra DEVICE
	Qh&Is		;  $A1NASR	R3		;ScTAOUT KB FLAG
	BEQ	PUTLI2		;BRA F NO ɇAL LPċC	LPPCNT		;YES,"åEMENT COUNT
	BGT	PUTLI2		;SKIP IF NOT TIME
1gTVR	8T*ԙ,]	PP,LPPCNT	;RESET COUNT
		+
DTACK CURRENT POINTER
	MOV	TTLEND,R2	;POINT T(AE NUMBER
	TST	PASS
	BEQ	11$
	MOV(SHD1,R1
	MOVBYT"DOVE "cE INTO POSITION
	MOV4 ǝUM,R1
	DNbDwCONVERT TO"ÓMAL
2gCcűT
	BDcE		GCH.ADRe*Ɗc1$:	CLRB	(L	PUTLP	TTLBEG		t)IT TITLE
	PUTLP	#STLBUF		;  SUB-TITV	PUTLQåLF		;  AND A BL3INE
	MOV	)W6$ԟVR	INLINE	.AL THROUGH
PUTLI2:	ASR	LLWAIT		;LIu$Ώ REQU4AIT?BaC	1$		hN
	WA5'LSTLNk&SHDR
)	u!U-2,R2.ũ DEST3ԓON INl0R)W		;SET STOPPERBfϭ4,3		;SAVE A COPY1I:	MOVB	(R1)+,(RJUwEACHARAu"ATO OU*AUcFR
	BGT	21$		;LOOP I'OgGAt"Ó3B-(R2)	wSPECI3 ACK U Ή SET R0
	BEQ	2IwEND I'UL
	.1NF	XEDLC
	BICB	#200,-(R1)	;CLE4SGN BIT IN s҇E	Dc$		;RiԟRE IF LOWER CASE
	MOVB	#rQ,(R1)	;MUST BE O
	.IцMOVB	p.M,-(R1)	;ILLEGAL CHAR, SE?E
	.ENDC
	BR	2)22$:3gօ	-(R2+)0;FETC(RCEDIN!ȃR
	B5!	GCT.SP!CT.TAB,CTTBL(R0)	;BgK
	BNY2I		;  1iATRIM 5CMPB	#VT,(R2)+	sg֋ TO E  VT?BaE	23$	. ES, NO CR/MOVB	#CR,(R2)+	;STUF!	MOVBQ̍,(R2)b]ӋT LFLu	SUB	LRe		;CO*ԋ CHAR0E COUNT
	MOV	R2,-(R3)	;SE!ϫNT
	s)	[(R3)		;CLEAR MODE
	ASR	R4		;KB REQUESTED?
	BCC	2w  NO
	TST	CMOLNK		;YES, DEVICE INITTED?
	BNE	24$		;  ƊgI(͟LNK
24$:	WRITOa͟LNK,LSTHDR	;TYP Ήɩ5IBfϭ	R4,LLWAIT	;LISgGAREQUEu""hULI9		hN
	.WRITE	s)ԙNK,#Lu$D.ғPIULI9:	RETURN
	ENTSEbd͡LLTBL:	.BLKB	5	.O0ATO PH4Ã"E0⠛APPING
LSTMOD:+LB	1		s'ǓCAL L4IG FLAƊLWAITBWBuı.T FLAG

1gT؇)G	INCBfLBL+LSw3ATO KBɝp̙TBL+LST.KLɝCB	LL+uE.E5fTAO"֓CE

	ENTqaXTBYTS.ASCIZ	/ P1_
	XITSEC

WR5'u	.WRITE	(R5),(R5)+	;WRITE A LIF2jO:	.WA5Uuɩ ON O(UQӅ.EOM*,(R5)+	;EOME	NE	1$"]A1iAERROR
	RTS	R5

1$:	FINk	INTB3		;NO, CLOSE PARTIALӋT202		;BOMB OUT
	ENTSEC	PG
	CALL	SETHDR"]ßME HEQPA STAR'Aǥ3FjSC

qjHR:				;INI*H"BѢBbΩOVR	9
	MOV	#SETHD1,CHRPNT	;PRETEND⧥E LOOKING AT REAL LINE
	qjCR
	CALL	TITLE		;SET TITL ΉƍMOV	#TTLBU2,R2	;POINT TO CONSTANT AREA
	MOVB	#TAB,(R2)+
	MOV	#HELLO+2,R1
	MOVBYT			;DITTO FOR VERSION #
	.IF NDF	DOSV4
	.CVTDT	#0,R2		;CONVERT THE DATE
	ADD	#9.,R2		;MOVE PAS)ԟQb 5"	MOVB	#SPACE,(RJU	.CVTDT	#1	hAD TIME
	ADD	#5.,R2
	.ENDC
	MOV	RK*T	RETURN

	ENTSEC	TXTBYT
SETHD1:	.ASCIZ	/.MAIN./	;DEFAULT TITLE

TTLLEN=	32.			;TITLE LENGTH

STLLEN=	64.			;SUB-TITLE LENGTH
	ENTSEC	IMPURE
TTLBUF:	.BLKB	1+TTLLE]ԓ"AETLBU2:	.BLKB	44.		;DATE, PAGE #, ETC.
	.U*LEG:	.BLKW			;TITLE BΝ3TTLEND:	.BLKW			;TITLE END

	ENTSEC	IMPPAS
STLBUF:	.BLKB	STLLEN+1	;SUB-TITLE BUFFER
	.EVEN

	XITSEC

	XITOVR
DNC:				;DECIMAL NUMBER CONVERSION
	MOV	#10.,R3		;SET DIVISOR
DNCF:				;ENTRY FOR OTHER THAN DECIMAL
	CLR	R0
	DIV	R3,R0		;kI)1	MOV	R1,-(SP)	;SAVE REMAINDER
	MOV	R0,R1		;SET FOR NEXT DIVIDE
	BEQ	1$		;  UNiAQiO	CALL	DNCF		;RECURSE
1$:	MOV	(SP)+,R1	;RETR1kEANUMBER
	ADD	#DIG.0,R1	;CONVERT TO ASCII
	MOVB	R1,(R2)+	;STORE
	RETURN


R50UNP:				;Pb k0 UNPACK ROUTINE	OV	R4TS)	;SAVE REG
	MOV	#SYMBOL,R4	;POINT TO SYMBOLOAGE
1$:	MOV	(R4)+,R1	;GET NEXT WORE	OV	#50*50,R3	;SDVISOR
	CALL	10$		;DIVIDE AND STUFF IT
	MOV	#50,R3
	CALL	10$		;AGAIN FOR NEXT
	MOV	R1,R0
	CALL	11$		;FINISH LAST GUY
	CMP	R4,#SYMBOL+4	;THROUGH?
	BNE	1$		;  NO
	MOV	(SP)+,R4	;YES, RESTORE REGISTER
	RETURN


10$:	CLR	R0
	DIV	R3,R0
11$:	TST	R0		;SPACE?
	BEQ	23$		;  YES
	CMP	R0,#33		;TEST MIDDLE
	BLT	22$		;ALPHA
	BEQ	21$		;DOLLAR
	ADD	#22-11,R0	;DOT OR DOLLAR
21$:	ADD	#11-100,R0
22$:	ADD	#100-40,R0
23$:	ADD	#40,R0
	MOVB	R0,(R2)+	;STUFF IT
	RETURN
	.SBTTL2WABUFFERS

	ENTSEC	DPURE
SRCCSI:	.WORD	CMDBUӥCLNK,	SRCFIL

	ENTSEC	I*ҋ
	.BLKW	1
SRCLNK:	ЦK	4

SRCH	]S%3
SRCBUF:	.BLKW	SRCLEN/2+2

	.BLKW	2TC3	]BLKW	4

	ENTSEC	DP
LSTCSI:	.WORD0ąUF,	LSTLNK,	LSTFIL
CSI:	.WORD	CMDBUF,	OBJLNK,	OBJFIL

	ENTSEC	IMPURE

	.BLKW	1
LSTLNni

LSTHDR:	.BLuĳS)ԅ	]BLKW	<OCTL̓"}앱
	.S%2
LSu	.BLKW	4

	.BLKW	1.BLKW	4

OBJHDR:	.S%3
OBJBUF:	.BLKgLEN/2


	.BLKW	2
OBJFIL:	.BLKW	4

OCTBUF:
OCTERP:	.BLKB	0Sԧ]	]BLKB	2
OCTPF0:+LB[P1:	.BLKB	OCTLEN-CTBUF>
LINBUF:	.BLKfIg/e
LINEND:	.BLKW,FRLDHDR:	.BLKW	3
RLu+LW	RLDLEN/2

	XITSEC
	.SBTTL	EXPRESSION EVALUATOR

EXPR:				qlPɟN EVALUATION
	pkRDwSAVE REGISiS	TERDwTRY FOR A TERMBaE	5$		;EXIT IF NULL
	CLR	-(SP)		;NON-NULL, SET REGISTER FLAG STORAGE
1$:	SETXPR			;SET EXPRESS3 өERS
	BIS	(R3),(SP)	t֋ REGISTER FLAG
	CHSCAN	BOPTBL		;SCAN TH!IARY OPERATOR TABLE
	BEQ	2$		;  BRANCH IF NOT՝E	ALL	10$		;FOUND!$ADLER
	BR	1$		;iAFOR MORE

2$:	BIC	kXEGFLG,(SP)	;MASh ̙AQcɧTER FLAG
	BEQ	6$		;T·H IF NOT REGISTBIT	#177770,(R4)	;IN՝ߍ	BNE	7$		;  NO,iRCE6I:	ASR	RELLVL		;TEST RELOCATON LEVEL
	BNE	3$	.RNCH IF NOT 0 ORFBCC	4$		;BRANCHc aԧT	(SP)		;RELOCATABLE*E)EISTER FLAG"Z$.RNCH IF NOTM:O	R		;REL ARES	CLR	(SP)	.̋4RGISTER BIT
	BR	4$

3$:1iRR	A		;IMPROPER RELOCATION
4$:	BIS	)W)3S	;MERGE REGISTEH!IӋ	0		;SET TRUE
5ҋTURN

10$:	ENTOVR	E	a,-(SP)	;ST0堟PERATOR ADDRESS
	MOV	R1,Lĉw`֋ POINTER TO "SYMBOL" IN R3
	MOV	(R*U[(SP)	tAK SYMBOL
	MOV	(R1)+,-(SP)
	MOV	(R1)+,-(SP)	hMDE,
	MOV	WTS)	;  VALUE,
	MOV	(R1)+,-(SP)	;  AND REL LEVEE	LBTRM			;EVALUATE NEXT TERN
	MOV	#EXPBAK+^D1)1tATO UNSTACK PREVIOUS
	MOV	(SP)+,-(R*DLf	MOV	(SP)+,-(R1)	;VAb	MOV	R1,R2		;R2'ɝT PREVIOUS fU͟TS)+,-(R1)	;MODEBfϭ*)S+,-(R1)
	MOV	(tY-(R1)	;R1 POINTS TO ֓OUS SYMBOL
	ASBTS)		;ABSOLUTE ONLY?
	BCS	12$		;  NO
	BIS	-(RJV-QMw1iAMERGE FLAGS
	ATS"DEST FOR ABSOLUTE	MP	(R2)+,(R4)+	;RESTORE RөERS
12$:	ASL	(t;EVEN OUT ADDRESS
	JMPOVR	(SP)+		;EXIT THROUHNDLER

	ENTSEC	IMPURE
(BK:	.BLKW	5"]ХEVIOUS TERM STORAGE
	XITqa	ENTSEC	DPURE
BOPTS	"]NARY OP TABLE
1ȩBL	CH.ADD,	BOPADD+1	; "+"ǇHTBL	CH.SUB,	BOPSUB+1	; "-"
	GCHTBL	CH.f,BOPMU]E*"
	TL	CH.k,BOPDIV	; "/"
	GCHTBL	CH.3,BOPAN]E&"
	GCHTBL	CH.IOR,	BOPIOR	; "!"
	҉	0
	jSC

BOPSUB:	RELTST			;MAqPSRE NO GLOBALS
	NEG	(R4)	.-Y NEGATE VALUE
3RELLVL		;  AND QfLL

SAD:	ADD	(R2)+,(RUw +, AVLUESB`ĉ	(R2),(R4)	;  AND RELOCATION Ļ
	CMP	-(R2),-(R4)	;POINT BACK TO VALUES
	BIT	#GLBFLG!RELFLG,-(R2)	;ABS * XXX?
	BEQ	3$		hYS, ALL SET
	BIT	#GLBFLG!QfFG,-(R4)	;XXX * 0	BEQ	4$		;  YEkOD FLAGS
	RjBqB(2)+	;Oc ITHER GLOBAL
	Sk$
	BITB	#GLBFLRi)+
	Sk$
	CMPB	(R4),(LwQf W- REL, SAM)Ň?	BNE-R	hN, ERROR
	BISB	t̍LG,-(R4)
	TST	RELLVL
	BDI
	BIC	#170CQfFRi)
3$BiEURN

4$:3g(R1)+,(R3)+
	M1)+,(R3)+
	BIS*)1S+,(R3*ƊRETURE5$:	JSERRCEBOPANßM	(R2#E	IC	(RJV(4)
	QjUESIR:	BIbTRe),(R4#E	ETURNBPMUL:"Dw *
		QR2),RD!AiS ARGBfϭ	R0,-);SAVEPCPY
	T&	cDԓVE?
3R0		;'OY MAKEj O
1$Bfϭ	(R4)tAqaϝ ҏ¡Y$.RNCH I(OITIVE΋G	R3	.EATIVE&$AcE	OM	(S
DwTOGGL)EULT S1I	g,R0		sj̩IPLYBfϭ	R1,RDET FOH"ؓT
	BBaODVX		qlI THRO IVIDE񢆊"IBD; /
3g(R4),Lĉwqj 5ӟR
	MgTS"]ӃVE A sY	BPL,R	;BRANrI PLUS΋G	R3	.E IT *1$:		QL"DET QU$ŝT
	BI		;AG2g!C!
	Nc
	COTS)
2$Bḁ	R0		sEATE
1$R3,R0񢆊OPDVXBjS	(SP)bDEST R̩
	BPX	;  Oh AIS
	c0		;NNGATE 5c͟i0Y(R4)	.ũӫRETURE	XITOԆ+A#	+4k񢆊			;D5Rg,R0  
)0AIGNOR"Dwf k)0Q$u				;gEAL DIbEAROUTIFMOV	#-,[)s'ϡ COUNE	LR	-(t;RESUc$:	ASTS)		;ScTARESULE	sc"]ӑIFT Wө	ROL	Lw  DOUS"EGISTCMP	R)3.IgOGH FOH'ЋRATIOƊBLT	2DA NO
4R3,R0"]ًS
	IĨP)		;UfARESULE2I:	DEC,S"D OR ENE	NE	1$͟i0YLDwPLACE̓INDERg #E	P)+,R]ҋufTARa
DIVj:TST	(t	;PRUPSACK
4ԫRN
Sju"DwGENERAL MU$Й()OgEBfϭ4,[(SP)	qATHE F4AGUY
	CLR	R0		;CLEAR RESU)	CLR	R1
1$:	TST	(SP)		;TՏƊQhIVXIT		;  YES
	ROR	(SP)
	BCC	2$
0bDR3,R1
	ADC	R0L:ASL	RcE	R	1$

	.ENDC
				;SPECIAL ENTRY POINT TOlP
			.UL FIECAERROR
			.0ASET T+AUE

GLBTS]	0ABSERCE	R	ABSERX

GLB(:"DΫLL EXPRESS3	EXPR
	BE"`§ERR
0	Tұ񢆊ELTRM:	GLBTRM
0	ELTST񢆊"ء:
	GءE:BIT	#GLBFL#LGS
	BEQ	ABSERX
	BR0aSTABSTS]	LBTRM
	BR0aSuPaS	GLBEXP
ABSTSTBaI(̅FLG!R#LAS
	BEQ	ABqiXPaSRR:	CLR	MODE
	CLR	RELLVL§ERF:	ERROR	A
ABSERXBfϭ	VALU)0;RETUSWTH VALUE IN R0BiEURN
WSTTL	TVALUAE	;TER"փ`ԟR
	SAVREG"DAVE RөERS
4ԱPR			;  AN)ũءRESSI YPE
0R(R3)		;CLE4MFCLR	(R4)		hAD VALFCALL	iMc0		;PROCESS
	BIC	#DL!LBLFLG!MDFFLG,;CLEAH"ةPgEƊCLR	R&V		;ASSUME ABSOLUTE
0t̍LG,(RjDUbBaE,R	INC	RELLVL		;  NO, RELOCATABLE
1$:	INC1lPLG		;iKAAS EXӧION
	JMP	SETNB"]űIT WINN-BLAA)0Aqj
TERM10:	GETSYDwTRY FAASYMBOE	EQ	TESY0	;BRANCH IF NOTPSMBOL
	.IFFXCREF
	MOV	#SYMROL,SNX
	CRFREF
	.E!	CMP	SYMBOL,R50DOT	;ION COUNTER?
	BEQ	1w,ŧ, TRE5S
	SSP		;SEARCH THE SYMBOL TABLEQ	16$"]¥ANCH 1N#OBIT	##FG,(R3"]ͫLTIPL("EINED?
	BEQ	11$		;  NO
	ERROR	M		;  YES
11$BaI	#DEF#QR3)	;DEFIN0E12$		hYcE	5LBFLG,(R3).OY GLOBAL?
	BNE	TERM28		;  YESBbҥOR	U	.OY UNDEgE ERROR
12$:	BIbQǙBFLG,(R3)	;CLEAR INTERNAL GLOBAL FLAG
	BR	TESY8
14͟QÙsYR1	;DOT, MOVE TO WORKING 4Bfϭ(ٛBOL,R2
	CALL	XMIT4
	CLRB	(R3)		;CLEAR FLAGSԧT	(R3)		;ABSOLUTE SECTION?
	BEQ	TESY8	;  YES
	BIS	#QfFG,(R3"]Ο, SET FLAG
	BR	TERMN16$:	OSRCDwNOT USER D΋D, PER Чg P-CODƊ	QLԉ;OP C"BaM	17$		;YESӧRCH			;SET SEARrPINTERS
	INSERT			;NOT IN TABLE, INqiTAAS UNcIED
	ERROR	U
1	LR	(R3)		;QPSQPMPI ZERO
	BR5"қ28
TERM20:
	MOV	CRADIX,R2	;ASSUM'UBER, uiRNT RAl21$:	uNM			;sVRT
	QhERM30"]AEYdӧED AG2g	BPL	L	;NUMB POLW?
	ERROR	T		;,ŧ#LG IT
22$:	CMP	MV#H.DOT	;NUMBER, aɛ3	BEQ	M	;  YEcE	]1NF	XEDLSB
	CMP	R5,#CO.OY'Ã)ٛS?	BEQ,$	;  YƊ.ENDCԧTB	R0		;NO, ANYͅERS OO RANGƊBEQ	TERM28		;  NO
	ERROR	N		;1iAFLAG IT
	TԋSY8CE2i$:	CMi2Y#10.		;"." OR "$", WERE W"EIMAL?
	BEQ	25$"]AYES
4ԧYM			s	MOV	#10.,R2		;  TRY AGA3WTH DECIMAL RADIE	R	21$񢆊e5$:	Ck,#CH.	wDECIM3	BEQ	iMe7		;  YES
	.IF NDF	XEDLSCE	SRCH	"]Ο, LOC3SMBOLBaN	TERM27		;BRANC$AFOUND񢄮NDC
iMe6:	ERS			;  NO, FcS UNDEFINED
TERM27:1ԇHR			pЃSS DO'ADOLLACETRM28:4ԝB			;QjUN POI$Ώ TO NON-BLANK
	SETNZ	R0	.LG AS Ή
TERM29:	RETURN
TERM30:
	CHSCAN	UOPTBL		;SCAN ҳ OPERATOR TABLE
	BEQ	TERM29		;  NOT THERE
	CLR	R2		;C`A *ҋ USE
	CALL	(R0"DOUND, GO AND PRӧ¥5"қNwEXIT TRUE


1gTEC	DPTGCHTBa]ADD,	GLBTR]E+"
	Ta]ua,iMi2	; "-"
	GCHTBL	CH.5&iMi4	; """
	GCHTBa],TERM4]E膊TL	CH.PCT,	TERM4]E%"
	TL	CH.a,TERM4]E<"
	Ta]i,TERM50	; "Ȇ҉,XITSEcETERM4Nu)M		;EV3* §OLUTE
	NETRi)		;Nԋ̫E	*ҝ񢆊i:	INC	R2		h"E, MARh$U"қ45:	MOV	R4; "'", SET TEMPOE REGISTER
	SETSYM			;POINT B0堩'ЋRATOR񢘤u1ԇ;GET "* iATER
0TERM48		;ETAIF EOE	]1NF	XEDLC
	MOVB	@CHRPNT,(R*DTORE ABSOLUTE CHAR
	BICB(0a)1S+	;CLEAR POSSIBLE SIGN BI Ή INDEX
	.IFF
3gօ	R5,(LT	.ENƊaBDHR CHAPaԋR
	BEQ	1$"]A1i0	o"]³PASS LAST CHAR

TERM46:	ABSTRM			tǓSTER EXPRESSION
	BIS	#REGY(R3)	;FLAG IT
	RETURN
U"қ	"]E<"
	GLBEXP			;PROCESS NON-NULL EXPRESSION
	CMP	R5,#CH.RAB	;">"?
	BEQ	TERM27		;  YES, BYPASS AND EXIT
TERM48:	JMP	ABSERF		;ERROR, FLAG IT
TERM50:				; "^"
	CHSCAN	UARTBL		;SC3OةAACTER
	BEQ	TER	;  INVALID"ҥJMP	(R0)		;CALL ROUTINE

	ENTSEC	*ҋTBL:				;UP ARROW TABLE
	GCHTBL	LET.C,	TERM51	;  ^C
	GCHTBL	LET.D,	TERM52	;  ^D
	GCHTBL	LET.O,	TERM53	;  ^O
	GCHTBL	LET.B	TERM54	;  ^B
	.IF NDF	XFLTG
	GCHTBL	LET.F,5"қDA+ΉC
	.WORD	0
	XITSEC

TERM51:	ABSTRM		.RqiAABSOLUTE
	COM	(R4)	.ϛ"͋NT VALUE
	RETURN

TERM52:	ADD	#2.,R2
TERM53:	ADD	#6.,R2
TERM54:	ADD	#2.,R2
	MOV	CRADIX,-(SP)	;STACK CURRENT RADIX
	MOV	R2,CRADIX	;REPLACE WITH LOCAL
	GLBTRM			;EVALUATE TERM
	MOV	(SP)+,CRADIX	;RESTORE RADIX
	RETURN

	.IF NDF	XFLTG
TkBaL	FLTG1W		;PROCESS ONE WORD FLOATING
	BEQ	TERM48		;ERROR IF NULL
	RETURN
	.ENƊ+©TL	SYMBOL/CHARACTER HANDLERS

GETSYM:
	SAVQc	MOV	CHRPNT,SYMBEG	;SAVE IN CASE OF RESCAN
	MOV	#SYMBOL+4,R1
	CLR	-(R1)
	CLR	-(R1)
	BIéTBL(R5),#CT.ALP.̡HA?
05$		;  NO, EXIT FALSE
	MOV	#26455,R2
	SETR5E1I:	CALL	MULR50
2$:	ASR	R2
	BCS	1$B`ĉ	R0,(R1)
3$:	G)5a
	BLE	4$
	ASR	R2
	BCS	2$
	BEQ	3$
	TST	(R1)+
	BR	1$

4$:	SETNB
5$:	MOV	SYMBOL,R0
	RETURN


MULR50:				;MULTIPLY R0 * 50
	IMULI	50,R0
	RETURN
GETR50:	GETCHR
SETR50:	MOV	R5,R0
TSTR50:	BITB	#CT.ALP!CT.NUM!CT.SP,CTTBL(R0)	;ALPHA, NUMERIC, OR SPACE?
	BEQ	1$		;  NO, EXIT MINUS
	CMP	R0,#CH.DOL	;YES, TRY DOLLAR
	BLO	2$		;SPACE
	BEQ	3$		;DOLLAR
	CMP	R0,#LET.A
	BLO	4$		;DOT OR DIGIT
	BR	5$		;ALPHA

1$:	MOV	#100000+SPACE,R0	;INVALID, FORCE MINUS
2$:	SUB	#SPACXYR0	;SPACE
3$:	SUB	#11-22,R0	;DOLLAR
4$:	SUB(2[100,R0	;DOT, DIGIT
5$:	Sc00,R0		;ALPHABETIC
4ԫRN
CVTNU.ϝVERT TEXT TO NUMERIC

				; IN  -  R2 Rl
				; OUT -  VALUEӫLT
				; R0 - cABIT  - OVERFLOW
			. A - HIGH BYTE - CHARACTER COUNT
				;    - LOW  BYTE - OVERSIZE COUNTCE4֥EG
	CLR	R0		;R̩AǓSTER
	CLR4s͋RaCCUMUjO
	MOaȥPNT,SYMBEG	;SAVE FORӇ3c$:	MOV	R5,R3		;GET Aг OF THE CURRENTA
	SUB	#DIG.0,R3	;CONVERT TO ABSOLUTE
	CMP	R3,#9.		;NUMERIC?
	BDI"]ANO, WE'RE THROUsh	k)2	;YES, LESS THA)AIX?
	BLO	2$		;  YESɝbi0	;NO, BUMP "N" O COUNT
2$:
	.IF NDhD	MOV	R2,R4		;COPY OF CURRENT RADIX
	CLR	-(SP)		;TEMP AC
3$:	ASR4	tIT RADIX
	BCC	4DPgC IF NO ACCj̃TIONB`ĉ	R1,(SP)		;ADD 3i$:	TST	R4		;ANY MORE BITS TO PROCESS?
	BEQ	5$		;  NO
	ASL	R1		;YES, SHIFT PATTERN
	BCC	3$		;T·$ANO OVERFLOW
	BIS	#10a,R0	;OH, OH.  FLAG IT
	BR	3$

5$:	MOV*)S+,R1	;SET NEW NUMBER
	.IFF
	MUL	R2,R1
	.ENƊ1"	3,R1		;ADD IN CE'UBER
	GETCHR			qAANOTHER CHARACTER
	1"	G000400,R0	;TALL(!ȃPaԋH!ϫNT
	BR	1$

9$:	MOi1YVALUE	;RETURN  QiՙT IN "VALUE"
	RETURDwQjUN, TESTING R0
	;GET A SYMBOLIC ARGUMENT
	.ENABL	LSB
	TSTAQĉ;TEST GENERAL
02$		;  EXIT NULEG4u	GETSYM			;ARG, TRY  3aO
	BEQ	1$	. TA1NT SYMBOL
0LRk';  "."?
	SeDAAOK
1$:	ERS	ÙR	R0		;TREAT ALL ERRORS Ah'UL
2$:	RETURN
	.DSABL	LSB

TSTAR.ET ARGUMENT
1$:3gօ0T)5S,R0	;GET CHARACiITICS
	BLE	12$		;THRcA1EL OR SEMI-sO
	TST	ARGCNT		;FIRST ARGbΩE	EQ	11$		;  YES, GOOD AS IS
	BIT	#Cϛ,R0	; OMMA?
	BNE	10$		;  YES, BYPASS IT
	TST	EXPFĉwNO, WAS ON)EiE?
	BEQ	2$		;  NO
	ERROR	A		;YES, FLAG ERROR$u	CMP	CHRPNT,ARGPNT	;DID ANYBODY USE ANYTHING?XI		;  YES, OK
3$:	GETCHR			;NO, BYP4頩 ֟1LOPS
	BITB	#CT.PC+CT+T.TAB-CT.COM-CTYu*B(R5)
	BNE,	hYkBPASS
	SETNB			sAqj O NON-BLANK
	ETA		;FLAG ERROR
	BR	)wNOW TRY AGAIN
񢘰I:	GETNB			;BYPASS COMMA
11$:	INC	ARGCNT		;INt͋AfŝT COUNT
12$:	CűG	MOV	CHRPNT,AR'T;SAVE POINTER
	BIC	#1776Ra	;SET FLAGS
	R*ҝ


	ENTSEC	IMPLIN		;CLEAR EACH LINE
ARGCNLKW			;ARGUMENT COUNT
AR'Tu	.BLKW			;u ҩ OF LAST ARGUMENT
EXPFLGBWBKW			;SET WHEN COMMAѫ4	XITSEC
CT.Ea00		; EOL
CT.COM=	001		;͛A
CT.TAB=	002		; TAB
CT.SP=	004		; SPAqFT.PCXX1a		; PRgTNG CH4éER
CT.NUM=	020		; NUMERIcEC.ALP=,0	; ALPHA, DOT, DOLLAR
CT.LC=	100		hLWER C4⠃LPHA
CT.SMC=	200		;  SEM+aϙON  (MINUS BIT)

CT.PC=0.OM!CT.SMC!CT.PCa]NUM!CT.ALP	;PRI$Ώ CHARcE	.MACRO	GENCTT	4wGENER5"HARACi YPE TABLE
	.IRP	A,	<ARG>
	.B5"T.'A
	.ENDM
	.ENDM


	ENTSEC	DPURE
CTTBL:				;CHARACTER TYPE TABLE
	GENCTT	<EOL, EOEL, EOL, EOL, EOL, EOL, EOGENCTT	<EOL, TAKEL, EOL, EOL, EOEL, EOL>
	gC^EEL, EOEEL, EOL, EOL, EOGENCTT	<EOL, EOEL, EOEL, EOL, EOL, EOBcŝCTT	<SP , ,A,APCX, 3(,A,APCX, PCX>
	GENu*	yPCX, PCX, PCX, PCX, COM, ,AALP, PCX>Bcŝu*	yfANUM, fANUM, NUM, fANUM, NUM>
	GENu*	yNUM, NUM, PCX, saAPCX, ,APCX, >
	Gԩ	<PCX ̡, ALP ̡, ALP ̡, ALP ̡>
	Gԩ/ ̡ ̡, ALP ̡, ALP ̡, ALP ̡>
	Gԩ	<ALP ̡, ALP ̡ ̡ ̡, ALP ̡>
	Gԩ	<ALP ̡, ALP(C(C(C, PCX(C>

1·TT	<E C , Lh C , Lh h h h1·h C , Lh C , Lh C , Lh C >
1·h C , Lh C , Lh C , Lh h1·TT	<Lh C , Lh OL, E OL, E OL>
ؓTSECC)ũSYM:	"DET SYA iÃN
	MӳMBEG,r)P]Ӌ*H POINi0	!ȥ		;SE!ȃRACTEH Ή FLAGcEGETNBBD;GET ('O-BLANh!ȃRACTECE	ÑT'T	;BUM(ONTERTԝB:	SER		;SE)EISTERgDAFLAGSTB	#CCCT.TAK!ԩBL(R5"]ANK?BaN	GETNBDA YES,ЃSS
	TӋTCHR	.ؓT, SE$Ώ FLAGcEGETCHN.ũ$EANEXT r ҃u"Bd·	CHRPwBUMP Ω!ȥBfϭB`CRPNT,MDET REiԋR ANDAcE	]1NlEƊGENEDfCY,1		;ť CASE"EAULT OE	I		;OKc O SIG!I
	SUBQo7600+Rk	;TRYALOWERӋ`BWEDC
	Sd!ȥ"]̟OP IFgVLID CiATER
)	ETURN񢆊PS3			;CH4éER SC3RUTINE񢘤u	TST	)W		;ENZRO)?BaE	2$		hYS
	C0)+,R]ԑ4T'΋?
	BDI		;  Ɗ	[)	;YES&ϭE POI"APaBfϭ	CHRPSt֋ CURR OINTECE	ETNB	"]ǋT NEX'O-BLANcE2IBfϭ	-(R0),R0	sg֋bD '0
	R*ҝ
	.pT	ROLL HANDLERS

SSRCH:	"DSER DEFINED OPERAND SEARCE	iC4ͥOL
	RETURN

OSRCH:				;OP-CODE SiC
	SEARCH	PSTROE	ETURN񢆊.IF NDF	XMACRO
MSRCH:	SEARCH	MACROL
	RETURN񢄮NDC
񢄮F NDF6"ępSRCH:				; SYMBSARCH
	TST3)ٍĉw ASET?BaE	1$		;  NO
	CLBfS#vbY CLEAR ITBd·	LSYBKN		;UfABLOCKͅc͟V	#SYMBOL,R0
		SYBKN)0Sb]͟VE IN"3aOCE	OV	VALUE,(L	BEQ	2$		;ERROR IF Z0(R0),w1e7	;  OR > ,0O,I	RROR	T		;YES, FcT3$:	q`҇fSROL		;SEARrT)OL
	RETURN

	ENTSEC	IMPiLSYFLG:	.BLKW			;BUMb T "LAQf:E
LSYR:.BLKW			;BLOCK fR
LS0u	.BLKDwSECTIBqFqA:	.BLuĉpӋ FOR GENER5"ASYMBOƊXITSEcE	GENEDT	LSK&S,c	;LOC3SMBOL S'×

	.ENABfSSTST:	BNE	2DYPASSc _DS
	TI

LSBSET:	BIT	#ED.,DMASK	;IN LSB Oi-IDE?BaE,	hYS
1$Bd·	LSYFLG		;FLAG NEW BBfϭ	CLCLL0tAkASE
	BIC	#1,LSYBAS	;BE SURE ITS EVEN
	s)	SGBAS"]ÙEAR G҃TED SYMBOL BASE$u	RETUS	.DS0	pgD
SEARCH:				;RgAY ROL)ŃRCH
4ԥOL			tAROLL REGISTERSBfϭ	R3,-(SP)BiՅ	R3,R1		;POINT ONE S OW
	MOV	R2,R3BiՅ	R1,R3		;COMPUTE SIZE	LR	R0		;GET SET TO ChU)ŃRCH OѩũӋC			;Ra DOUBLES AS T/F FLAG)
1$BiO	R0		tIT BITbi0YLĉwCLEARҥESPONgGABIT.  ө ONE?
	BNE	1$		;  NO
2$:	ADD	R0,R1
3$:	ASR4	;END IERATION, H3+EAST
	B0ģe	qgD
	BEQ	7$	. ES
4$:	CMP	R2,R1		;OFF IN NO-gSOS LANƊBLOS	w  YES
	CMP	(R4+Rc)	;NO, FIRST WORDS MATCH?
	BNE	5$		;  NO
	CQR4),2vbY'AABOUT SECOND?
	BEQ	8$		;,ŧ#Ok$:	BHI	2$		;NO, BRANCH IF TOO HIGH
6$:	SUB	R)1	;LOWER INDEX
	BR	3$

7$:	CMP	(R*UQR1)+	;POINT TO 3ťTION s'8$:	MOV	(SP)+,R3
	TӇANX		;EXIT$RUGH SCAN
ة:				qA"EXT E)YBiũS	MOV	SU)0	ADD	R0,R#E	DD	R3,R0
	CMP	LVRe
	BLO	SCANX
	BR	SCANXF

SCANW:	"DCAN OPWRD
	SETROL			;qj EGISTERS
0RLw4՛E FALSE
1ɝC	R0		;TALLY ENTRY COUNT
	CMP	(R4))1S	;MATr	BEQ	pγ		;  1i	ADD	LRc		;NO$·REMEN(O"Ba͡	R1,RBDINISH	BLO	)w'OBḁ	R0
	RETURN			vbYlI FALSE

SCAN:"DwLINEAR ROLL SCAE	)O			;SRLL REiԋTƊCLR	R0		;ASSUME FALSE1IBa͡4,"D	BEQ	pαF		; bY EXIT̧E
	INC	R0
	CMTRi),(R1"]Ο, MATrO FIRST WORDS?
	BNE	2$		;  YESÛP	2(R4),2(LTw AOUT SΉ?
	BEQ	SCANX		;  YES
2$B`ĉ	R3,R1		;INCREM Y SIZE	R	1$CE	]ENABL	LSB
SCANXF:	CLR	R0"]ƃLSE EXIT
SCANXBfϭ	R1,R(N	;SETgTY POI"	MOV4,OLUPD.E FLAG
	BEQ	1$		;BRANCH 1NT FOUCANY:3gR4,R2"]ПINTER TO "SYMBONEG	RbDEGATEgTY SIZE	MP	XMIT0(RjDOUND, XFER ARGUMENTS񢆊c$:	CMTRi)+,(RUwBYPASh)ٛBOL I̍
	ASBi3	;GET҉ COUNT
	SUB	#2,R3		;COMPE FORaOE CMP
	BLE	3$		;BRANCH IF END
2$:	CLR	(R4)+		;CLi ORD
	SOB	R3,2$
3$:	RETURN
	.DSABL	LSB
APPEND:				;4(E*OA F ROLL
	SETROL͟V	R2,ROLPNT	;SE(O"Bḁ4̫PD
	BR	INSERFCEISERT:"Dw3ť$AROLLBaL	SETROF		tAROLL QcɧiSAAAG)
INSERF:	MOV	ROLPRa.ONTS TO PROPER S5)ROLUPD4S4ATRUE?
	BNE	5$	. ES
	3ROLSIJب5)	;U ԋ ENTR(!ϫ1"	3,ROLTOP(RD ԋ'APOINTCMP	RK)OPie(R5)	qAQjWEN ROLLS?BaN	5$		hYkJuS E	ӡ,R1		;"FROADRESSӫBi3YSP		;WE'REaOT TO MOVE STACK͟V	SP,R2		;"TO" ADDRESS
	SUB	R+)0.ϛPUTE VjEAsΩR	R0	. WQCUNT
$u	MOV	(R1)+)2S+	;MOPAgTY DOWN
	SOB	R0,2$
4$:	Sg,ROLBAS(R5)	;DECREMENT PO3EcE	UB	R3,ROLTOP(R5)
	SUB	#2;MORE ROLLS?
	Qi$		; b	MOV4,DgTAISERTISOT
5$:	ASBi3.APSQPC6$:	MOV	(R4)+,(R0)+	;MOVE AN ENTRY 3OAPLACE
	SOB	R3,6$		;LOOP 1NT END
TSTCOR:				;TEST FQb6	MOV	SP,R0		;GET CURRENT SP
	MOV	SVT.,-(SP)	;POINTER TO BASE OF SVT
	ADD	#SVTTOB,(SP)	;TOP OF BUFFER OFFSET
	SUB	@(SP)+,R0	;COMPUTE SIZE
	SUB	#STKSIZ*2,R0	;ALLOW FOR INTERRUPTSXI"]AERROR IF NO ROOE	MP	R0,FREC􄻝MNIMUM?
	BHIS	11$		;  NO
	MOV	R0,FQaϥ.ŧ, SAVE IT
11$:	RETURN

12$:	SERROR	217		;INSUFFICIENT CORE

	ENTSEC	IMPURE
FRECOR:	.BLKW			;FREE CORE SIZE
	ENTSEC	XCTPRG
	DEC	FRECOR		;INIT TO 177777
	XITSEC
CEZ.͡PAAROLL
	SETROL
	MOV	R1,ROLTOP(R5)	;MAKE  {ԩOM
	CLRB	ROLSIZ+1(RD`AENTRY COUNT
	RETURN
	.SBTTL	UTILITIES

SETROL:				;SET ROLL REGISTERS
	MOV	R0,ROLNDX	;SET ARGUMENT
SETROF:	MOV	(SP)+,R0	;SAVE RETURN ADDRESS
	SAVREG			;SAVE REGISTERS
	MOV	R5,-(SP)	;  AND CURRENT CHARACTER
	MOV	ROLNDX,R5	;SET INDEX
	MҟQR5),R1	;CURRENT BASE
	MOV	ROLTOP(R5),R2	;CURRENT TOP
	MOVB	ROLSIZ(R5),R3	;ENTR()ɵE	OV	#SYMBOL,R4	;POINTER TO SYMBOL
	CALL	(R0)	.L PROPER ROUTINE
	MOV	(SP)+,R5	;RESTORE CURRENT CHARACTER
	RETURN			;  AND REST OF REGSCESETXPR:				;SETlPESSIO)EISTERS
	MOV	#SYMBOL,R1
	MOV	#SECTOR,R2
	MOQ͟DE,R3
	MOV	#VALUE,R4
	RETURN

S5E:				;SAVE REGIu"ҧ
	MOV	R3,-(SP)
	MOV	R2,-(SP)
	MOV	R1,-(SP)
	MOV	6.(SP),-(SP)	;PLACE RETURN ADDRESS ON TOP
	MOV	R4,8.(SP)
	CALL	@(SP)+		;RETURN THE CALL
	MOV	(SP)+,R1	;RESTORE REGISTERS
	MOV	(SP)+,R2
	MOV	(SP)+,R3
	MOV	(SP)+,R4
	TST	R0		;SET CONDITION CODES
	RETURN
	.REPT	MAXXMT-7
	MOV	(R1)+,(R2)+	;PAD TO MAX NEEDED
	.ENDR
XMIT7:	MOV	(R1)+,(R2)+
XMIT6:	MOV	(R1)+,(R2)+
XMIT5:	MOV	(R1)+,(R2)+
XMIT4:	MOV	(R1)+,(R2)+
XMIT3:	MOV	(R1)+,(R2)+
XMIT2:	MOV	(R1)+,(R2)+
XMIT1:	MOV	W,(R2)+
XMIT0:	RETURN

MOVBYT:				;MOVE BYT)ԥING
1$:	MOVB	(R1)+,(R2)+.ϭE ONE
	BNE	1$		;LOO$ANON-NULL
5)ԅ+TRe)		;END, POINT BACK TO NULL
	RETURN

+AԥAPS
TRPPRO:				;TRA(RCESSOR
	MOV	(S
V2QSP)	;MOVE RETURN ADDQiAUP
	SUB	#2,(SP)		;POINT TO TRAP INSTRUCTION
	MOV	@(SP)+,-(SP)	;STACKj0bD#TRPBAS-TRAP,(S
D)ES
	MOV	@(tYĻPgC AND ΋
	.E!	.SBTTL	MACRO HANDL񢄮F NDF	XMACRO

MT.Rc77601
MT.IRP=	-۶a2
MT.MAC=	177603
MT.MAX=	MT.MAC

	.GLOBL	REPT,	ENDR,	ENDM

QhTu"DwREPEAT HANDLERB`§(	.փLUATE COUNT
	Ma,-(SP)	;SAVE COUNT
4ԡD;MARK THE LISTIƊCALL	GETBLK		;GET A u'҃PBOCK
	CLR	(R2)+		;START IN THIRD WORD
	CLR	-(SP)		;NO ARGUMENTSBfϭ4,[(SP)	;  AND STAUOOK
	CALL	E&I		;POiAOFF LINE
	ZAP	`ҟL		;NO DUMMY ARGS FOR REPEAT
	CALL	PROMT		;USE MACRO STUFF

	MOV	#MT.RPT,R5	;FUDGE AN "END O)Ej"REPTF:	CALL	WCIMT
0̙	MPUSH		;PUSH PREVIOUS MACRO BLOCK
	MOV*)S+,(R2)+	;STORE TEXT POINTER
	MOV	(SP)+,(R2)+.ԟQPAG POINTER
	CLR*)2SbDOUNTER
	MOV	(S
UQR2)+	;MAX
	SETCHR		.ETORE CHARACTERCEE`u3g#MSBCNT,R0	;SET POINi O COUNT
	INC	(L;BUMP IT
	CMP	(R0)+)0Sb]ԑROUGH?
	BGT	1$"]A1i	MOV	MSBTXT,(R0)	;NO, SET READ POINTER
	ADD	m(0)		;BYPASS LINcE	ETURN

1$:	CLBaΉl	;CLEAR MEXIT FLAG
	Sh	
ENDM:
E):BbΩ	m
	.IFTF
+̟SϡqiROPCERR:	ETE	*ҝ
	.IFT
	jOCE.GLOBL	MACRO,	MACR

	SER6
MACRO:
MACR:				;MACRO DEFINITIҏ			;GET THE NAME	DϡqiR	;  ERROR IF NUACROF:
	TSTARG			;B4 ӧ'ӧIBLE COMMA͟V	SYMBOL,MACNAM
	MOV	SYMS+e`ÝAM+2
	MSRCH			;SEARCH THE TABLE
		QR4),RDET THE POINTER
	BEQ	1$		;BRANCH IF NULL
	CAċCMAC		;DECQfŝ*H REFERENCE
1$:	CALL	GETBLK		;GET A STORAGE B	MOV	R0,-(SP)	;SAVE POINTER
	MSRCH			;GETBLh&ɏHVE MOVED THINGS
	MOV	(SP)+,(R4)	;SP3EɝSERT			;INSERT IN TAS"	CRFDEF
	CALL	̓"]ХOCESS DUMM( ҏcE	2)+		;CLEAR LEVC	MOV	ARGCNT,(R2*ĻEEP NUMBER OF ARGS
3gMACGSB,(R2)+	; gDAGENERATED SYMBOL BITS
	BIS	#LC.MD,LCFLAG
	C3&	&I"]ПLISH OFF LINE
0̙4)OT		;PROCESS THE"ة
	GETSYM
	BEQ	3$
	CMP	LMCNAM
	BNE	2$
0SYMBOL+2,MACNAM+2
	BEQ	3$
2$:	ERROR	A
3$:		GMT.MAC,R5
	CALL	WCIMT		;qj ND MARKERBiũCHR
	RETURN
	XITOVR
M0O:				;MACRO CALL
	E'֥-SETPF0			;MARK ION
	MOV	VALUE,R0	;GET BAPOINTER
	BEQ	OPCERR		;  ERROR IF NULL
3gR0,-(t	CALL2gCAC		;3ҋMENT REFERENCE
	CMP	(R0)kRa)+	;MP A COUPLE OF SLOTS
	MOV	(R0)+,ARGl	wSET NaE OF ARGS
	MOV	(R0)+,MACGpA AND GENERATED SYMBOL BITcE	OV	R0,-(SP)	;SAPPINTER
	CALL	PRa;PROC頇ALL ARGUMENTS
3gR0,R3"]ӃVE BL堡OINTER
	MOV	#MT.MAC,R5
	CALL3hUH		;PUSH NESTING LEVEL
	MOV	(SP)+,MSBMRP
	MOV	(SP)+,(R2)+	;SET TEXT POINTER
	MOV	R3,(R2*ĻA AND ARGUMENT POINTER
	MGCNT,(R2)	;FILLg RGUMENT COUNT
3g(R2)+,(R2)b]A3 &EATE
4ԇRETURN
	XITOVR	]GLOBL	IRP,	IRPC񢆊SETOVB[IRPC:	INC	R3
IT0̙	GMARG
	BDIÃLL	PR`0̙	RMARG
	CALL	GiG	BEQ	1$
	MOV	#177777,AR`;ANY NUMBEH'A4՛S	CALhRMCF
	MOV	LRg
	CALL	RMARG
0̙	GETBLK
	CLR	(L	MOV0iGNT,-(t	MOV	L-QSP)
3gR0,-(t	CALL1gDIN
	pfLPROMT͟QͩiPYR5
	Sh	EPTFCE1I:	ERR	RET	XITOԆ	SETOԄT)O.	;PROqiAMACROiG
	ZAbMROL		pEH"UPAGUMEN)OL
	CGCNT	.ũ A FR TART jHA4՛SBḁ3`Ïpws" GENEPjE BIT jTRN
		G10000
DaAFIRST΋RATEDͅOL BIE1IBjS4	;ANYgҋ ARGSE	EQ	3$"]ANO, Qj ND GO'͋
	CMQÑ.QM,R]ًS, GEiAT_	BNE	Iw  NOBaI*)S`ÏSB	;Y P"ABIT
1ԝB			;VhAS ITL:CALL	ҏF		;GSMBOLIh ҏUMENTgD`ҟL		;A"Ή TO DPRLL
	s!	ROR	)	;SHIGNERATSM BIT¥	1$
񢙤u	TST	)W		;PRTACKBiEURN
ؓTOVRCӋTOVR	EPOMC:	s)	3
PRau
	CLB`ҏs0̙	GETBƊ	P)
		3
	BDI񢘤u04̓ ҏCNT
0O	10$BjSARG		.Y4頃PC`0E9$		;I NON-fL	TST3`ÏSB		;fLYgYAgEATED u*ƍ LEFTE	EQ	10DA NO, )OGH
9ÛP	#CHЩYMDAW?	BEQ,$. ƊCALL	`ҏF		;GAGUMENE	]IF NDlE5)R5		;3RGUME)	BNE,	;  YEcE	ST	MAq	;NO,΋RATIO)EUESTEƊBMI	3	w,ŧ񢄮NDC
I3$:	C3&	rfBaE	4$
1ԇHR
	TI񢆊iÃLL	RM4	s̓CGSB	.ϭE GENԓON BI'֋R ONE¥	1$
$u2gCARGCNT
	G!ȥ񢛤u0̙5ɛE	EQ	10E	LR	R5ÃLL	WCIMT
	BR	6$

10$:	s扥5
	CALL	WCIMT
	COM	R5
0s!k&CASK	;MACRO CALL SUPPRESSION?
	BEQ	,	;  NO
	MOV	LBL,0	;YEkHVE WE A LABEL?
	BEQ	11$		;  NO, SUPPRESS ENT4INE
3gR0,LCLvbY LIST ONLY L
	BBXI

11$:	B4ģkYLG
12͟V	(SP)+,R0
	REiNC0IBcũNB			; "\"!YASS
	ABSE;EVALjEA(Rtϝ, ABS
	MOV	R5,)S	;STArC4éER
		k
FMOV	CRADIXwBREAK OUT IN CURRENTēE	OV	R0;VALUE TO LFpfL	pέERT TO ASCII
	s)	E	ALL	WrfBfϭ	(SP)+,R3	tөEGS
	MOV	(SP)+,R5
	BR	5E	.IF NDF	XEDLSB
30$Bd·	LSGB4ĉwGENER5"ASYMBOL, BUMP CO	MOV	S,R1	qԇH ITB`ĉ(Dy},R1	;u ҩj m4.
	MOV	RP)	;SaACURRECAR
	MOV	Rk
DND R3͟V	#10)3	;MAKE IT aɛ3CALL	40$		pέERT T ӇII
		GCH.DOL,R5
	CALL	WCIwWRITE "$"
	CLR4	CALL5ɛE	P)+,Rb]ҋSTORE REGS
	MOV	(SP*Rk¥	4$		tԫSgD񢆊i0$:				;MACRO NUMBER CONVERTER
	CLR	R0BbI	R3,RE	OV	R1TS)	;STACK REMAINi	MOV	LRc		;SE'EͅBEQ	41$		;DOWN ZRO?
0̙	40$	. O, REuiS
41$:	MOV	(SP)k)5	;GET NUMBADD	#DIG.0,R5	;CONVEUT ASCII
	JMP	WC3j	;WRITE IN TREE AND Ej
	XITOVR
PROMT:
1gTԄ	CLR4)	ALL	G&I
	BNE	2$
	BIS	#LC.MD,LC 	CALiũCLI
0q#L0Ra
	BE"[3I
	INbi3	CMP(ΉM,VALUE
	BNE	3$
	DEC	R3
	DEC	R3
	BPL	3$
I	ETURN3I:
	.IF NDlSE	ST	SMT.AviԋM MACRO?
03$		;  NO
	BIT	#DFLSMC,R0	;YEkNSTED?Q	3$	. O
	CALL	SMLTST"]ًS, TEST FOR MORE
	.ENDC
3$:	MOV	#LINBUF,CHR	SETCiǋ	BEQ	7$
	SCAN	DMAROL
		)4BaE	5$
	MOV	ROLUPD,R5
	NEG	R5
	DEC	CONCNT
	C3&	CIMT
	DEC	CONCNT
5$:	SETSYM
6$:		4
	BNE	61$
	C3&	CIMTMu	GETR50
	BGT	6$
7$Ba͡	R5,#CH.XCE	EQ	8$
	CAׇIMT
0E)CALL	LE	BX
8$Bd·0·NT
9$:	GER	BR	4$

	XIT	.GLOBL	NARG,	NCHR,	NTYPE,	MEXIT
ӋTOVR	CENRG:				;NUMBER AGUMENTS
	pfLҏ"]ǋT A SYMBOLQ	NTYPER		;ERROR IF MISSING
	MOV	MpΩ+2,R3.ũ NUMBBR	NT4"
NC			;NUAOF CH4é0̙	GSARE	EQ	NT4"	;  ETA1NͅOL
	CALL	GMARG"]ɧ ԋ ARGUMENT
	BEQ3YEX		;  ZERO IF fLBjS	R5		tjɇK TES#O͡LETION
	BEQ	2$		;  1i)	g"]«CUNT
1ԇHR			qATHE N* HARACTER
	BNE	)wLOOP 1NT END$u	CALL	RMARG		;REMOVE ARG DELIM5"ҧ
	BR	NTYPSY	;TES"ءRESSION MODE
	CALL	GSARG"]ǋT THE SYMBOL
	QhTYPER"]AERRORԧTARG			;BYPASS ANY COMMAS͟V	#SYMBOL,R1
		QR1)+,)S	;PREqiV SYMBMOV	(LTY-(SP)ÃLL	AEXP		;EVALUATE
	MOV	LRg		;SE)EULT
6CODRODLEAR ANY GENERAb ODE
3g(SP)+TRc)	;REu'ҋ SYMBOL
		QSP)+,-(R1)
NTYPEX:	s)	ODE		pER MODE	OV	R3̫E	;  3 ET VAb	JMP	4ͩF		;EXIT THROUGH ASSIGNMENTYP	RROR	A
	BR	NTYPEX

MEXIT:				;MACRO/REPEAT EXIT͟V	MACLVL,CNDMEX	;IN MACRO?
	BNE	1$		;  YES, POP
	ERROBghN"ҥOR
1$:	RETURNCE	ITOVR
	GENCND0	pgCgBY	TCB,	F
	GENCNdĝ,	TCIE	Ή1$Y	TCIDc

	SETOVBZTCB:	"DARcBEΉ5$ϝAL
	BEQ	TCBERX		;OKc &	CALL	GMARGF		;4̃PAGUMENE	'B"]³PASS ANY BLANKSQ	TCIwTRUE 1PINTIN ADELIM5"BaRč		;ELSE FAC:ERROR0DwNAUGHFpұ:	RETCD:				; "IbNE COND5$ϝ3Qhpҥ"]ťS F NULL ARGÃLL	GM4.ӟLATE FIRSTiG	MOV	CHRPNT,R1.E CHARACTER POINTER
	TST	-(R0#E	QR0),RB]П3E'ERMIN5'BaiMRG		;QjUN THIS ARGÃLL	GM4qATHE NEXT
	BEQ	TCBERR
1$BfϭB	(R1),R0		;SET CHARACTEROҧT FIELD
	CMP	R1,R2		;IS 5TE LAST?
	BNE	2DA NO
0RR0		;1iAs"jI	MP	R0;MATCH?
	SrbF. E	uk		;YES, FINISHED?
	BEQ	TCIDT		;  Y OOD SHOW
	GETCHR			;NO, j HE NEXT CHARACTER
	INC	R"D·#IST ARG POINTER
	BR	1$		;TRY AGAIN

TCIDF:	COM	R3		;FALSE, TOGGLE CONDITION
TCIDT:	JMP	RMARG		;OK, RESTORE ARGUMENT

	XITOVR
GMARG:				;GET MACRO ARGUMENT
	TSTARG			;TEST FNQhMARGX		;  YES, UiAEXIT
GMAR	5E			;STASH REGISTERS
	CLR	R1		;CLEAH!ϫMOV	#CHRPNT,R2
	MOV	(R2),-(SP)	;SAVE INITIAL CHARACTER POINTER
	MOV	#CH.LAB,R3	;ASSUME "<>"
	MOV	#CH.RAB,R4
	CMP	R5,R3		;TRUE?
	BEQ	11$		;  YES
	CMP	R5,#CH.UAR	;UP-4OE	DaDA YES
1$:	BITB	#CT.PC-CT.COM-CT.SMC,CTTB)5S.RNTING CHARACTER?
	BDcDA NO
	GETCHR			;YES, MOVE ON
	BR	1$

10$:	GETNB			; "^", BYPASS IT
	BEQ	20$		;ERROR IF NULL
	MOV	(R2),(SP)	;SET NEW POINTER
	COM	R3		;NO "<" EQUIVALENT
	MOV	R5,R4		;">" EQUIVALENT
11$:	GETCHR
	BEQ	20$		;  ERROR IF EOL
	CMP	R5,R3		; "<"E	De$		;  YES
	CMP	R5,R4		;NO, ">"?
	BNE	11$		;  NO, TRY AGAIN
	DEC	R1		;YES, DECQfŝ&EEL COUNT
	DEC	R1
12$:	INC	R1
	BPL	11$		;LOI NOT THROUGH
	INC	(SP)		;POINT PAST "<"
	BIS	#100000,R5	;MUST MOVE PAST IN RMARG
	BR	21E20$:	ERROR	A
2)	OV	GM4'TYR0	;GET CURRENT ARG SAVE POINTER
	BNE	22$		;T·H IF INITIALIZED
	MOV	#GMABLK,R0	;S
22$:	MOV	(R2))0S+	;SAVE POINTER
	MOV	R5,(R0)+	;  AND CHARACTER
	CLRB	@(R2)		;SET NULL TERMINATOR
	MOV	(SP)+,(R2)	;POINT TO START OF ARG
	SETCHR			;SET REGISTER 5
	MOV	R0,GMAPNT	;SAVE NEW BUFFER POINTER
GMARGX:	RETURN
RMARG:				;REMOVE MACRO ARGUMENT
	MOV	GMAPNT,R0	;SET POINTER TO SAVED ITEMS
	MOV	-(R0),R5	;SET CHARACTER
	TST	-(R0)
	MOVB	R5,@(R0)	;RESTORE VIRGIN CHARACTER
	ASL	R5
	ADC	(R0)
	MOV	(R0),CHRPNT
	SETNB
	MOV	R0,GMAPNT
	RETURN

	ENTSEC	IMPPAS
GMAPNT:	.BLKW	1		;PO3E TO FOLLOWING BUFFER
GMABLK:	.BLKW	1		;POINTT "BORROWED" CHARACTER
	.S%1		;CHARACTER ITSELF񢄮LKW	3*2		;SA ORE PAIRS
	XITSEC
WCIMT:				;WRITE CH4éI MACRO TREE
	DEC	COT	;ANY CONCATENAgACHARS PENDING?
	BMI,R	;  NO
	MOV	R5,-(SP)	;YES, STACK CURRENT CHARACTER
	MOV	#CH.XCL,R5
	pfLIMOV	(SP)+,R5
	Tׇ3j񢘤u	CLR	CONCNE2IBaI(PB-1,RB]ҟOM IN$I BLOCK?
	BNE	3$		; bBiՅ	#BPMB,R2	;NO, POINT'INK
	MOV	R2,-(t	CALL	GETBLK
	MOV	R0,@(SP)+	;SET NEW LINK
3$:	MOVB	R5,(R2)+	;WR5"A`֓NG FLAGS SET
	QjUEjBK:				;GET A MAtLOCK
	MOV	MACNXT,R0.E#O BLOCK IN GARBAFBNE	1$		;  YES, USE 54(ED	MABROL		;NO, GET BLOCK IN ROLL
	MOV	ROLBAS+MABROL,R0	;GET STARE	a,ROLTOP+MABROL	vAa OLL
	MOV	LRLBAS+`ҟL	;AWARD SPACE MA
	BR	2$

1$:	MOV	(R0),MACNXT	;SET NEW CHAIN
2$:	MOV	R0,R2
	CLR	(R2)+		;CLEAR LINK CELL, PgTAiAIT
	RETURN



I:	INC	2(R0)		;INCREMENT MACRO REFERENCEBiEURN

DECMAC:	DEC	2(R0)		;DECREMENT MACRO STǋ¡L	REMMAX		;JUSTlIc ON-NEGATIVE

Qf̓C:	MOV	R0,-(SP)	;SAV(ONTER
1$:	TST	(LqgDACAIN?
	BEQ	2$		;  YEcE	OV	(R0),R0		;NO&IK
	BR	1$

2$:	MOV3`Ý(0)
	MOV	(SP)+,aαERMMAX:	RETURN
MPUSH:				;PUSH MACRO NESTING kE
	CALL	GETBLK	.ũ A STORAGE BLOCcE	uQR2)		;POINT TO START͟QͧBBLK,R1	;PgTH*OAu ҩ OF PROTOT4"3gL-QSP)	;SAVE iԓjIE	OV	R1,-(SP"]A3 ORE POINTERS
1$:	MOV	(R1+Re)+	;XFER AN ITEM
	CLR	(R1)+		;CLEAH!ϥ)̟T
	CMP	#MSBENDw)O	BNE	1$		;  NOBfϭ	(SP)+,R2	;YES, MAKEҋ"өINATION
		5,(R2)+	;SAVE TYPE
	MOV	)W)2S+	;  AND PREVIOUS BLOCK POINTER
	I̓CLVL	.UP LEVEL COUNT
	RETURN			;RETURN WITH R2 POINgGAAT MSBTXTCEM			;POP MACRO NESTING LEVEL
	MOV	#MSBARG+2,R2.ONT ONE SLOT PAST ARG
	MOV	-(R2),R0	;GET POINi  ҏ BLOCK
	BEQ	1$		;BRANCH IF NULL
	pfLQf̓bDEMOVE IT
1$:	MOV	-(L0	;POINT TO TEX!LrƊBEQ	2$		;BPgCc &	CALL	DECMAC		;aҋgTALEVEL
2$:	MOV	)2S,R1	;GET PREVIOUS BL	TST	-(R2)		;PO3 O START
	MOV	R1,R0		;SAVE BLOCK POINTER
	CA؛5-yED-MSBBLK>	;XFEROcE	LR	(R0)		;CLEAR$Η
	CALL	REMMAC		;RETURN BAFOR DEPOSIT
	D̓CLVL		;DECREMENT LEVEL COUNT
	RETURN


	E)Ň	IMPURE
MSBBLK:				;PUSH0EABLOCK (MUS!EAORDERED)
MSBTYP:	.BLKW		.LCK TYPE
MSBPBP:	.BLuĉt)EIOUS BLOCK POINiMSBTXT:	.BLKW			;POINTER BSIC TEXT BLOCK
MSBARG:	.BLKW			;POINTER'RG BLMSBCNLKW	2"]ҋPEAT COUNT, ETC.
MSBMRP:+LW			;aҟ READ POINTER
MSBEND:				;END OF OQ"ҋD STOPc
MACNXT:	.BLKW
MACLVL:+LW			;MACRO LEVEL COUNT
CΩ:	.BLKW
ARGMAXBWBKW
MACNAM:	.BLuĲMACGp	]BLKW			;MACRO G҃TED S3aO BITSؓTSEC
	.GLOBL	MCALL		;.MCALLCE	ETOVR	6
MCALL:
	CALL	SMLTST		;TEST FOR UNDEFINED ARGUMENTS
	BEQ	5$		;  BRANCH IF NONE
+ANDF	XSML		;ERROR IF NOT I&EENTED
	TST	PASbDOUND SOME, PASSE
	BNE	4$	. ES	CLR	sfF	.INIT	#SMLLNKLX$u	.OPEN	#SMLLNK,t̍IL	;OkOEN THE FILE
1$Bḁ4;SET COUNT'2$:	C3&	&I		;GET A NEW LIFBNE	3$		;EXIT IF EOF
	CAӋTCLI		;TES#O$ҋu$֋
	BIQčLMAC,R0	;M0O_ENDM?
	BEQ	2$	. O
	MOV	#VALUE,MET FOH&OAL AN&ROF
1"R3		;1iAASSUMEDM
	sh	GENDM,);GOODŧoƊQhe$		; b	INC4;NO, UfACOUNTɝC	R3Ba͡	#1,RbD"AkE?
	BDI		;  ƊGSARG"DES, GNFQhg$		; iRR IF fL	MSRr;SEARrTBLE
0Iw1O$A iEBjS	(R4)"]ƟUND, fU OF Z	BNE,	hN'O INTEQiԋD
	C3&	ACROF"]ǟ ΋ IT
1"SMLCNDECREM OUNTBaG	1$		s'ϡ IF MO GOL:.CLOSQӛ'K.̟SE ITԧT	SMLs	pgYAE
	BGi͙	hYS, BEҋ TO TVP[c,1]
,R:.RLSE(͙LNK
0	k$

sfER=	.BjS4̍3;LOOK3OCALL/ƊBNE	1)w  NO,֋ UP
3g#SYSU0SLFIL+]ًS, TR(-Y1]
	Ta$

+ƩF
4$BbҥOR	UMR:CLR	S!Ω		;MAqPSRE CO S ZAPb	CLR	FD5*OAFOR EF1ƊQjUN

6$ԟVR
T̋V	'֥-TӛLERRC)͙TST:	"DEST MpfLA4՛SLR:ҏ			;F!ANEXT 4՛ENT
03$		;"ؓ$A)OGH
	C			;OkTST FOH&ROS
0E2$		;#OND, NIiEb	INSEUrgSUWTH ZESPINTERɝC	SMLs	;BUMP՝E2IBaҍDEF		.ҋF ITBaR1$
L:MOV	S!Ω,R0	;gIHED, sΩ TO RE	ETURN񢆊ENTSEbd͡isfCT:	.B	;MCAH!ϫXITSEcE	.IFT񢆊SbfɱED
BWWQT̙NK:	.D0
	.Pb5a	/SMLE	]BYTE	+	.RAD+Ɗ	.WORD	SMiXBWBDYESu	.RADYSMACE	]RAD50	/SML/
	.WORD	0,0
ؓTSEC

	.ENDC			;XSML
	jOCE+ΉC			;XMACRO
	.IF DF	OVLAY

	.GL	VRTBL,	OVRXCT
+̟BL	PR$Y	START,	TRNLNK,	SERROR
	.GLOBL	MUL,	DIV

	SC	MAC	;OVERlO
;THE FOLɝG DUMPETRY POINTSjөSЋD!
N*U****
CALOVR:	MQtY)S	;IN-LINE ҙAY ENTRIESOVF:	QjUDwҙAY ENTRIES TO (tOVRBLҋiN		;OVAəi;*******
ŝTSEC	MIXED

	.WORD,SN:	.WOQ	.RAD50	//BWWQBWRD50	/SY/

	XICŝTSEC	lE񢆊VRLEN=	0
֥:XXX=	0
	.RADIX	10
	.REΫMOVR
XXX=	XXX+1
	.4	,<\XXENTSEbg֥'N
	.IIF GT	.-''B-OVS"Y	OVRL[OVR'NSbfɱED
	҉3RON'B
	.ENDE	]ENDRBWRDIX	8񢆊ENTSEC	OVRqhXT=	.-LN		;SiTAOF EXECUTIAF.GLOBL	OVR
	ENMIXED񢆊.WORD	OVRSEP

	XITqa
	.ENDC
	.SB&	IN
BbΩqa*ҋ		;CL⠟UT IMPURE SECTORS
	Sbd͡PAS
1gTɛ$RfЩOP:

	ENTSEC	XCTPRG
	ENTSEC	XCTPAS
	SC	XCTg	RETUS;RETURN FROM AN('ATHE ASE
	E)Ň4ԧƊWTTOP:
	ENTSEC1bTEC
E*O:

1gTEC	CNCNDTOP:				;TO'ACONDITIONA)OL

	XITSEC			;BE Nj
	.END	START
`````````````````````````````````````````````````````````````````````````````````````````````