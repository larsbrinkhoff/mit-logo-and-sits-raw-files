.MLLIT==1
title EDIT SUMULATOR
MLINEL==100.
MLINES==100.
LINBFL==MLINEL/5+3
DEFINE DC CH,ADDR
LOC DISP+CH
ADDR
LOC DISP+200
TERMIN

A=1
B=2
C=3
D=4
E=5
F=6
PNTR=7
LINE=10
P=17
PATCH:PAT:	BLOCK 100
PDL:	BLOCK 40

DATA:	BLOCK LINBFL*MLINES

LINEPT:	REPEAT MLINES,440700,,DATA+LINBFL*.RPCNT
LINEL:	BLOCK MLINES
LINEBF:	BLOCK MLINES
NLINES:	0
XPOS:	0
YPOS:	0
MXPOS:	0
MYPOS:	0

GO:	MOVEI P,PDL
	.OPEN 1,[SIXBIT /  $TTY/]
	.VALUE
	.OPEN 2,[SIXBIT /  1TTY/]
	.VALUE
	.CALL [SETZ ? 'RSSIZE ? [2] ? 2000,,MYPOS ? SETZM MXPOS]
	.VALUE
	PUSHJ P,FORM
	.IOT 1,A
	PUSHJ P,@DISP(A)
	JRST .-2

DISP:	REPEAT 40,CPOPJ
	REPEAT 140,ALPHA
DC ^L,FORM
DC 30,BACK
DC 31,FRWD
DC 1,DOWN
DC 13,UP
DC 177,RUBOUT
DC 33,RUBBCK
DC 12,NEWLIN


FORM:	.IOT 2,[^P]
	.IOT 2,["C]
	MOVE PNTR,[440700,,DATA]
	MOVEM LINE,YPOS
	SETZ LINE,
	MOVE A,NLINES
FORM1:	PUSHJ P,DLINE
	AOS LINE
	SOJGE A,FORM1
	MOVE LINE,YPOS
	JRST CURPOS
CPOPJ:	POPJ P,
DLINE:	.IOT 2,[^P]
	.IOT 2,["H]
	.IOT 2,[10]
	.IOT 2,[^P]
	.IOT 2,["V]
	MOVEI C,10(LINE)
	.IOT 2,C
	.IOT 2,[^P]
	.IOT 2,["]]
	MOVE PNTR,LINEPT(LINE)
DLINE2:	ILDB C,PNTR
	JUMPE C,DLINE1
	.IOT 2,C
	JRST DLINE2
DLINE1:	MOVE C,XPOS
	.IOT 2,[^P]
	.IOT 2,["H]
	ADDI C,10
	.IOT 2,C
	POPJ P,
ALPHA:	MOVE PNTR,LINEPT(LINE)
	MOVE C,A
	MOVEI A,LINEBF
	HRL A,PNTR
	BLT A,LINEBF+77
	MOVE A,XPOS
	AOS XPOS
	AOS LINEL(LINE)
	SETZ B,
	MOVE D,[440700,,LINEBF]
ALPHA1:	CAMN A,B
	IDPB C,PNTR
	ILDB E,D
	JUMPE E,ALPHA2
	IDPB E,PNTR
	AOJA B, ALPHA1
ALPHA2:	CAME B,A
	JRST DLINE
	.IOT 2,C
	POPJ P,
FRWD:	AOS XPOS
	JRST CURPOS
BACK:	SOSGE XPOS
	SETZM XPOS
	JRST CURPOS
UP:	SOJGE LINE,CURPOS
	MOVE LINE,YPOS
	AOJA LINE,CURPOS
DOWN:	AOS LINE
CURPOS:	CAMLE LINE,NLINES
	MOVE LINE,NLINES
	MOVEI C,10(LINE)
	.IOT 2,[^P]
	.IOT 2,["V]
	.IOT 2,C
	MOVE C,XPOS
	CAMLE C,LINEL(LINE)
	MOVE C,LINEL(LINE)
	MOVEM C,XPOS
	MOVEI C,10(C)
	.IOT 2,[^P]
	.IOT 2,["H]
	.IOT 2,C
	POPJ P,
RUBOUT:	MOVE PNTR,LINEPT(LINE)
	SETZ A,
	MOVE E,PNTR
RUBOU1:	CAMN A,XPOS
	IBP PNTR
	ILDB C,PNTR
	IDPB C,E
	JUMPE C,DLINE
	AOJA A,RUBOU1
NEWLIN:	SKIPN LINEL(LINE)
	POPJ P,
	MOVE A,NLINES
	CAML A,MYPOS
	POPJ P,
	CAME LINE,NLINES
	JRST NEWLI1
	AOS LINE
	AOS NLINES
	JRST CURPOS
NEWLI1:	MOVE A,NLINES
	HRRZ A,LINEPT+1(A)
NEWLI2:	MOVE B,-LINBFL(A)
	MOVEM B,(A)
	SOS A
	CAIL A,@LINEPT+2(LINE)
	JRST NEWLI2
	SETZM -LINBFL+1(A)
	MOVE A,NLINES
	AOS LINE
NEWLI3:	MOVE B,LINEL(A)
	MOVEM B,LINEL+1(A)
	CAME A,LINE
	SOJA A,NEWLI3
	SETZM LINEL(A)
	AOS NLINES
	JRST FORM
END GO
